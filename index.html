<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medicana - Medication Stock Management (Demo)</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230c2753'/%3E%3Ctext x='50' y='72' font-size='70' font-weight='bold' text-anchor='middle' fill='%2306B6D4' font-family='Arial, sans-serif'%3E%5C%5C%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body class="min-h-screen">
  <div id="root"></div>

    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Barcode Scanner Libraries -->
    <!-- Infrared scanners work as keyboard input, no library needed -->

  <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Inline SVG icon components to replace lucide-react
      const IconBase = ({ children, className = "w-5 h-5", ...rest }) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...rest}>
          {children}
      </svg>
    );
      const Search = (props) => (
        <IconBase {...props}>
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </IconBase>
      );
      const Plus = (props) => (
        <IconBase {...props}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </IconBase>
      );
      const Minus = (props) => (
        <IconBase {...props}>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </IconBase>
      );
      const AlertTriangle = (props) => (
        <IconBase {...props}>
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </IconBase>
      );
      const Download = (props) => (
        <IconBase {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </IconBase>
      );
      const TrendingUp = (props) => (
        <IconBase {...props}>
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </IconBase>
      );
      const BarChart = (props) => (
        <IconBase {...props}>
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </IconBase>
      );
      const Camera = (props) => (
        <IconBase {...props}>
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </IconBase>
      );
      const X = (props) => (
        <IconBase {...props}>
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </IconBase>
      );

    const MEDICATION_TYPES = [
      'Ampule', 'Box Kit', 'Capsule', 'Cream', 'Fluid bag', 'Inhaler', 'Liquid', 
      'Ointment', 'Patch', 'Pre Filled Syringe', 'Suppository', 'Tablet', 'Vial'
    ];

    const CONTAINER_TYPES = [
      'boxes', 'tubes', 'vials', 'bottles', 'packs', 'sachets', 'blisters', 
      'ampules', 'syringes', 'inhalers', 'patches', 'tubes (cream)', 'jars'
    ];

    const LOCATIONS = [
      'Medication Stock L1', 'Cupboard 1', 'Cupboard 2', 'Cupboard 3', 'PACU', 'Theatre 1', 'Theatre 2', 'Theatre 3',
      'Ward 1', 'Ward 2', 'Ward 3', 'Sapphire Clinic', 'Radiology', 'Pharmacy'
    ];

    const REMOVAL_REASONS = [
      'Expired - disposed of as per protocol',
      'Damaged - stock compromised',
      'Recalled by manufacturer',
      'Patient safety concern',
      'Incorrect stock entry - never received',
      'Returned to supplier',
      'Quality control failure',
      'other'
    ];

    const ACTIVITY_FILTERS = [
      { id: 'delivery', label: 'Stock Deliveries', color: 'bg-green-100 text-green-800 border-green-300' },
      { id: 'dispensing', label: 'Ward Dispensing', color: 'bg-cyan-100 text-cyan-800 border-cyan-300' },
      { id: 'transfer', label: 'Internal Transfers', color: 'bg-blue-100 text-blue-800 border-blue-300' },
      { id: 'order', label: 'Orders Placed', color: 'bg-purple-100 text-purple-800 border-purple-300' },
      { id: 'order_fulfilled', label: 'Orders Fulfilled', color: 'bg-emerald-100 text-emerald-800 border-emerald-300' },
      { id: 'removal', label: 'Batch Removals', color: 'bg-red-100 text-red-800 border-red-300' },
      { id: 'system', label: 'System Changes', color: 'bg-gray-100 text-gray-800 border-gray-300' }
    ];

    const formatExpiry = (expiryDate, format = 'short') => {
      const date = new Date(expiryDate + '-01');
      return format === 'short' 
        ? date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })
        : date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    };

    const getTotalQuantity = (med) => med.batches.reduce((sum, batch) => sum + batch.quantity, 0);
    
    // Get total number of boxes across all batches
    const getTotalBoxes = (med) => {
      return med.batches.reduce((sum, batch) => {
        return sum + (batch.numberOfBoxes || 0);
      }, 0);
    };

    const formatStockDisplay = (med) => {
      let totalFullBoxes = 0;
      let totalLooseItems = 0;
      let standardItemsPerBox = med.standardItemsPerBox || null;

      med.batches.forEach(batch => {
        if (batch.itemsPerBox) {
          totalFullBoxes += Math.floor(batch.quantity / batch.itemsPerBox);
          totalLooseItems += batch.quantity % batch.itemsPerBox;
          if (!standardItemsPerBox) standardItemsPerBox = batch.itemsPerBox;
        } else {
          totalLooseItems += batch.quantity;
        }
      });

      // If we have itemsPerBox info, always show the × format
      if (standardItemsPerBox) {
        if (totalFullBoxes === 0 && totalLooseItems === 0) {
          return `0 boxes × ${standardItemsPerBox} ${pluralizeUnit(standardItemsPerBox, med.unit)} per box`;
        }
        if (totalFullBoxes && totalLooseItems) {
          return `${totalFullBoxes} ${totalFullBoxes === 1 ? 'box' : 'boxes'} × ${standardItemsPerBox} items per box + ${totalLooseItems} ${pluralizeUnit(totalLooseItems, med.unit)}`;
        }
        if (totalFullBoxes) {
          return `${totalFullBoxes} ${totalFullBoxes === 1 ? 'box' : 'boxes'} × ${standardItemsPerBox} items per box`;
        }
        // Only loose items
        return `${totalLooseItems} ${pluralizeUnit(totalLooseItems, med.unit)} (from open box)`;
      }

      // Fallback for medications without itemsPerBox
      if (totalFullBoxes === 0 && totalLooseItems === 0) {
        return `0 ${pluralizeUnit(0, med.unit)}`;
      }
      if (totalFullBoxes && totalLooseItems) {
        return `${totalFullBoxes} ${totalFullBoxes === 1 ? 'box' : 'boxes'} and ${totalLooseItems} ${pluralizeUnit(totalLooseItems, med.unit)}`;
      }
      return totalFullBoxes
        ? `${totalFullBoxes} ${totalFullBoxes === 1 ? 'box' : 'boxes'}`
        : `${totalLooseItems} ${pluralizeUnit(totalLooseItems, med.unit)}`;
    };

    const formatBatchDetails = (batch, unit) => {
      if (!batch.itemsPerBox) {
        return `${batch.quantity} ${pluralizeUnit(batch.quantity, unit)}`;
      }

      const fullBoxes = Math.floor(batch.quantity / batch.itemsPerBox);
      const looseItems = batch.quantity % batch.itemsPerBox;

      if (fullBoxes === 0) {
        return `${looseItems} ${pluralizeUnit(looseItems, unit)} (from open box)`;
      } else if (looseItems === 0) {
        return `${fullBoxes} ${fullBoxes === 1 ? 'box' : 'boxes'} × ${batch.itemsPerBox} items per box`;
      } else {
        return `${fullBoxes} ${fullBoxes === 1 ? 'box' : 'boxes'} × ${batch.itemsPerBox} items per box + ${looseItems} ${pluralizeUnit(looseItems, unit)}`;
      }
    };

    const formatMinLevelDisplay = (med) => {
      // minLevelBoxes is already in boxes, so display it directly
      const boxes = med.minLevelBoxes || 0;
      return `${boxes} ${boxes === 1 ? 'box' : 'boxes'}`;
    };

        const getUnitName = (type) => {
          const unitMap = {
            tablet: 'tablets', capsule: 'capsules', liquid: 'bottles',
            vial: 'vials', ampule: 'ampules', 'Pre Filled Syringe': 'syringes',
            inhaler: 'inhalers'
          };
          return unitMap[type] || type;
        };

        const pluralizeUnit = (quantity, unit) => {
          if (quantity === 1) return unit;
          const pluralMap = {
            'tablet': 'tablets',
            'capsule': 'capsules',
            'pre-filled syringe': 'pre-filled syringes',
            'Pre-filled Syringe': 'Pre-filled Syringes',
            'inhaler': 'inhalers',
            'cream': 'creams',
        'vial': 'vials',
        'ampule': 'ampules',
        'bottle': 'bottles'
      };
      return pluralMap[unit] || unit;
    };

    // Get unit label for "individual" display (e.g., "individual ampule", "individual capsule")
    const getIndividualUnitLabel = (unit) => {
      const unitMap = {
        'tablet': 'tablet',
        'capsule': 'capsule',
        'ampule': 'ampule',
        'ampoule': 'ampoule',
        'vial': 'vial',
        'bottle': 'bottle',
        'pre-filled syringe': 'pre-filled syringe',
        'Pre-filled Syringe': 'pre-filled syringe',
        'inhaler': 'inhaler',
        'cream': 'cream',
        'stock': 'unit',
        'units': 'unit'
      };
      const normalizedUnit = (unit || '').toLowerCase();
      return unitMap[normalizedUnit] || normalizedUnit || 'unit';
    };

    const createTransaction = (baseData, nextId) => ({
      id: nextId,
      timestamp: new Date().toISOString(),
      ...baseData
    });

    const categorizeTransaction = (trans, locations) => {
      if (trans.type === 'order') return 'order';
      if (trans.type === 'order_fulfilled') return 'order_fulfilled';
      // Check if this is a fulfilled order (type='in' with note starting with "Order fulfilled")
      if (trans.type === 'in' && trans.note && trans.note.startsWith('Order fulfilled')) return 'order_fulfilled';
      if (trans.type === 'delete') return 'system';
      // Check if this is a batch removal (note starts with "Batch removed")
      if (trans.note && trans.note.startsWith('Batch removed')) return 'removal';
      if (trans.location === 'Batch Removal') return 'removal';
      if (trans.location === 'System') return 'system';
      if (trans.type === 'in' && (trans.location === 'Delivery' || trans.location === 'Stock Delivery')) return 'delivery';
      if (trans.type === 'in' && locations.includes(trans.location)) return 'transfer';
      if (trans.type === 'out' && locations.includes(trans.location)) return 'transfer';
      return trans.type === 'out' ? 'dispensing' : 'system';
    };

    const formatQuantityDisplay = (quantity, itemsPerBox, unit, inputType = 'boxes', inputAmount = null) => {
      if (inputType === 'boxes' && inputAmount && itemsPerBox) {
        return `${inputAmount} ${inputAmount === '1' ? 'box' : 'boxes'} × ${itemsPerBox} items per box`;
      }
      return `${quantity} ${unit}`;
    };

    // Helper function to get location names for filtering based on current selection
    // Returns an array of location names to check against
    const getLocationNamesToCheck = (currentLocationValue, locationsArray) => {
      if (currentLocationValue === 'All') return null; // null means check all

      // Check if this is a group name (exists as a group_name in locations)
      const isGroup = locationsArray.some(loc => loc.groupName === currentLocationValue);

      if (isGroup) {
        // Return all location displayNames in this group
        return locationsArray
          .filter(loc => loc.groupName === currentLocationValue)
          .map(loc => loc.displayName);
      }

      // It's a specific location, return just that one
      return [currentLocationValue];
    };

    // Helper function to check if a medication matches the current location filter
    const matchesLocationFilter = (med, currentLocationValue, locationsArray) => {
      if (currentLocationValue === 'All') return true;

      const locationNames = getLocationNamesToCheck(currentLocationValue, locationsArray);
      return locationNames.includes(med.location);
    };

    // Helper function to check if a value is a group name
    const isGroupName = (value, locationsArray) => {
      return locationsArray.some(loc => loc.groupName === value);
    };

    const validatePassword = async (username, password) => {
      try {
        const res = await fetch('/.netlify/functions/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        return res.ok && data.success;
      } catch (e) {
        console.error('Password verification error:', e);
        return false;
      }
    };

    const getCurrentUserInfo = () => {
      const userStr = sessionStorage.getItem('currentUser');
      if (!userStr) return null;
      try {
        return JSON.parse(userStr);
      } catch (e) {
        return null;
      }
    };

    // Helper functions for role-based access control
    const getUserRole = () => {
      const user = getCurrentUserInfo();
      return user?.role || null;
    };

    const hasAccessTo = (feature) => {
      const role = getUserRole();
      if (!role) return false;

      // Administrator and Pharmacist have full access
      if (role === 'Administrator' || role === 'Pharmacist') {
        return true;
      }

      // Stock Manager: Access to everything except Intelligence Report
      if (role === 'Stock Manager') {
        return feature !== 'intelligenceReport';
      }

      // Stock User: Access to everything except Activity Log, Intelligence Report, and Export Simple Report
      if (role === 'Stock User') {
        return !['activityLog', 'intelligenceReport', 'exportSimpleReport'].includes(feature);
      }

      // Basic User: Only access to transfer stock functionality
      if (role === 'Basic User') {
        return feature === 'transferStock';
      }

      // Default: no access
      return false;
    };

    const canAccessTab = (tabName) => {
      const role = getUserRole();
      if (!role) return false;

      // Administrator and Pharmacist have access to all tabs
      if (role === 'Administrator' || role === 'Pharmacist') {
        return true;
      }

      // Stock Manager: Access to all tabs
      if (role === 'Stock Manager') {
        return true;
      }

      // Stock User: Access to all tabs except Activity Log
      if (role === 'Stock User') {
        return tabName !== 'transactions'; // transactions tab is the Activity Log
      }

      // Basic User: Only access to medications tab (for transferring stock)
      if (role === 'Basic User') {
        return tabName === 'medications';
      }

      return false;
    };

    const findEarliestBatch = (batches) => {
      return batches.reduce((earliest, batch) => 
        new Date(batch.expiryDate + '-01') < new Date(earliest.expiryDate + '-01') ? batch : earliest
      );
    };


    const MedicationStockApp = () => {
      // localStorage helpers
      const storage = {
        load: (key, fallback = null) => {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            return fallback;
          }
        },
        save: (key, value) => {
          try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
        },
        remove: (key) => {
          try { localStorage.removeItem(key); } catch (e) {}
        }
      };
      const [auth, setAuth] = useState({ currentUser: '', password: '', isLoggedIn: false, error: '' });
      const [ui, setUi] = useState({
        searchTerm: '',
        selectedMed: null,
        activeTab: 'medications',
        expandedMedId: null,
        currentLocation: 'Medication Stock L1'
      });

      // Global barcode scanner state
      const [globalBarcodeScanner, setGlobalBarcodeScanner] = useState({
        isActive: true,
        currentInput: '',
        timeoutId: null,
        lastScanTime: 0
      });
      
      // Search input barcode detection state
      const [searchBarcodeDetection, setSearchBarcodeDetection] = useState({
        lastKeyTime: 0,
        inputSpeed: 1000, // Initialize with high value to prevent false triggers
        timeoutId: null
      });
      const [medicationFilters, setMedicationFilters] = useState({
        types: [],
        locations: [],
        statuses: []
      });
      const [modals, setModals] = useState({
        showAdjustStock: false,
        showAddMedication: false,
        showLowStockReport: false,
          showFefoOverride: false,
          showChangePassword: false,
          showIntelligenceReport: false,
          showNewMedicationOrder: false,
          showBarcodeNewMedication: false,
          showLowStockAlert: false,
          showBarcodeStockAdjust: false,
          showFulfilOrder: false
      });
      const [adjustmentForm, setAdjustmentForm] = useState({
        amount: '',
        note: '',
        location: '',
        type: 'boxes',
        action: 'out',
        batchId: '',
        sourceDepartment: '',
        stockInSource: 'transfer',
        transferBatchOption: 'existing',
        deliveryBatchOption: 'new',
        stockOutPurpose: 'transfer',
        patientLastName: '',
        patientLocalId: '',
        useReason: '',
        error: ''
      });
      const [deliveryForm, setDeliveryForm] = useState({
        brand: '',
        expiryMonth: '',
        expiryYear: '',
        quantityType: 'boxes',
        boxQuantity: '',
        itemsPerBox: '',
        individualQuantity: '',
        batchNumber: '',
        batchLocked: false, // Batch integrity safeguard — do not remove. When true, brand/expiry/itemsPerBox are locked
        batchExists: false // Whether the batch code exists in the system
      });
      const [addMedForm, setAddMedForm] = useState({
        mode: 'existing',
        selectedExistingMedId: '',
        searchTerm: '',
        name: '',
        strength: '',
        strengthType: 'value', // 'value' or 'na'
        type: 'tablet',
        barcode: '',
        expiryMonth: '',
        expiryYear: '',
        quantityType: 'boxes',
        boxQuantity: '',
        itemsPerBox: '',
        individualQuantity: '',
        minLevelType: 'boxes',
        minLevel: '',
        minLevelBoxes: '',
        brand: '',
        batchNumber: '',
        batchLocked: false, // Batch integrity safeguard — do not remove. When true, brand/expiry/itemsPerBox are locked
        batchExists: false, // Whether the batch code exists in the system
        error: ''
      });
        const [editMinLevel, setEditMinLevel] = useState({ editing: null, newLevel: '', type: 'boxes', boxes: '', error: '' });
      const [deletion, setDeletion] = useState({ med: null, password: '', error: '' });
        const [batchRemoval, setBatchRemoval] = useState({ batch: null, password: '', reason: '', customReason: '', error: '' });
        const [fefoOverride, setFefoOverride] = useState({ pending: null, password: '', reason: '', error: '' });
      const [orderForm, setOrderForm] = useState({
        med: null,
        quantity: '',
        urgency: 'routine',
        notes: '',
        pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk'
      });

      const [fulfilOrderForm, setFulfilOrderForm] = useState({
        order: null,
        med: null,
        selectedLocationId: '',
        batchOption: 'new', // 'new' or 'existing'
        selectedBatchId: '',
        brand: '',
        batchNumber: '',
        expiryMonth: '',
        expiryYear: '',
        quantityType: 'boxes',
        boxQuantity: '',
        itemsPerBox: '',
        individualQuantity: '',
        error: '',
        isSubmitting: false
      });

      const [newMedicationOrderForm, setNewMedicationOrderForm] = useState({
        name: '',
        type: 'Tablet',
        strength: '',
        quantityNeeded: '',
        bagSize: '',
        urgency: 'routine',
        notes: '',
        pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk',
        error: ''
      });
        const [activityLogFilters, setActivityLogFilters] = useState(['delivery', 'dispensing', 'transfer', 'order', 'order_fulfilled', 'removal', 'system']);
      const [collapsedDates, setCollapsedDates] = useState([]);
        const [changePasswordForm, setChangePasswordForm] = useState({
          currentPassword: '',
          newPassword: '',
          confirmPassword: '',
          error: ''
        });

        const [barcodeNewMedForm, setBarcodeNewMedForm] = useState({
          barcode: '',
          medicationId: null, // Internal medication ID (from barcode lookup)
          name: '',
          strength: '',
          strengthType: 'value', // 'value' or 'na'
          type: 'tablet',
          expiryMonth: '',
          expiryYear: '',
          quantityType: 'boxes', // Only 'boxes' now, no 'individual' option
          boxQuantity: '',
          itemsPerBox: '',
          individualQuantity: '', // Still used for calculating total: (boxes * items_per_box) + individuals
          minLevelType: 'boxes',
          minLevel: '',
          minLevelBoxes: '',
          brand: '',
          batchNumber: '',
          existingBatchId: null, // If user selects an existing batch
          existingBatches: [], // List of existing batches for the medication
          batchLocked: false, // Batch integrity safeguard — do not remove. When true, brand/expiry/itemsPerBox are locked
          batchExists: false, // Whether the batch code exists in the system
          medicationLocked: false, // When true, medication name/strength/type/itemsPerBox are locked (from barcode lookup)
          location: '',
          error: '',
          isSubmitting: false
        });

        // Low Stock Intelligence System - Track stock events and usage patterns
        const [lowStockEvents, setLowStockEvents] = useState([
          // Example structure: { id, medId, medName, timestamp, quantityAtEvent, minLevel, location, duration, resolved, resolvedTimestamp }
        ]);

        // Session timeout management
        const [sessionTimeout, setSessionTimeout] = useState({
          showWarning: false,
          warningCountdown: 30,
          lastActivity: Date.now(),
          warningStartTime: null
        });

        // Use ref to track warning state for event handlers (avoids closure issues)
        const warningShownRef = useRef(false);
        
        // Ref for barcode lookup debouncing
        const barcodeLookupTimeoutRef = useRef(null);

        // Session timeout constants
        const INACTIVITY_TIMEOUT = 150000; // 2.5 minutes in milliseconds
        const WARNING_DURATION = 30000; // 30 seconds in milliseconds

        const [medications, setMedications] = useState([]);

        const [transactions, setTransactions] = useState([]);

        const [locations, setLocations] = useState([]);

        const [orders, setOrders] = useState([]);

        // Load saved state from localStorage on first mount
      useEffect(() => {
          const savedAuth = storage.load('medicana_auth');
          if (savedAuth && typeof savedAuth === 'object') {
            // Always start logged out on fresh load
            setAuth(prev => ({
              ...prev,
              currentUser: savedAuth.currentUser || '',
              isLoggedIn: false,
              password: '',
              error: ''
            }));
          }
          // NO LONGER load medications or transactions from localStorage
          // After login, they will be loaded from Neon database
          const savedUi = storage.load('medicana_ui');
          if (savedUi && typeof savedUi === 'object') {
            setUi(prev => ({
              ...prev,
              currentLocation: savedUi.currentLocation ?? prev.currentLocation,
              activeTab: savedUi.activeTab ?? prev.activeTab,
              searchTerm: savedUi.searchTerm ?? prev.searchTerm
            }));
          }
          const savedFilters = storage.load('medicana_activity_filters');
          if (Array.isArray(savedFilters)) setActivityLogFilters(savedFilters);
          const savedMedFilters = storage.load('medicana_medication_filters');
          if (savedMedFilters && typeof savedMedFilters === 'object') {
            setMedicationFilters({
              types: Array.isArray(savedMedFilters.types) ? savedMedFilters.types : [],
              locations: Array.isArray(savedMedFilters.locations) ? savedMedFilters.locations : [],
              statuses: Array.isArray(savedMedFilters.statuses) ? savedMedFilters.statuses : []
            });
          }
        }, []);

        // Persist key state slices to localStorage
        useEffect(() => { storage.save('medicana_auth', auth); }, [auth]);
        // NO LONGER save medications or transactions to localStorage - Neon is the source of truth
        useEffect(() => {
          storage.save('medicana_ui', {
            currentLocation: ui.currentLocation,
            activeTab: ui.activeTab,
            searchTerm: ui.searchTerm
          });
        }, [ui.currentLocation, ui.activeTab, ui.searchTerm]);
        useEffect(() => { storage.save('medicana_activity_filters', activityLogFilters); }, [activityLogFilters]);
        useEffect(() => { storage.save('medicana_medication_filters', medicationFilters); }, [medicationFilters]);

        // Global barcode scanner - listen for barcode input anywhere in the app
        useEffect(() => {
          if (!auth.isLoggedIn || !globalBarcodeScanner.isActive) return;

          const handleKeyDown = (e) => {
            handleGlobalBarcodeInput(e);
          };

          document.addEventListener('keydown', handleKeyDown);
          
          return () => {
            document.removeEventListener('keydown', handleKeyDown);
            // Clean up any pending timeout
            if (globalBarcodeScanner.timeoutId) {
              clearTimeout(globalBarcodeScanner.timeoutId);
            }
          };
        }, [auth.isLoggedIn, globalBarcodeScanner.isActive, globalBarcodeScanner.timeoutId]);

        // Cleanup search barcode detection timeout on unmount
        useEffect(() => {
          return () => {
            if (searchBarcodeDetection.timeoutId) {
              clearTimeout(searchBarcodeDetection.timeoutId);
            }
          };
        }, [searchBarcodeDetection.timeoutId]);

        // Update ref when warning state changes
        useEffect(() => {
          warningShownRef.current = sessionTimeout.showWarning;
        }, [sessionTimeout.showWarning]);

        // Session timeout functionality - Activity detection
        useEffect(() => {
          if (!auth.isLoggedIn) return;

          let inactivityTimer;

          const resetActivityTimer = () => {
            setSessionTimeout(prev => ({ ...prev, lastActivity: Date.now() }));
            
            // Clear existing timer
            if (inactivityTimer) clearTimeout(inactivityTimer);
            
            // Set new inactivity timer
            inactivityTimer = setTimeout(() => {
              warningShownRef.current = true;
              const now = Date.now();
              setSessionTimeout(prev => ({ 
                ...prev, 
                showWarning: true, 
                warningCountdown: 30,
                warningStartTime: now
              }));
            }, INACTIVITY_TIMEOUT);
          };

          // Attach event listeners for user activity
          const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
          
          const activityHandler = () => {
            // Only reset timer if warning is NOT currently shown
            if (!warningShownRef.current) {
              resetActivityTimer();
            }
          };

          activityEvents.forEach(event => {
            document.addEventListener(event, activityHandler, true);
          });

          // Store reset function globally for "Stay Logged In" button
          window.resetSessionActivity = () => {
            warningShownRef.current = false;
            setSessionTimeout(prev => ({ ...prev, showWarning: false, warningCountdown: 30, warningStartTime: null }));
            resetActivityTimer();
          };
          
          // Initialize timer
          resetActivityTimer();

          // Cleanup function
          return () => {
            activityEvents.forEach(event => {
              document.removeEventListener(event, activityHandler, true);
            });
            if (inactivityTimer) clearTimeout(inactivityTimer);
          };
        }, [auth.isLoggedIn]);

        // Session timeout functionality - Countdown timer (separate effect)
        useEffect(() => {
          if (!sessionTimeout.showWarning || !auth.isLoggedIn || !sessionTimeout.warningStartTime) return;

          let countdownTimer = setInterval(() => {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - sessionTimeout.warningStartTime) / 1000);
            const remainingSeconds = 30 - elapsedSeconds;
            
            if (remainingSeconds <= 0) {
              // Auto logout
              clearInterval(countdownTimer);
              warningShownRef.current = false;
              window.api.stopPolling();
              setAuth({ currentUser: '', password: '', isLoggedIn: false, error: '' });
              setSessionTimeout({ showWarning: false, warningCountdown: 30, lastActivity: Date.now(), warningStartTime: null });
            } else {
              setSessionTimeout(prev => ({ ...prev, warningCountdown: remainingSeconds }));
            }
          }, 1000);

          // Cleanup
          return () => {
            if (countdownTimer) clearInterval(countdownTimer);
          };
        }, [sessionTimeout.showWarning, sessionTimeout.warningStartTime, auth.isLoggedIn]);

        const lowStockMedications = (() => {
          const filtered = medications
            .filter(med => matchesLocationFilter(med, ui.currentLocation, locations))
            .filter(med => {
              // Include medications that are below minimum level OR have zero stock with pending orders
              return getTotalBoxes(med) < med.minLevelBoxes || (getTotalBoxes(med) === 0 && hasPendingOrder(med));
            });
          
          // Group by name when viewing "All Locations"
          if (ui.currentLocation === 'All') {
            const grouped = {};
            filtered.forEach(med => {
              if (!grouped[med.name]) {
                grouped[med.name] = {
                  ...med,
                  locations: [med.location],
                  batches: med.batches.map(b => ({ ...b, location: med.location })),
                  originalMeds: [med]
                };
              } else {
                if (!grouped[med.name].locations.includes(med.location)) {
                  grouped[med.name].locations.push(med.location);
                }
                const batchesWithLocation = med.batches.map(b => ({ ...b, location: med.location }));
                grouped[med.name].batches = [...grouped[med.name].batches, ...batchesWithLocation];
                grouped[med.name].originalMeds.push(med);
              }
            });
            return Object.values(grouped).map(med => ({
              ...med,
              batches: med.batches.sort((a, b) => {
                const dateA = new Date(a.expiryDate + '-01');
                const dateB = new Date(b.expiryDate + '-01');
                return dateA - dateB;
              })
            }));
          }
          return filtered;
        })();

      // LOW STOCK INTELLIGENCE SYSTEM - Monitor and detect low stock events
      useEffect(() => {
        // Check for new low stock events
        lowStockMedications.forEach(med => {
          const existingEvent = lowStockEvents.find(evt => 
            evt.medId === med.id && !evt.resolved
          );
          
          if (!existingEvent) {
            // New low stock event detected
            const newEvent = {
              id: Date.now() + med.id,
              medId: med.id,
              medName: med.name,
              timestamp: new Date().toISOString(),
              quantityAtEvent: getTotalQuantity(med),
              minLevel: med.minLevelBoxes,
              location: med.location,
              resolved: false,
              resolvedTimestamp: null,
              duration: null
            };
            setLowStockEvents(prev => [...prev, newEvent]);
          }
        });

        // Check for resolved low stock events
        lowStockEvents.forEach(evt => {
          if (!evt.resolved) {
            const med = medications.find(m => m.id === evt.medId);
            if (med && getTotalBoxes(med) >= med.minLevelBoxes) {
              // Stock has been replenished
              setLowStockEvents(prev => prev.map(e => 
                e.id === evt.id
                  ? { 
                      ...e, 
                      resolved: true, 
                      resolvedTimestamp: new Date().toISOString(),
                      duration: Math.floor((new Date() - new Date(e.timestamp)) / (1000 * 60 * 60)) // hours
                    }
                  : e
              ));
            }
          }
        });
      }, [medications, lowStockMedications]);

      // Calculate usage patterns and analytics
      const calculateUsageAnalytics = (medId, weekOffset = 0) => {
        const weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - (weekStart.getDay() || 7) + 1 - (weekOffset * 7)); // Monday
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 7);

        const medTransactions = transactions.filter(t => 
          t.medId === medId && 
          new Date(t.timestamp) >= weekStart && 
          new Date(t.timestamp) < weekEnd
        );

        const transfers = medTransactions.filter(t => t.type === 'out' && t.location !== 'Medication Stock L1');
        const deliveries = medTransactions.filter(t => t.type === 'in');
        const dispensing = medTransactions.filter(t => t.type === 'dispensing');
        
        // Calculate by department
        const departmentUsage = {};
        transfers.forEach(t => {
          if (!departmentUsage[t.location]) {
            departmentUsage[t.location] = { transferred: 0, transactions: [] };
          }
          departmentUsage[t.location].transferred += t.amount;
          departmentUsage[t.location].transactions.push(t);
        });

        const totalUsed = transfers.reduce((sum, t) => sum + t.amount, 0) + 
                         dispensing.reduce((sum, t) => sum + t.amount, 0);
        const totalDelivered = deliveries.reduce((sum, t) => sum + t.amount, 0);

        return {
          weekStart,
          weekEnd,
          totalUsed,
          totalDelivered,
          transfers,
          deliveries,
          departmentUsage,
          lowStockOccurrences: lowStockEvents.filter(evt => 
            evt.medId === medId && 
            new Date(evt.timestamp) >= weekStart && 
            new Date(evt.timestamp) < weekEnd
          ).length
        };
      };

      // Generate smart ordering recommendations
      const generateRecommendation = (med) => {
        const currentQty = getTotalQuantity(med);
        const analytics = calculateUsageAnalytics(med.id, 0); // Current week
        const lastWeekAnalytics = calculateUsageAnalytics(med.id, 1); // Last week
        
        // Calculate average weekly usage
        const avgWeeklyUsage = (analytics.totalUsed + lastWeekAnalytics.totalUsed) / 2;
        
        // Calculate how many times it went low
        const lowStockFrequency = lowStockEvents.filter(evt => 
          evt.medId === med.id && 
          new Date(evt.timestamp) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) // Last 30 days
        ).length;

        const currentBoxes = getTotalBoxes(med);
        let recommendation = {
          action: 'maintain',
          reason: 'Stock levels are appropriate for current usage',
          suggestedMinLevel: med.minLevelBoxes,
          suggestedOrderQty: Math.max(0, med.minLevelBoxes - currentBoxes)
        };

        // High turnover - frequently goes low
        if (lowStockFrequency >= 2) {
          const increasePercent = 25;
          recommendation = {
            action: 'increase',
            reason: `Went low ${lowStockFrequency} time${lowStockFrequency > 1 ? 's' : ''} this month. High demand medication.`,
            suggestedMinLevel: Math.ceil(med.minLevelBoxes * (1 + increasePercent / 100)),
            suggestedOrderQty: Math.ceil((med.minLevelBoxes * (1 + increasePercent / 100)) - currentBoxes),
            increasePercent
          };
        }
        // Low usage - never goes low and has high average stock
        else if (lowStockFrequency === 0 && currentBoxes > med.minLevelBoxes * 1.5 && avgWeeklyUsage < med.minLevelBoxes * 0.3) {
          const decreasePercent = 25;
          recommendation = {
            action: 'decrease',
            reason: `Low weekly usage (${Math.round(avgWeeklyUsage)} ${med.unit}/week). Current minimum may be too high.`,
            suggestedMinLevel: Math.max(Math.ceil(avgWeeklyUsage * 2), Math.ceil(med.minLevelBoxes * (1 - decreasePercent / 100))),
            suggestedOrderQty: 0,
            decreasePercent
          };
        }
        // Currently low - order needed
        else if (getTotalBoxes(med) < med.minLevelBoxes) {
          const currentBoxes = getTotalBoxes(med);
          const baseBoxes = med.minLevelBoxes - currentBoxes;
          const batchWithBoxes = med.batches.find(b => b.itemsPerBox);
          const finalQty = batchWithBoxes 
            ? Math.ceil(baseBoxes) * batchWithBoxes.itemsPerBox 
            : baseBoxes;
          
          recommendation = {
            action: 'order',
            reason: `Currently below minimum level (${currentBoxes} / ${med.minLevelBoxes} boxes)`,
            suggestedMinLevel: med.minLevelBoxes,
            suggestedOrderQty: finalQty
          };
        }

        return recommendation;
      };

      // Generate Weekly Intelligence Report
      const generateWeeklyIntelligenceReport = () => {
        const reportData = {
          generated: new Date().toISOString(),
          generatedBy: getCurrentUserInfo()?.fullName || auth.currentUser,
          weekStart: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
          weekEnd: new Date(),
          medications: []
        };

        // Analyze all medications
        medications.forEach(med => {
          const analytics = calculateUsageAnalytics(med.id, 0);
          const recommendation = generateRecommendation(med);
          const currentQty = getTotalQuantity(med);

          // Only include medications with activity or issues
          if (analytics.totalUsed > 0 || analytics.lowStockOccurrences > 0 || getTotalBoxes(med) < med.minLevelBoxes || recommendation.action !== 'maintain') {
            reportData.medications.push({
              ...med,
              currentQty,
              analytics,
              recommendation
            });
          }
        });

        return reportData;
      };

      const filteredTransactions = transactions.filter(trans => {
        // Always show order transactions regardless of location filter
        if (trans.type === 'order') return true;
        if (trans.medId === 0) return trans.type === 'order' && lowStockMedications.length > 0;
        if (ui.currentLocation === 'All') return true;

        // Get location names to check (handles grouped locations)
        const locationNamesToCheck = getLocationNamesToCheck(ui.currentLocation, locations);
        
        // Check if transaction location matches (transaction happened at this location)
        const locationMatches = locationNamesToCheck.includes(trans.location);
        
        // Check if transaction note contains location references
        const note = (trans.note || '').toLowerCase();
        const noteContainsLocation = locationNamesToCheck.some(locName => {
          const locNameLower = locName.toLowerCase();
          // Check for various patterns in the note (case-insensitive)
          return note.includes(`transfer to ${locNameLower}`) ||
                 note.includes(`transfer from ${locNameLower}`) ||
                 note.includes(`dispensed to ${locNameLower}`) ||
                 note.includes(`stock added to ${locNameLower}`) ||
                 note.includes(`stock received from ${locNameLower}`) ||
                 note.includes(`received from ${locNameLower}`) ||
                 (note.includes('delivery received') && locationMatches) ||
                 (note.includes('auto-adjustment') && locationMatches);
        });
        
        // Check if medication is in the selected location (for backward compatibility)
        const medication = medications.find(m => m.id === trans.medId);
        const medicationInLocation = medication && locationNamesToCheck.includes(medication.location);
        
        // Show transaction if it's related to the location in any way:
        // - Transaction happened at this location
        // - Transaction note mentions this location
        // - Medication is stored at this location
        return locationMatches || noteContainsLocation || medicationInLocation;
      });

      const hasPendingOrder = (med) => {
        // Check orders from database (using internalId)
        // Orders are stored with medication_id (internal database ID), not display ID
        const medInternalId = typeof med === 'object' ? med.internalId : null;
        return medInternalId && orders.some(o => o.medId === medInternalId && o.status === 'pending');
      };
        const getMostRecentOrder = (med) => {
          // Get most recent pending order from database
          const medInternalId = typeof med === 'object' ? med.internalId : null;
          if (!medInternalId) return null;
          const pendingOrders = orders.filter(o => o.medId === medInternalId && o.status === 'pending');
          return pendingOrders.length > 0 ? pendingOrders[0] : null;
        };

        // Get dynamic filter options (moved here after functions are defined)
        const availableTypes = [...new Set(medications
          .filter(med => matchesLocationFilter(med, ui.currentLocation, locations))
          .map(med => med.type))].sort();
        
        const availableLocations = [...new Set(medications.map(med => med.location))].sort();
        
        const availableStatuses = (() => {
          const statuses = new Set();
          medications
            .filter(med => matchesLocationFilter(med, ui.currentLocation, locations))
            .forEach(med => {
              const totalBoxes = getTotalBoxes(med);
              if (totalBoxes === 0 && hasPendingOrder(med)) {
                statuses.add('Order Pending');
              } else if (totalBoxes < med.minLevelBoxes) {
                statuses.add('Low Stock');
                if (hasPendingOrder(med)) statuses.add('Ordered');
              } else if (totalBoxes >= med.minLevelBoxes) {
                statuses.add('OK');
                if (hasPendingOrder(med)) statuses.add('Ordered');
              }
            });
          return Array.from(statuses).sort();
        })();

        const filteredMedications = medications
          .filter(med => matchesLocationFilter(med, ui.currentLocation, locations))
          .filter(med => 
            med.name.toLowerCase().includes(ui.searchTerm.toLowerCase()) ||
            (med.barcode && med.barcode.toLowerCase().includes(ui.searchTerm.toLowerCase())) ||
            (med.batches && med.batches.some(batch => batch.batchNumber && batch.batchNumber.toLowerCase().includes(ui.searchTerm.toLowerCase())))
          )
          .filter(med => medicationFilters.types.length === 0 || medicationFilters.types.includes(med.type))
          .filter(med => medicationFilters.locations.length === 0 || medicationFilters.locations.includes(med.location))
          .filter(med => {
            if (medicationFilters.statuses.length === 0) return true;
            const totalBoxes = getTotalBoxes(med);
            const isLowStock = totalBoxes < med.minLevelBoxes && totalBoxes > 0;
            const isOK = totalBoxes >= med.minLevelBoxes;
            const isOrdered = hasPendingOrder(med) && totalBoxes > 0;
            const isOrderPending = totalBoxes === 0 && hasPendingOrder(med);

            return medicationFilters.statuses.some(status => {
              if (status === 'Low Stock' && isLowStock) return true;
              if (status === 'OK' && isOK) return true;
              if (status === 'Ordered' && isOrdered) return true;
              if (status === 'Order Pending' && isOrderPending) return true;
              return false;
            });
          })
          .sort((a, b) => {
            const nameCompare = a.name.localeCompare(b.name);
            return nameCompare !== 0 ? nameCompare : a.location.localeCompare(b.location);
          });

        // Group medications by name when viewing "All Locations"
        const displayMedications = ui.currentLocation === 'All' ? (() => {
          const grouped = {};
          filteredMedications.forEach(med => {
            if (!grouped[med.name]) {
              grouped[med.name] = {
                ...med,
                locations: [med.location],
                batches: med.batches.map(b => ({ ...b, locations: [{ location: med.location, quantity: b.quantity }], totalQuantity: b.quantity })),
                originalMeds: [med]
              };
            } else {
              // Add this location
              if (!grouped[med.name].locations.includes(med.location)) {
                grouped[med.name].locations.push(med.location);
              }
              
              // Merge batches intelligently - group by batch number and expiry date
              med.batches.forEach(newBatch => {
                const existingBatch = grouped[med.name].batches.find(b => 
                  b.expiryDate === newBatch.expiryDate && 
                  b.batchNumber === newBatch.batchNumber &&
                  b.brand === newBatch.brand
                );
                
                if (existingBatch) {
                  // Same batch exists - add this location and combine quantities
                  existingBatch.locations.push({ location: med.location, quantity: newBatch.quantity });
                  existingBatch.totalQuantity += newBatch.quantity;
                } else {
                  // New batch - add it
                  grouped[med.name].batches.push({
                    ...newBatch,
                    locations: [{ location: med.location, quantity: newBatch.quantity }],
                    totalQuantity: newBatch.quantity
                  });
                }
              });
              
              // Keep track of original medications
              grouped[med.name].originalMeds.push(med);
            }
          });
          
          // Sort batches by expiry date and return as array
          return Object.values(grouped).map(med => ({
            ...med,
            batches: med.batches.sort((a, b) => {
              const dateA = new Date(a.expiryDate + '-01');
              const dateB = new Date(b.expiryDate + '-01');
              return dateA - dateB;
            })
          }));
        })() : filteredMedications;

        // Auto-clear filters if no medications match and filters are active
        React.useEffect(() => {
          const hasActiveFilters = medicationFilters.types.length > 0 || 
                                   medicationFilters.locations.length > 0 || 
                                   medicationFilters.statuses.length > 0;
          
          if (hasActiveFilters && filteredMedications.length === 0 && medications.length > 0) {
            const medsInCurrentLocation = medications.filter(med =>
              matchesLocationFilter(med, ui.currentLocation, locations)
            );
            
            if (medsInCurrentLocation.length > 0) {
              setMedicationFilters({ types: [], locations: [], statuses: [] });
            }
          }
        }, [filteredMedications.length, medicationFilters, medications.length, ui.currentLocation]);

        // Auto-open "Add New Medication" modal when barcode is scanned in search and no results found
        React.useEffect(() => {
          // Clear any existing timeout when search term changes
          if (searchBarcodeDetection.timeoutId) {
            clearTimeout(searchBarcodeDetection.timeoutId);
            setSearchBarcodeDetection(prev => ({ ...prev, timeoutId: null }));
          }
          
          // Only trigger if:
          // 1. There's a search term (barcode)
          // 2. It was entered rapidly (indicating barcode scanner)
          // 3. No medications found
          // 4. Search term looks like a barcode (8+ characters)
          if (ui.searchTerm && 
              ui.searchTerm.length >= 8 && 
              searchBarcodeDetection.inputSpeed < 50 && // Very fast typing = barcode scanner
              displayMedications.length === 0 &&
              medications.length > 0) {
            
            // Set a timeout to open the modal (small delay to ensure user sees "no results")
            const timeoutId = setTimeout(() => {
              console.log('Barcode scanned in search with no results, opening add medication modal');
              const currentUser = getCurrentUserInfo();
              let defaultLocation = 'Cupboard 1';
              
              // Use user's primary location if available
              if (currentUser && currentUser.primaryLocation) {
                const userLocation = locations.find(loc => 
                  loc.displayName === currentUser.primaryLocation || loc.id === currentUser.primaryLocation
                );
                if (userLocation) {
                  defaultLocation = userLocation.displayName;
                } else if (ui.currentLocation !== 'All' && !isGroupName(ui.currentLocation, locations)) {
                  defaultLocation = ui.currentLocation;
                }
              } else if (ui.currentLocation !== 'All' && !isGroupName(ui.currentLocation, locations)) {
                defaultLocation = ui.currentLocation;
              }
              
              setModals(prev => ({ ...prev, showBarcodeNewMedication: true }));
              setBarcodeNewMedForm(prev => ({ 
                ...prev, 
                barcode: ui.searchTerm,
                location: defaultLocation,
                strengthType: 'value' // Always default to 'value' for new barcode scans
              }));
              // Trigger barcode lookup when modal opens
              handleBarcodeLookup(ui.searchTerm);
              // Clear search term after opening modal
              setUi(prev => ({ ...prev, searchTerm: '' }));
              // Reset input speed detection
              setSearchBarcodeDetection(prev => ({ ...prev, inputSpeed: 1000, timeoutId: null }));
            }, 500); // 500ms delay
            
            setSearchBarcodeDetection(prev => ({ ...prev, timeoutId }));
          } else if (!ui.searchTerm) {
            // Reset input speed when search is cleared
            setSearchBarcodeDetection(prev => ({ ...prev, inputSpeed: 1000 }));
          }
        }, [ui.searchTerm, displayMedications.length, searchBarcodeDetection.inputSpeed, medications.length, ui.currentLocation]);

        // Auto-trigger barcode lookup when modal opens with a barcode
        React.useEffect(() => {
          if (modals.showBarcodeNewMedication && barcodeNewMedForm.barcode && barcodeNewMedForm.barcode.trim()) {
            const barcode = barcodeNewMedForm.barcode.trim();
            // Only trigger if medication is not already locked (to avoid re-triggering)
            if (!barcodeNewMedForm.medicationLocked) {
              console.log('Modal opened with barcode, triggering lookup:', barcode);
              // Small delay to ensure modal is fully rendered
              const timeoutId = setTimeout(() => {
                handleBarcodeLookup(barcode);
              }, 200);
              return () => clearTimeout(timeoutId);
            }
          }
        }, [modals.showBarcodeNewMedication, barcodeNewMedForm.barcode, barcodeNewMedForm.medicationLocked]);

      // Helper function to get internal location ID from display name
      const getLocationId = (displayName) => {
        if (!displayName) return null;
        const location = locations.find(loc => loc.displayName === displayName);
        return location ? location.id : displayName; // fallback to displayName if not found
      };

      // Batch integrity safeguard — do not remove.
      // Checks if a batch_code exists and auto-fills/locks form fields
      const checkBatchCode = async (batchCode, formType) => {
        if (!batchCode || !batchCode.trim()) {
          // Clear lock state if batch code is empty
          if (formType === 'addMed') {
            setAddMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          } else if (formType === 'delivery') {
            setDeliveryForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          } else if (formType === 'barcode') {
            setBarcodeNewMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          }
          return;
        }

        try {
          const result = await window.api.checkBatch(batchCode.trim());
          
          if (result.exists && result.batch) {
            const batch = result.batch;
            // Parse expiry date
            const expiryDate = batch.expiryDateFull ? new Date(batch.expiryDateFull) : null;
            const expiryMonth = expiryDate ? String(expiryDate.getMonth() + 1).padStart(2, '0') : '';
            const expiryYear = expiryDate ? expiryDate.getFullYear() : '';

            // Auto-fill and lock fields
            if (formType === 'addMed') {
              setAddMedForm(prev => ({
                ...prev,
                brand: batch.brand || '',
                expiryMonth: expiryMonth,
                expiryYear: expiryYear,
                itemsPerBox: batch.itemsPerBox ? String(batch.itemsPerBox) : '',
                batchLocked: true,
                batchExists: true
              }));
            } else if (formType === 'delivery') {
              setDeliveryForm(prev => ({
                ...prev,
                brand: batch.brand || '',
                expiryMonth: expiryMonth,
                expiryYear: expiryYear,
                itemsPerBox: batch.itemsPerBox ? String(batch.itemsPerBox) : '',
                batchLocked: true,
                batchExists: true
              }));
            } else if (formType === 'barcode') {
              setBarcodeNewMedForm(prev => ({
                ...prev,
                brand: batch.brand || '',
                expiryMonth: expiryMonth,
                expiryYear: expiryYear,
                itemsPerBox: batch.itemsPerBox ? String(batch.itemsPerBox) : '',
                batchLocked: true,
                batchExists: true
              }));
            }
          } else {
            // Batch doesn't exist - unlock fields
            if (formType === 'addMed') {
              setAddMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
            } else if (formType === 'delivery') {
              setDeliveryForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
            } else if (formType === 'barcode') {
              setBarcodeNewMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
            }
          }
        } catch (err) {
          console.error('Failed to check batch code:', err);
          // On error, don't lock fields
          if (formType === 'addMed') {
            setAddMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          } else if (formType === 'delivery') {
            setDeliveryForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          } else if (formType === 'barcode') {
            setBarcodeNewMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
          }
        }
      };

      // Barcode lookup handler - called when barcode is entered/scanned
      const handleBarcodeLookup = async (barcode) => {
        console.log('handleBarcodeLookup called with:', barcode);
        if (!barcode || !barcode.trim()) {
          // Clear medication lock state if barcode is empty
          setBarcodeNewMedForm(prev => ({
            ...prev,
            medicationId: null,
            medicationLocked: false,
            existingBatches: [],
            existingBatchId: null,
            name: '',
            strength: '',
            strengthType: 'value',
            type: 'tablet',
            itemsPerBox: ''
          }));
          return;
        }

        try {
          console.log('Calling window.api.lookupByBarcode with:', barcode.trim());
          if (!window.api || !window.api.lookupByBarcode) {
            console.error('window.api.lookupByBarcode is not available');
            throw new Error('Barcode lookup API is not available');
          }
          const result = await window.api.lookupByBarcode(barcode.trim());
          console.log('Barcode lookup result:', result);
          
          if (result.found && result.medication) {
            const med = result.medication;
            // Prefill and lock medication fields
            setBarcodeNewMedForm(prev => ({
              ...prev,
              medicationId: med.id,
              medicationLocked: true,
              name: med.name,
              strength: med.strength_raw || '',
              strengthType: med.strength_raw ? 'value' : 'na',
              type: med.type.toLowerCase() || 'tablet',
              itemsPerBox: med.standard_items_per_box ? String(med.standard_items_per_box) : '',
              existingBatches: result.existingBatches || [],
              existingBatchId: null // Reset batch selection
            }));
          } else {
            // Medication not found - unlock fields for manual entry
            setBarcodeNewMedForm(prev => ({
              ...prev,
              medicationId: null,
              medicationLocked: false,
              existingBatches: [],
              existingBatchId: null
            }));
          }
        } catch (err) {
          console.error('Failed to lookup barcode:', err);
          // On error, allow manual entry
          setBarcodeNewMedForm(prev => ({
            ...prev,
            medicationId: null,
            medicationLocked: false,
            existingBatches: [],
            existingBatchId: null
          }));
        }
      };

      // Reset barcode new medication form to initial state
      const resetBarcodeNewMedForm = () => {
        setBarcodeNewMedForm({
          barcode: '',
          medicationId: null,
          name: '',
          strength: '',
          strengthType: 'value',
          type: 'tablet',
          expiryMonth: '',
          expiryYear: '',
          quantityType: 'boxes',
          boxQuantity: '',
          itemsPerBox: '',
          individualQuantity: '',
          minLevelType: 'boxes',
          minLevel: '',
          minLevelBoxes: '',
          brand: '',
          batchNumber: '',
          existingBatchId: null,
          existingBatches: [],
          batchLocked: false,
          batchExists: false,
          medicationLocked: false,
          location: '',
          error: '',
          isSubmitting: false
        });
      };

      // Handle existing batch selection
      const handleExistingBatchSelect = (batchId) => {
        if (!batchId) {
          setBarcodeNewMedForm(prev => ({
            ...prev,
            existingBatchId: null,
            batchLocked: false,
            batchExists: false,
            batchNumber: '',
            brand: '',
            expiryMonth: '',
            expiryYear: '',
            itemsPerBox: prev.medicationLocked ? prev.itemsPerBox : '' // Keep if medication locked
          }));
          return;
        }

        const selectedBatch = barcodeNewMedForm.existingBatches.find(b => b.id === batchId);
        if (selectedBatch) {
          // Parse expiry date
          const expiryDate = selectedBatch.expiryDate ? new Date(selectedBatch.expiryDate) : null;
          const expiryMonth = expiryDate ? String(expiryDate.getMonth() + 1).padStart(2, '0') : '';
          const expiryYear = expiryDate ? expiryDate.getFullYear() : '';

          setBarcodeNewMedForm(prev => ({
            ...prev,
            existingBatchId: batchId,
            batchLocked: true,
            batchExists: true,
            batchNumber: selectedBatch.batchCode || '',
            brand: selectedBatch.brand || '',
            expiryMonth: expiryMonth,
            expiryYear: expiryYear,
            itemsPerBox: selectedBatch.itemsPerBox ? String(selectedBatch.itemsPerBox) : prev.itemsPerBox
          }));
        }
      };

      const handleLogin = async () => {
        if (!auth.currentUser.trim() || !auth.password.trim()) {
          setAuth(prev => ({ ...prev, error: 'Please enter both username and password' }));
          return;
        }

        try {
          const res = await fetch('/.netlify/functions/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: auth.currentUser, password: auth.password })
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            setAuth(prev => ({ ...prev, error: data.message || 'Login failed.', password: '' }));
            return;
          }

          // Store user info in sessionStorage
          sessionStorage.setItem('currentUser', JSON.stringify(data.user));
          
          // Load medications, transactions, and locations from backend BEFORE setting isLoggedIn
          // This prevents the flash of empty/old data
          try {
            const backendData = await window.api.fetchAllData();
            setMedications(backendData.medications || []);
            setTransactions(backendData.transactions || []);
            setLocations(backendData.locations || []);
            
            // Determine default location based on user role and primary location
            let defaultLocation = 'All';
            const userRole = data.user.role;
            const userPrimaryLocation = data.user.primaryLocation;
            
            // Management and Pharmacist roles default to "All Locations"
            // All other roles default to their primary location if available
            if (userRole !== 'Management' && userRole !== 'Pharmacist' && userPrimaryLocation) {
              // Check if the primary location exists in the locations list
              const locationExists = backendData.locations.some(loc => 
                loc.displayName === userPrimaryLocation || loc.id === userPrimaryLocation
              );
              if (locationExists) {
                defaultLocation = userPrimaryLocation;
              }
            }
            
            // Determine default tab based on user role
            // Helper function to check tab access (defined inline for this scope)
            const canAccessTabLocal = (tabName) => {
              if (userRole === 'Administrator' || userRole === 'Pharmacist') return true;
              if (userRole === 'Stock Manager') return true;
              if (userRole === 'Stock User') return tabName !== 'transactions';
              if (userRole === 'Basic User') return tabName === 'medications';
              return false;
            };
            
            let defaultTab = 'medications';
            if (!canAccessTabLocal(defaultTab)) {
              // Find first accessible tab
              const allTabs = ['medications', 'transactions', 'lowstock', 'newmedication'];
              const accessibleTab = allTabs.find(tab => canAccessTabLocal(tab));
              if (accessibleTab) defaultTab = accessibleTab;
            }
            
            // NOW set logged in - UI will render with real Neon data already loaded
            setAuth(prev => ({ ...prev, isLoggedIn: true, error: '' }));
            
            // Reset UI to default state on login
            setUi(prev => ({
              ...prev,
              activeTab: defaultTab,
              currentLocation: defaultLocation,
              searchTerm: '',
              selectedMed: null,
              expandedMedId: null
            }));
            
            // Start polling to keep data in sync
            window.api.startPolling({
              onData: ({ medications: meds, transactions: txs, locations: locs, orders: ords }) => {
                setMedications(meds || []);
                setTransactions(txs || []);
                setLocations(locs || []);
                setOrders(ords || []);
              },
              intervalMs: 20000
            });
            
            // Show low stock alert for pharmacist (Aasit) if there are low stock medications
            if (auth.currentUser === 'ABadiani' && data.user.role === 'Pharmacist') {
              // Use setTimeout to ensure the component has rendered and lowStockMedications is calculated
              setTimeout(() => {
                const currentLowStock = backendData.medications.filter(med => getTotalBoxes(med) < med.minLevelBoxes);
                if (currentLowStock.length > 0) {
                  setModals(prev => ({ ...prev, showLowStockAlert: true }));
                }
              }, 500);
            }
          } catch (err) {
            console.error('Failed to load initial data:', err);
            setAuth(prev => ({ ...prev, error: 'Failed to load data from server.' }));
            return;
          }
        } catch (e) {
          setAuth(prev => ({ ...prev, error: 'Network or server error.', password: '' }));
        }
      };
      const handleLogout = () => {
        window.api.stopPolling();
        setAuth({ currentUser: '', password: '', isLoggedIn: false, error: '' });
          storage.remove('medicana_auth');
          sessionStorage.removeItem('currentUser');
        };
        const handleKeyPress = (e) => { if (e.key === 'Enter') handleLogin(); };


        const handleBarcodeScanned = (barcode) => {
            console.log('Scanned barcode:', barcode);
          console.log('Available medications:', medications.map(med => ({ id: med.id, name: med.name, barcode: med.barcode })));
          
          // Clean the barcode (remove any whitespace or special characters)
          const cleanBarcode = barcode.trim().replace(/\s+/g, '');
          console.log('Cleaned barcode:', cleanBarcode);
          
          // Try to find medication by barcode (exact match first)
          let foundMedication = medications.find(med => med.barcode === cleanBarcode);
          console.log('Found medication:', foundMedication);
          
          // Debug: If no medication found, show all barcodes in console
          if (!foundMedication) {
            console.log('Available barcodes:', medications.map(med => `${med.name}: ${med.barcode}`).filter(info => info.includes(': ')));
          }
          
          // If not found by exact barcode, try other methods
          if (!foundMedication) {
            foundMedication = medications.find(med => 
              med.name.toLowerCase().includes(cleanBarcode.toLowerCase()) ||
              med.id.toString() === cleanBarcode
            );
          }
          
          if (foundMedication) {
            setUi(prev => ({ 
              ...prev, 
              selectedMed: foundMedication,
              searchTerm: foundMedication.name
            }));
            
            // Default quantity type to boxes
            const defaultQuantityType = 'boxes';
            
            // Open the barcode stock adjustment modal
            setModals(prev => ({ ...prev, showBarcodeStockAdjust: true }));
            setAdjustmentForm({ amount: '', note: '', location: '', type: defaultQuantityType, action: 'out', batchId: '', sourceDepartment: '', stockInSource: 'delivery', transferBatchOption: 'existing', deliveryBatchOption: 'new', stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' });
            setDeliveryForm({ brand: '', expiryMonth: '', expiryYear: '', quantityType: defaultQuantityType, boxQuantity: '', itemsPerBox: '', individualQuantity: '', batchNumber: '' });
            
            // Scroll to the medication in the list
            setTimeout(() => {
              const medElement = document.querySelector(`[data-med-id="${foundMedication.id}"]`);
              if (medElement) {
                medElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }, 100);
            
          } else {
            // Show new medication modal for unrecognized barcode
            const defaultLocation = (ui.currentLocation !== 'All' && !isGroupName(ui.currentLocation, locations)) ? ui.currentLocation : 'Cupboard 1';
            setModals(prev => ({ ...prev, showBarcodeNewMedication: true }));
            setBarcodeNewMedForm(prev => ({ 
              ...prev, 
              barcode: cleanBarcode,
              location: defaultLocation,
              strengthType: 'value' // Always default to 'value' for new barcode scans
            }));
            // The useEffect hook will automatically trigger the lookup when the modal opens with a barcode
          }
        };

        // Global barcode scanner handler - works from anywhere in the app
        const handleGlobalBarcodeInput = (e) => {
          // Only process if global scanner is active
          if (!globalBarcodeScanner.isActive) {
            return;
          }

          const char = e.key;
          const now = Date.now();
          
          // If we're in the middle of a rapid scan, prevent default on ALL elements (including SELECT)
          // This ensures barcode scanning always takes priority over any selected element
          if (globalBarcodeScanner.currentInput.length > 0 && now - globalBarcodeScanner.lastScanTime < 100) {
            e.preventDefault();
            e.stopPropagation();
            // Blur any active element to prevent it from interfering
            if (document.activeElement && document.activeElement !== document.body) {
              document.activeElement.blur();
            }
          }

          // Allow normal typing in text input form elements only (not buttons, not SELECT)
          if (e.target.tagName === 'INPUT' || 
              e.target.tagName === 'TEXTAREA' || 
              e.target.contentEditable === 'true') {
            // But still allow barcode scanning in search inputs
            if (e.target.id !== 'medication-search-input' && e.target.id !== 'add-medication-search-input') {
              // Only return if we're not in the middle of a scan
              if (globalBarcodeScanner.currentInput.length === 0 || now - globalBarcodeScanner.lastScanTime >= 100) {
                return;
              }
            }
          }
          
          // Always prevent SELECT elements from intercepting barcode scans
          if (e.target.tagName === 'SELECT') {
            e.preventDefault();
            e.stopPropagation();
            if (document.activeElement === e.target) {
              e.target.blur();
            }
          }
          
          // Prevent buttons from being triggered when global scanner is active
          // Barcode scanners send input very rapidly, so prevent default on buttons
          if (e.target.tagName === 'BUTTON') {
            e.preventDefault();
            e.stopPropagation();
          }
          
          // Clear existing timeout
          if (globalBarcodeScanner.timeoutId) {
            clearTimeout(globalBarcodeScanner.timeoutId);
          }

          // If it's been more than 100ms since last input, start fresh
          if (now - globalBarcodeScanner.lastScanTime > 100) {
            setGlobalBarcodeScanner(prev => ({
              ...prev,
              currentInput: char,
              lastScanTime: now
            }));
          } else {
            // Continue building the barcode
            setGlobalBarcodeScanner(prev => ({
              ...prev,
              currentInput: prev.currentInput + char,
              lastScanTime: now
            }));
          }

          // Set timeout to detect end of barcode scan (typically 50-100ms after last character)
          const timeoutId = setTimeout(() => {
            const currentInput = globalBarcodeScanner.currentInput;
            if (currentInput.length >= 8) { // Minimum barcode length
              console.log('Global barcode detected:', currentInput);
              handleBarcodeScanned(currentInput);
            }
            setGlobalBarcodeScanner(prev => ({
              ...prev,
              currentInput: '',
              timeoutId: null
            }));
          }, 150);

          setGlobalBarcodeScanner(prev => ({
            ...prev,
            timeoutId
          }));
        };

        const handleChangePassword = async () => {
          if (!changePasswordForm.currentPassword.trim() || !changePasswordForm.newPassword.trim() || !changePasswordForm.confirmPassword.trim()) {
            setChangePasswordForm(prev => ({ ...prev, error: 'Please fill in all fields' }));
            return;
          }
          if (!(await validatePassword(auth.currentUser, changePasswordForm.currentPassword))) {
            setChangePasswordForm(prev => ({ ...prev, error: 'Current password is incorrect', currentPassword: '' }));
            return;
          }
          if (changePasswordForm.newPassword !== changePasswordForm.confirmPassword) {
            setChangePasswordForm(prev => ({ ...prev, error: 'New passwords do not match', confirmPassword: '' }));
            return;
          }
          if (changePasswordForm.newPassword.length < 8) {
            setChangePasswordForm(prev => ({ ...prev, error: 'New password must be at least 8 characters long' }));
            return;
          }
          // TODO: Update password via backend API (not implemented yet)
          // For now, this is a demo-only feature
          
          // Send password change confirmation email
          const userInfo = getCurrentUserInfo();
          if (!userInfo) {
            setChangePasswordForm(prev => ({ ...prev, error: 'User session not found. Please log in again.' }));
            return;
          }
          const emailSubject = 'Password Change Confirmation - Medicana Stock Management';
          const emailBody = `Dear ${userInfo.firstName},

This is an automated email to confirm that the password for your account has been successfully changed.

If you made this change, no further action is required.
If you did not request this change, please reset your password immediately or contact our support team for assistance.

Kind regards,
Medicana Stock Management System`;
          
          const mailtoLink = `mailto:${userInfo.email}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
          window.location.href = mailtoLink;
          
          setChangePasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '', error: '' });
          setModals(prev => ({ ...prev, showChangePassword: false }));
        };

      const handleAddNewMedication = async () => {
        if (ui.currentLocation === 'All' || isGroupName(ui.currentLocation, locations)) {
          setAddMedForm(prev => ({ ...prev, error: 'Please select a specific location before adding stock' }));
          return;
        }
        if (addMedForm.mode === 'existing' && !addMedForm.selectedExistingMedId) {
          setAddMedForm(prev => ({ ...prev, error: 'Please select an existing medication' }));
          return;
        }
        if (addMedForm.mode === 'new') {
          if (!addMedForm.name.trim()) {
            setAddMedForm(prev => ({ ...prev, error: 'Please enter medication name' }));
            return;
          }
          if (addMedForm.strengthType === 'value' && !addMedForm.strength.trim()) {
            setAddMedForm(prev => ({ ...prev, error: 'Please enter medication strength or select N/A' }));
            return;
          }
        }
        if (!addMedForm.expiryMonth || !addMedForm.expiryYear || !addMedForm.brand.trim()) {
          setAddMedForm(prev => ({ ...prev, error: 'Please enter expiry date and brand' }));
          return;
        }
        
        let totalQuantity = 0;
        let itemsPerBox = 0;
        if (addMedForm.quantityType === 'boxes') {
          if (!addMedForm.boxQuantity || !addMedForm.itemsPerBox || 
              parseInt(addMedForm.boxQuantity) <= 0 || parseInt(addMedForm.itemsPerBox) <= 0) {
            setAddMedForm(prev => ({ ...prev, error: 'Please enter valid box quantity and items per box' }));
            return;
          }
          totalQuantity = parseInt(addMedForm.boxQuantity) * parseInt(addMedForm.itemsPerBox);
          itemsPerBox = parseInt(addMedForm.itemsPerBox);
        } else {
          if (!addMedForm.individualQuantity || parseInt(addMedForm.individualQuantity) <= 0) {
            setAddMedForm(prev => ({ ...prev, error: 'Please enter valid quantity' }));
            return;
          }
          totalQuantity = parseInt(addMedForm.individualQuantity);
          if (addMedForm.itemsPerBox && parseInt(addMedForm.itemsPerBox) > 0) {
            itemsPerBox = parseInt(addMedForm.itemsPerBox);
          }
        }

        try {
          const currentUser = getCurrentUserInfo();
          if (!currentUser || !currentUser.id) {
            setAddMedForm(prev => ({ ...prev, error: 'User not logged in' }));
            return;
          }

          let medicationId;
          let medicationName;

          if (addMedForm.mode === 'existing') {
            const referenceMed = medications.find(med => med.id === parseInt(addMedForm.selectedExistingMedId));
            if (!referenceMed) {
              setAddMedForm(prev => ({ ...prev, error: 'Selected medication not found' }));
              return;
            }
            medicationId = referenceMed.id;
            medicationName = referenceMed.name;
          } else {
            // New medication - generate ID and create it
            medicationId = String(Math.max(...medications.map(m => parseInt(m.id) || 0), 0) + 1);
            medicationName = addMedForm.strengthType === 'na' ? addMedForm.name : `${addMedForm.name} ${addMedForm.strength}`;
            
            // minLevel is now in boxes, pass it directly
            // Parse the value - treat empty string, null, or undefined as 0
            let minLevel = 0;
            if (addMedForm.minLevelBoxes !== undefined && addMedForm.minLevelBoxes !== null && addMedForm.minLevelBoxes !== '') {
              const parsed = parseInt(addMedForm.minLevelBoxes);
              minLevel = Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
            }
            
            console.log('Adding medication with minLevel:', minLevel, 'from input:', addMedForm.minLevelBoxes);
            
            await window.api.addMedication({
              id: medicationId,
              name: addMedForm.name,
              strength: addMedForm.strengthType === 'na' ? 'N/A' : addMedForm.strength,
              type: addMedForm.type,
              barcode: addMedForm.barcode || '',
              minLevel,
              standardItemsPerBox: itemsPerBox || null
            });
          }

          // Add batch/stock
          const note = addMedForm.quantityType === 'boxes' 
            ? `Stock added to ${ui.currentLocation} - Brand: ${addMedForm.brand} - ${addMedForm.boxQuantity} boxes (${itemsPerBox} per box)`
            : `Stock added to ${ui.currentLocation} - Brand: ${addMedForm.brand} - ${addMedForm.individualQuantity} items`;

          await window.api.addBatch({
            medicationId,
            batchNumber: addMedForm.batchNumber || `BATCH-${Date.now()}`,
            expiryMonth: parseInt(addMedForm.expiryMonth),
            expiryYear: parseInt(addMedForm.expiryYear),
            brand: addMedForm.brand,
            itemsPerBox: itemsPerBox || null,
            quantityBoxes: addMedForm.quantityType === 'boxes' ? parseInt(addMedForm.boxQuantity) : 0,
            quantityIndividuals: addMedForm.quantityType === 'individuals' ? parseInt(addMedForm.individualQuantity) : 0,
            locationId: getLocationId(ui.currentLocation) || ui.currentLocation,
            userId: currentUser.id,
            note
          });

          // Refresh data from backend (small delay to ensure DB commit)
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          setTransactions(data.transactions || []);
          setLocations(data.locations || []);

          setAddMedForm({
            mode: 'existing', selectedExistingMedId: '', searchTerm: '', name: '', strength: '', strengthType: 'value', type: 'tablet', expiryMonth: '', expiryYear: '',
            quantityType: 'boxes', boxQuantity: '', itemsPerBox: '', individualQuantity: '', minLevelType: 'boxes', minLevel: '', minLevelBoxes: '', brand: '', batchNumber: '', batchLocked: false, batchExists: false, error: ''
          });
          setModals(prev => ({ ...prev, showAddMedication: false }));
        } catch (err) {
          console.error('Failed to add medication/batch:', err);
          setAddMedForm(prev => ({ ...prev, error: err.message || 'Failed to add medication' }));
        }
      };

      const handleBarcodeNewMedication = async () => {
        // Prevent multiple submissions
        if (barcodeNewMedForm.isSubmitting) {
          return;
        }

        // Validate required fields
        if (!barcodeNewMedForm.name.trim()) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter medication name' }));
          return;
        }
        if (barcodeNewMedForm.strengthType === 'value' && !barcodeNewMedForm.strength.trim()) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter medication strength or select N/A' }));
          return;
        }
        if (!barcodeNewMedForm.expiryMonth || !barcodeNewMedForm.expiryYear || !barcodeNewMedForm.brand.trim()) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter expiry date and brand' }));
          return;
        }
        if (!barcodeNewMedForm.location.trim()) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please select a location' }));
          return;
        }

        // Validate quantity fields - check for empty strings and parse
        const boxQuantityStr = String(barcodeNewMedForm.boxQuantity || '').trim();
        const itemsPerBoxStr = String(barcodeNewMedForm.itemsPerBox || '').trim();
        
        if (!boxQuantityStr || boxQuantityStr === '0' || boxQuantityStr === '') {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter a valid number of boxes (greater than 0)' }));
          return;
        }
        
        if (!itemsPerBoxStr || itemsPerBoxStr === '0' || itemsPerBoxStr === '') {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter a valid items per box (greater than 0)' }));
          return;
        }
        
        const boxQuantity = parseInt(boxQuantityStr, 10);
        const itemsPerBox = parseInt(itemsPerBoxStr, 10);
        
        if (isNaN(boxQuantity) || boxQuantity <= 0) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter a valid number of boxes (greater than 0)' }));
          return;
        }
        
        if (isNaN(itemsPerBox) || itemsPerBox <= 0) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter a valid items per box (greater than 0)' }));
          return;
        }

        // Calculate total quantity: boxes * items_per_box
        const totalQuantity = boxQuantity * itemsPerBox;

        if (isNaN(totalQuantity) || totalQuantity <= 0) {
          setBarcodeNewMedForm(prev => ({ ...prev, error: 'Please enter valid box quantity and items per box' }));
          return;
        }
        
        console.log('Submitting with:', { boxQuantity, itemsPerBox, totalQuantity });

        // Set submitting state
        setBarcodeNewMedForm(prev => ({ ...prev, isSubmitting: true, error: '' }));

        // minLevel is now in boxes, pass it directly
        // Ensure it's a numeric value (allow 0 as valid)
        let minLevel = 0;
        if (barcodeNewMedForm.minLevelBoxes !== undefined && barcodeNewMedForm.minLevelBoxes !== null && barcodeNewMedForm.minLevelBoxes !== '') {
          const parsed = parseInt(barcodeNewMedForm.minLevelBoxes);
          minLevel = Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
        }

        try {
          const currentUser = getCurrentUserInfo();
          if (!currentUser || !currentUser.id) {
            setBarcodeNewMedForm(prev => ({ ...prev, isSubmitting: false, error: 'User not logged in' }));
            return;
          }

          let medicationId = null;

          // Prepare medicationUpsert payload with minLevel
          const upsertPayload = {
            name: barcodeNewMedForm.name,
            strength: barcodeNewMedForm.strengthType === 'na' ? 'N/A' : barcodeNewMedForm.strength,
            form: barcodeNewMedForm.type,
            barcode: barcodeNewMedForm.barcode,
            standardItemsPerBox: itemsPerBox || null,
            minLevel: minLevel || 0
          };

          // If lookup found a medication, still call medicationUpsert to update minLevel safely
          if (barcodeNewMedForm.medicationId) {
            medicationId = barcodeNewMedForm.medicationId;
            // Update minLevel via medicationUpsert (it will update if medication exists)
            await window.api.medicationUpsert(upsertPayload);
          } else {
            // Call medicationUpsert to find or create medication
            const upsertResult = await window.api.medicationUpsert(upsertPayload);
            medicationId = upsertResult.medicationId;
          }

          // Prepare batch add payload
          const chosenLocationId = getLocationId(barcodeNewMedForm.location) || barcodeNewMedForm.location;
          
          // If existing batch is selected, use it
          if (barcodeNewMedForm.existingBatchId) {
            await window.api.addBatch({
              userId: currentUser.id,
              locationId: chosenLocationId,
              medicationId: medicationId,
              existingBatchId: barcodeNewMedForm.existingBatchId,
              itemsPerBox: itemsPerBox, // Required for backend to calculate total quantity
              quantityBoxes: boxQuantity,
              quantityIndividuals: 0,
              reason: 'Delivery (existing batch)'
            });
          } else {
            // Create new batch
            await window.api.addBatch({
              userId: currentUser.id,
              locationId: chosenLocationId,
              medicationId: medicationId,
              batchCode: barcodeNewMedForm.batchNumber || `BATCH-${Date.now()}`,
              expiryMonth: parseInt(barcodeNewMedForm.expiryMonth),
              expiryYear: parseInt(barcodeNewMedForm.expiryYear),
              brand: barcodeNewMedForm.brand,
              itemsPerBox: itemsPerBox,
              quantityBoxes: boxQuantity,
              quantityIndividuals: 0,
              reason: 'Delivery'
            });
          }

          // Refresh data from backend (small delay to ensure DB commit)
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          setTransactions(data.transactions || []);
          setLocations(data.locations || []);

          // Reset form and close modal
          setBarcodeNewMedForm({
            barcode: '',
            medicationId: null,
            name: '',
            strength: '',
            strengthType: 'value',
            type: 'tablet',
            expiryMonth: '',
            expiryYear: '',
            quantityType: 'boxes',
            boxQuantity: '',
            itemsPerBox: '',
            individualQuantity: '',
            minLevelType: 'boxes',
            minLevel: '',
            minLevelBoxes: '',
            brand: '',
            batchNumber: '',
            existingBatchId: null,
            existingBatches: [],
            batchLocked: false,
            batchExists: false,
            medicationLocked: false,
            location: '',
            error: '',
            isSubmitting: false
          });
          setModals(prev => ({ ...prev, showBarcodeNewMedication: false }));
        } catch (err) {
          console.error('Failed to add medication/batch via barcode:', err);
          setBarcodeNewMedForm(prev => ({ ...prev, error: err.message || 'Failed to add medication', isSubmitting: false }));
        }
      };

      const handleStockAdjustment = (type) => {
        setAdjustmentForm(prev => ({ ...prev, error: '' }));
          if (type === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new'))) {
          processAdjustment(null);
          return;
        }
        if (!ui.selectedMed || !adjustmentForm.amount || parseInt(adjustmentForm.amount) <= 0) return;
        if (!adjustmentForm.batchId) {
          setAdjustmentForm(prev => ({ ...prev, error: 'Please select a batch' }));
          return;
        }
        if (type === 'out' && !adjustmentForm.location) {
          setAdjustmentForm(prev => ({ ...prev, error: 'Please select a location for stock removal' }));
          return;
        }
        if (type === 'in' && adjustmentForm.stockInSource === 'transfer' && !adjustmentForm.sourceDepartment) {
          setAdjustmentForm(prev => ({ ...prev, error: 'Please select which department the stock is coming from' }));
          return;
        }
        if (type === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing') {
            const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
          if (!sourceMed) {
            setAdjustmentForm(prev => ({ ...prev, error: `${ui.selectedMed.name} does not exist in ${adjustmentForm.sourceDepartment}. Please select "New Batch" or choose a different source department.` }));
            return;
          }
          const sourceBatch = sourceMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
          if (!sourceBatch) {
            setAdjustmentForm(prev => ({ ...prev, error: 'Selected batch not found in source department' }));
            return;
          }
        } else if (type === 'out' || (type === 'in' && adjustmentForm.stockInSource === 'delivery')) {
          const selectedBatch = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
          if (!selectedBatch) {
            setAdjustmentForm(prev => ({ ...prev, error: 'Selected batch not found' }));
            return;
          }
        }
        if (type === 'out' && ui.selectedMed.batches.length > 1) {
          const selectedBatch = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
          const earliestBatch = findEarliestBatch(ui.selectedMed.batches);
          if (selectedBatch.id !== earliestBatch.id) {
            setFefoOverride({
              pending: {
                type,
                selectedBatch,
                earliestBatch,
                selectedExpiry: formatExpiry(selectedBatch.expiryDate, 'long'),
                earliestExpiry: formatExpiry(earliestBatch.expiryDate, 'long')
              },
                password: '', reason: '', error: ''
            });
            setModals(prev => ({ ...prev, showFefoOverride: true }));
            return;
          }
        }
        processAdjustment(null);
      };

      const handleFefoOverride = async () => {
          if (!fefoOverride.password.trim()) { setFefoOverride(prev => ({ ...prev, error: 'Please enter your password' })); return; }
          if (!(await validatePassword(auth.currentUser, fefoOverride.password))) { setFefoOverride(prev => ({ ...prev, error: 'Incorrect password. Please try again.', password: '' })); return; }
          if (!fefoOverride.reason.trim()) { setFefoOverride(prev => ({ ...prev, error: 'Please provide a reason for overriding FEFO' })); return; }
        processAdjustment(fefoOverride.reason);
        setModals(prev => ({ ...prev, showFefoOverride: false }));
        setFefoOverride({ pending: null, password: '', reason: '', error: '' });
      };

      const processAdjustment = async (overrideReason) => {
        const type = adjustmentForm.action;
          if (type === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new'))) {
            if (!deliveryForm.brand.trim() || !deliveryForm.expiryMonth || !deliveryForm.expiryYear) { setAdjustmentForm(prev => ({ ...prev, error: 'Please enter brand name and expiry date' })); return; }
            if (adjustmentForm.stockInSource === 'transfer' && !adjustmentForm.sourceDepartment) { setAdjustmentForm(prev => ({ ...prev, error: 'Please select source department' })); return; }
            
            let totalQuantity = 0; let itemsPerBox = null;
          if (deliveryForm.quantityType === 'boxes') {
              if (!deliveryForm.boxQuantity || !deliveryForm.itemsPerBox || parseInt(deliveryForm.boxQuantity) <= 0 || parseInt(deliveryForm.itemsPerBox) <= 0) { setAdjustmentForm(prev => ({ ...prev, error: 'Please enter valid box quantity and items per box' })); return; }
            totalQuantity = parseInt(deliveryForm.boxQuantity) * parseInt(deliveryForm.itemsPerBox);
            itemsPerBox = parseInt(deliveryForm.itemsPerBox);
          } else {
              if (!deliveryForm.individualQuantity || parseInt(deliveryForm.individualQuantity) <= 0) { setAdjustmentForm(prev => ({ ...prev, error: 'Please enter valid quantity' })); return; }
            totalQuantity = parseInt(deliveryForm.individualQuantity);
          }

          try {
            const currentUser = getCurrentUserInfo();
            if (!currentUser || !currentUser.id) {
              setAdjustmentForm(prev => ({ ...prev, error: 'User not logged in' }));
              return;
            }

            const displayAmount = formatQuantityDisplay(totalQuantity, itemsPerBox, ui.selectedMed.unit, deliveryForm.quantityType, deliveryForm.quantityType === 'boxes' ? deliveryForm.boxQuantity : null);
            const sourceLocation = adjustmentForm.stockInSource === 'delivery' ? 'Delivery' : adjustmentForm.sourceDepartment;
            const notePrefix = adjustmentForm.stockInSource === 'delivery' ? 'Delivery received' : `Stock received from ${adjustmentForm.sourceDepartment}`;
            const deliveryNote = `${notePrefix} - Brand: ${deliveryForm.brand} - ${displayAmount}`;

            await window.api.addBatch({
              medicationId: ui.selectedMed.id,
              batchNumber: deliveryForm.batchNumber || `BATCH-${Date.now()}`,
              expiryMonth: parseInt(deliveryForm.expiryMonth),
              expiryYear: parseInt(deliveryForm.expiryYear),
              brand: deliveryForm.brand,
              itemsPerBox: itemsPerBox || null,
              quantityBoxes: deliveryForm.quantityType === 'boxes' ? parseInt(deliveryForm.boxQuantity) : 0,
              quantityIndividuals: deliveryForm.quantityType === 'individuals' ? parseInt(deliveryForm.individualQuantity) : 0,
              locationId: ui.selectedMed.locationId || getLocationId(ui.selectedMed.location),
              userId: currentUser.id,
              note: deliveryNote
            });

            // Refresh data from backend (small delay to ensure DB commit)
            await new Promise(resolve => setTimeout(resolve, 100));
            const data = await window.api.fetchAllData();
            setMedications(data.medications || []);
            setTransactions(data.transactions || []);

            resetAdjustmentForms();
            return;
          } catch (err) {
            console.error('Failed to add delivery:', err);
            setAdjustmentForm(prev => ({ ...prev, error: err.message || 'Failed to add delivery' }));
            return;
          }
        }
        const selectedBatch = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
        let amount = parseInt(adjustmentForm.amount);
          if (adjustmentForm.type === 'boxes' && selectedBatch.itemsPerBox) { amount = amount * selectedBatch.itemsPerBox; }
        const updatedMed = { ...ui.selectedMed };
          if (type === 'out') { await processStockOut(updatedMed, selectedBatch, amount, overrideReason); } else { await processStockIn(updatedMed, selectedBatch, amount, overrideReason); }
        resetAdjustmentForms();
      };

      const resetAdjustmentForms = () => {
        setUi(prev => ({ ...prev, selectedMed: null }));
        setModals(prev => ({ ...prev, showAdjustStock: false, showBarcodeStockAdjust: false }));
          setAdjustmentForm({ amount: '', note: '', location: '', type: 'boxes', action: 'out', batchId: '', sourceDepartment: '', stockInSource: 'transfer', transferBatchOption: 'existing', deliveryBatchOption: 'new', stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' });
          setDeliveryForm({ brand: '', expiryMonth: '', expiryYear: '', quantityType: 'boxes', boxQuantity: '', itemsPerBox: '', individualQuantity: '', batchNumber: '', batchLocked: false, batchExists: false });
      };

      const processStockOut = async (updatedMed, selectedBatch, amount, overrideReason) => {
          if (selectedBatch.quantity < amount) { setAdjustmentForm(prev => ({ ...prev, error: `Cannot remove ${amount} ${ui.selectedMed.unit}. Only ${selectedBatch.quantity} ${ui.selectedMed.unit} available in this batch.` })); return; }
          
          try {
            const currentUser = getCurrentUserInfo();
            if (!currentUser || !currentUser.id) {
              setAdjustmentForm(prev => ({ ...prev, error: 'User not logged in' }));
              return;
            }

            // Determine if this is an internal transfer or external dispensing
            const targetLocationId = getLocationId(adjustmentForm.location);
            const isInternalTransfer = locations.some(loc => loc.displayName === adjustmentForm.location);
            const displayAmount = formatQuantityDisplay(amount, selectedBatch.itemsPerBox, ui.selectedMed.unit, adjustmentForm.type, adjustmentForm.type === 'boxes' ? adjustmentForm.amount : null);
            let transactionNote = adjustmentForm.note || (isInternalTransfer ? `Transfer to ${adjustmentForm.location} - ${displayAmount} - Brand: ${selectedBatch.brand}` : `Dispensed to ${adjustmentForm.location} - ${displayAmount} - Brand: ${selectedBatch.brand}`);
            if (overrideReason) transactionNote += ` [FEFO OVERRIDE: ${overrideReason}]`;

            if (isInternalTransfer) {
              // Use the dedicated transfer API for internal transfers
              // Server derives medication_id from batch_id - do not send medicationId
              await window.api.transferStock({
                userId: currentUser.id,
                batchId: selectedBatch.id,
                sourceLocationId: ui.selectedMed.locationId || getLocationId(ui.selectedMed.location),
                targetLocationId: targetLocationId,
                quantity: amount,
                reason: transactionNote
              });
            } else {
              // External dispensing - just remove stock
              // Server derives medication_id from batch_id - do not send medicationId
              await window.api.adjustStock({
                userId: currentUser.id,
                locationId: ui.selectedMed.locationId || getLocationId(ui.selectedMed.location),
                batchId: selectedBatch.id,
                delta: -amount,
                reason: transactionNote
              });

              // Handle cupboard stock removal - if removing from a cupboard, also remove from Medication Stock L1
              if (['Cupboard 1', 'Cupboard 2', 'Cupboard 3'].includes(ui.selectedMed.location)) {
                const mainStockMed = medications.find(m => m.name === ui.selectedMed.name && m.location === 'Medication Stock L1');
                if (mainStockMed) {
                  const mainStockBatch = mainStockMed.batches.find(b => 
                    b.expiryDate === selectedBatch.expiryDate && 
                    b.brand === selectedBatch.brand && 
                    b.itemsPerBox === selectedBatch.itemsPerBox
                  );
                  
                  if (mainStockBatch && mainStockBatch.quantity >= amount) {
                    const medStockL1LocationId = getLocationId('Medication Stock L1') || 
                                                  locations.find(loc => loc.groupName === 'Medication Stock L1')?.id;
                    if (medStockL1LocationId) {
                      // Server derives medication_id from batch_id - do not send medicationId
                      await window.api.adjustStock({
                        userId: currentUser.id,
                        locationId: medStockL1LocationId,
                        batchId: mainStockBatch.id,
                        delta: -amount,
                        reason: `Auto-adjustment: ${transactionNote}`
                      });
                    }
                  }
                }
              }
            }

            // Refresh data from backend (small delay to ensure DB commit)
            await new Promise(resolve => setTimeout(resolve, 100));
            const data = await window.api.fetchAllData();
            setMedications(data.medications || []);
            setTransactions(data.transactions || []);

            const selectedBatch = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
            checkLowStockAlert(ui.selectedMed, amount, selectedBatch?.id);
          } catch (err) {
            console.error('Failed to process stock out:', err);
            setAdjustmentForm(prev => ({ ...prev, error: err.message || 'Failed to process stock out' }));
          }
      };


      const handleExternalDispensing = (updatedMed, selectedBatch, amount, overrideReason) => {
        setMedications(medications.map(med => med.id === ui.selectedMed.id ? updatedMed : med));
          const displayAmount = formatQuantityDisplay(amount, selectedBatch.itemsPerBox, ui.selectedMed.unit, adjustmentForm.type, adjustmentForm.type === 'boxes' ? adjustmentForm.amount : null);
        let transactionNote = adjustmentForm.note || `Dispensed to ${adjustmentForm.location} - ${displayAmount} - Brand: ${selectedBatch.brand}`;
        if (overrideReason) transactionNote += ` [FEFO OVERRIDE: ${overrideReason}]`;
          const newTransaction = createTransaction({ medId: ui.selectedMed.id, medName: ui.selectedMed.name, type: 'out', amount, user: getCurrentUserInfo()?.fullName || auth.currentUser, location: adjustmentForm.location, note: transactionNote }, transactions.length + 1);
        setTransactions([newTransaction, ...transactions]);
        checkLowStockAlert(ui.selectedMed, amount, selectedBatch?.id);
      };

      const checkLowStockAlert = (med, amountRemoved) => {
        const currentTotalQuantity = getTotalQuantity(med);
        const newTotalQuantity = currentTotalQuantity - amountRemoved;
        const currentBoxes = getTotalBoxes(med);
        const newBoxes = med.batches.reduce((sum, batch) => {
          const batchQty = batch.id === batchId ? (batch.quantity - amountRemoved) : batch.quantity;
          return sum + (batch.numberOfBoxes || (batch.itemsPerBox ? Math.floor(batchQty / batch.itemsPerBox) : 0));
        }, 0);
        const wasAboveMin = currentBoxes >= med.minLevelBoxes;
        const isNowBelowMin = newBoxes < med.minLevelBoxes;
        if (wasAboveMin && isNowBelowMin) {
            // Removed alert for silent demo UX
        }
      };

      // Helper function to determine which cupboard to use for Medication Stock L1
      const getCupboardForMedication = (medicationName) => {
        // Simple logic: distribute medications across cupboards based on name hash
        const hash = medicationName.split('').reduce((a, b) => {
          a = ((a << 5) - a) + b.charCodeAt(0);
          return a & a;
        }, 0);
        const cupboardNumber = (Math.abs(hash) % 3) + 1;
        return `Cupboard ${cupboardNumber}`;
      };

      const processStockIn = async (updatedMed, selectedBatch, amount, overrideReason) => {
        try {
          const currentUser = getCurrentUserInfo();
          if (!currentUser || !currentUser.id) {
            setAdjustmentForm(prev => ({ ...prev, error: 'User not logged in' }));
            return;
          }

          if (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.sourceDepartment) {
            const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
            if (!sourceMed) { setAdjustmentForm(prev => ({ ...prev, error: `${ui.selectedMed.name} does not exist in ${adjustmentForm.sourceDepartment}` })); return; }
            const sourceBatch = sourceMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
            if (!sourceBatch) { setAdjustmentForm(prev => ({ ...prev, error: 'Selected batch not found in source department' })); return; }
            if (sourceBatch.quantity < amount) { setAdjustmentForm(prev => ({ ...prev, error: `Cannot transfer ${amount} ${ui.selectedMed.unit}. Only ${sourceBatch.quantity} ${ui.selectedMed.unit} available in source batch.` })); return; }
            
            const displayAmount = formatQuantityDisplay(amount, sourceBatch.itemsPerBox, ui.selectedMed.unit, adjustmentForm.type, adjustmentForm.type === 'boxes' ? adjustmentForm.amount : null);
            let transactionNote = adjustmentForm.note || `Stock received from ${adjustmentForm.sourceDepartment} - Brand: ${sourceBatch.brand}, Expiry: ${formatExpiry(sourceBatch.expiryDate)}`;
            if (overrideReason) transactionNote += ` [FEFO OVERRIDE: ${overrideReason}]`;

            // Use the dedicated transfer API
            // Server derives medication_id from batch_id - do not send medicationId
            await window.api.transferStock({
              userId: currentUser.id,
              batchId: sourceBatch.id,
              sourceLocationId: sourceMed.locationId || getLocationId(adjustmentForm.sourceDepartment),
              targetLocationId: ui.selectedMed.locationId || getLocationId(ui.selectedMed.location),
              quantity: amount,
              reason: transactionNote
            });
          } else {
            // Stock in from delivery (already handled by processAdjustment delivery flow)
            let transactionNote = adjustmentForm.note || `Stock received from ${adjustmentForm.stockInSource === 'delivery' ? 'Delivery' : adjustmentForm.sourceDepartment} - Brand: ${selectedBatch.brand}, Expiry: ${formatExpiry(selectedBatch.expiryDate)}`;
            if (overrideReason) transactionNote += ` [FEFO OVERRIDE: ${overrideReason}]`;

            // Server derives medication_id from batch_id - do not send medicationId
            await window.api.adjustStock({
              userId: currentUser.id,
              locationId: ui.selectedMed.locationId || getLocationId(ui.selectedMed.location),
              batchId: selectedBatch.id,
              delta: amount,
              reason: transactionNote
            });
          }

          // Refresh data from backend (small delay to ensure DB commit)
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          setTransactions(data.transactions || []);
          setLocations(data.locations || []);
        } catch (err) {
          console.error('Failed to process stock in:', err);
          setAdjustmentForm(prev => ({ ...prev, error: err.message || 'Failed to process stock in' }));
        }
      };

      const handleDeleteMedication = async () => {
        if (!deletion.med) return;
          if (!deletion.password.trim()) { setDeletion(prev => ({ ...prev, error: 'Please enter your password to confirm deletion' })); return; }
          if (!(await validatePassword(auth.currentUser, deletion.password))) { setDeletion(prev => ({ ...prev, error: 'Incorrect password. Please try again.', password: '' })); return; }
          
          const userInfo = getCurrentUserInfo();
          const internalId = deletion.med.internalId;
          
          if (!internalId) {
            setDeletion(prev => ({ ...prev, error: 'Unable to delete: medication ID not found' }));
            return;
          }

          try {
            // Soft-delete: set is_active to false
            await window.api.setMedicationActive(internalId, false);
            
            // Refresh data from backend to ensure UI is in sync (inactive meds will be filtered out)
            // Note: Backend doesn't create a transaction for soft-delete, so we create one locally for Activity Log
            await new Promise(resolve => setTimeout(resolve, 100));
            const deletionTransaction = createTransaction({ medId: deletion.med.id, medName: deletion.med.name, type: 'delete', amount: getTotalQuantity(deletion.med), user: userInfo?.fullName || auth.currentUser, location: 'System', note: `Medication deleted from system - Final stock level: ${getTotalQuantity(deletion.med)} ${deletion.med.unit}` }, transactions.length + 1);
            
            const data = await window.api.fetchAllData();
            setMedications(data.medications || []);
            // Merge backend transactions with local deletion transaction (backend doesn't create delete transactions)
            setTransactions([deletionTransaction, ...(data.transactions || [])]);
            
            // Close deletion modal
            setDeletion({ med: null, password: '', error: '' });
          } catch (err) {
            console.error('Failed to delete medication:', err);
            setDeletion(prev => ({ ...prev, error: err.message || 'Failed to delete medication' }));
          }
      };

      const handleRemoveBatch = async () => {
        if (!batchRemoval.batch) return;
          if (!batchRemoval.password.trim()) { setBatchRemoval(prev => ({ ...prev, error: 'Please enter your password to confirm removal' })); return; }
          if (!(await validatePassword(auth.currentUser, batchRemoval.password))) { setBatchRemoval(prev => ({ ...prev, error: 'Incorrect password. Please try again.', password: '' })); return; }
        const finalReason = batchRemoval.reason === 'other' ? batchRemoval.customReason.trim() : batchRemoval.reason;
          if (!finalReason) { setBatchRemoval(prev => ({ ...prev, error: 'Please provide a reason for removing this batch' })); return; }
        const { med, batch } = batchRemoval.batch;
        const userInfo = getCurrentUserInfo();
        
        if (!userInfo || !userInfo.id) {
          setBatchRemoval(prev => ({ ...prev, error: 'User not logged in' }));
          return;
        }

        try {
          // Get location ID from medication
          const locationId = med.locationId || getLocationId(med.location);
          
          if (!locationId) {
            setBatchRemoval(prev => ({ ...prev, error: 'Could not determine location for batch removal' }));
            return;
          }

          // Create removal reason note
          const removalNote = `Batch removed - Brand: ${batch.brand}, Expiry: ${formatExpiry(batch.expiryDate)} - Reason: ${finalReason} - Quantity: ${batch.quantity} ${med.unit}`;

          // Remove all stock from this batch by calling backend API with negative delta
          // Server derives medication_id from batch_id - do not send medicationId
          await window.api.adjustStock({
            userId: userInfo.id,
            locationId: locationId,
            batchId: batch.id,
            delta: -batch.quantity, // Negative delta to remove all stock
            reason: removalNote
          });

          // Refresh data from backend to ensure UI is in sync (small delay to ensure DB commit)
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          setTransactions(data.transactions || []);
          setLocations(data.locations || []);

          // Close modal
          setBatchRemoval({ batch: null, password: '', reason: '', customReason: '', error: '' });
        } catch (err) {
          console.error('Failed to remove batch:', err);
          setBatchRemoval(prev => ({ ...prev, error: err.message || 'Failed to remove batch. Please try again.' }));
        }
      };

      const handleUpdateMinLevel = async () => {
        if (!editMinLevel.editing) return;
        // minLevelBoxes is already in boxes, so use it directly
        let finalMinLevelBoxes = 0;
        if (!editMinLevel.boxes || parseInt(editMinLevel.boxes) < 0) { 
          setEditMinLevel(prev => ({ ...prev, error: 'Please enter a valid number of boxes (0 or greater)' })); 
          return; 
        }
        finalMinLevelBoxes = parseInt(editMinLevel.boxes);

        try {
          const currentUser = getCurrentUserInfo();
          if (!currentUser || !currentUser.id) {
            setEditMinLevel(prev => ({ ...prev, error: 'User not logged in' }));
            return;
          }

          // Get internal medication ID for backend update
          const internalMedicationId = Number(editMinLevel.editing.internalId);
          if (!Number.isFinite(internalMedicationId)) {
            setEditMinLevel(prev => ({ ...prev, error: 'Unable to determine medication ID for update.' }));
            return;
          }

          // Update min level using dedicated function
          await window.api.setMedicationMinLevel({
            medicationId: Math.floor(internalMedicationId),
            minLevel: Math.floor(finalMinLevelBoxes)
          });

          // Optimistically update local state while awaiting refetch
          setMedications(prev => prev.map(med => (
            med.internalId === Math.floor(internalMedicationId)
              ? { ...med, minLevelBoxes: Math.floor(finalMinLevelBoxes) }
              : med
          )));

          // Create transaction note for Activity Log
          const displayText = `${finalMinLevelBoxes} ${finalMinLevelBoxes === 1 ? 'box' : 'boxes'}`;
          const changeTransaction = createTransaction({ 
            medId: editMinLevel.editing.id, 
            medName: editMinLevel.editing.name, 
            type: 'system', 
            amount: 0, 
            user: currentUser.fullName || auth.currentUser, 
            location: 'System', 
            note: `Minimum level updated from ${formatMinLevelDisplay(editMinLevel.editing)} to ${displayText}` 
          }, transactions.length + 1);

          // Refresh data from backend (small delay to ensure DB commit)
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          // Merge backend transactions with local min level update transaction (backend doesn't create system transactions for min level updates)
          setTransactions([changeTransaction, ...(data.transactions || [])]);

          setEditMinLevel({ editing: null, newLevel: '', type: 'boxes', boxes: '', error: '' });
        } catch (err) {
          console.error('Failed to update minimum level:', err);
          setEditMinLevel(prev => ({ ...prev, error: err.message || 'Failed to update minimum level' }));
        }
      };

      const generateEmailContent = () => {
        const currentQty = getTotalQuantity(orderForm.med);
        const currentBoxes = getTotalBoxes(orderForm.med);
        const suggestedBoxes = Math.max(0, orderForm.med.minLevelBoxes - currentBoxes);
        const currentStock = `${currentBoxes} ${currentBoxes === 1 ? 'box' : 'boxes'}`;
        const minLevel = `${orderForm.med.minLevelBoxes} ${orderForm.med.minLevelBoxes === 1 ? 'box' : 'boxes'}`;
        const suggestedOrder = `${suggestedBoxes} ${suggestedBoxes === 1 ? 'box' : 'boxes'}`;
        const subject = `STOCK ORDER REQUEST: ${orderForm.med.name}`;
          const body = `Dear Ash,\n\nPlease find below the requested stock order for ${orderForm.med.name}.\n\nMEDICATION STOCK ORDER REQUEST\n\nMedication: ${orderForm.med.name}\nCurrent Stock Level: ${currentStock}\nMinimum Stock Level: ${minLevel}\nSuggested Order Quantity: ${suggestedOrder}\n\nREQUESTED ORDER QUANTITY: ${orderForm.quantity} ${orderForm.med.unit}\nURGENCY: ${orderForm.urgency.toUpperCase()}\n\n${orderForm.notes ? `Additional Notes:\n${orderForm.notes}\n\n` : ''}Requested by: ${auth.currentUser}\nDate: ${new Date().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}\n\nPlease process this order at your earliest convenience.`;
        return { subject, body };
      };

      const handleCopyToClipboard = async () => {
          if (!orderForm.quantity || parseInt(orderForm.quantity) <= 0) { alert('Please enter a valid quantity'); return; }

          // Save order to backend database
          try {
            const userInfo = getCurrentUserInfo();
            await window.api.placeOrder({
              medicationId: orderForm.med.internalId,
              userId: userInfo?.id || null,
              quantity: parseInt(orderForm.quantity),
              urgency: orderForm.urgency,
              notes: orderForm.notes || '',
              pharmacistEmail: orderForm.pharmacistEmail
            });

            // Create transaction for activity log
            const orderNote = `Order placed - Quantity: ${orderForm.quantity} ${orderForm.med.unit} - Urgency: ${orderForm.urgency.toUpperCase()}${orderForm.notes ? ` - Notes: ${orderForm.notes}` : ''} - Sent to: ${orderForm.pharmacistEmail}`;
            const orderTransaction = createTransaction({
              medId: orderForm.med.internalId || orderForm.med.id,
              medName: orderForm.med.name,
              type: 'order',
              amount: parseInt(orderForm.quantity),
              user: userInfo?.fullName || auth.currentUser,
              location: 'Order Request',
              note: orderNote
            }, transactions.length + 1);
            setTransactions([orderTransaction, ...transactions]);

            // Copy to clipboard
            const { subject, body } = generateEmailContent();
            const fullText = `To: ${orderForm.pharmacistEmail}\nSubject: ${subject}\n\n${body}`;
            await navigator.clipboard.writeText(fullText);

            // Close the modal
            setOrderForm({ med: null, quantity: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk' });

            // Refresh data to show updated order status
            const data = await window.api.fetchAllData();
            setMedications(data.medications || []);
            setTransactions([orderTransaction, ...(data.transactions || [])]);
            setOrders(data.orders || []);
          } catch (err) {
            console.error('Failed to place order:', err);
            alert('Failed to place order. Please try again.');
          }
      };

      const handleOpenOutlook = async () => {
          if (!orderForm.quantity || parseInt(orderForm.quantity) <= 0) { alert('Please enter a valid quantity'); return; }

          // Save order to backend database
          try {
            const userInfo = getCurrentUserInfo();
            await window.api.placeOrder({
              medicationId: orderForm.med.internalId,
              userId: userInfo?.id || null,
              quantity: parseInt(orderForm.quantity),
              urgency: orderForm.urgency,
              notes: orderForm.notes || '',
              pharmacistEmail: orderForm.pharmacistEmail
            });

            // Create transaction for activity log
            const orderNote = `Order placed - Quantity: ${orderForm.quantity} ${orderForm.med.unit} - Urgency: ${orderForm.urgency.toUpperCase()}${orderForm.notes ? ` - Notes: ${orderForm.notes}` : ''} - Sent to: ${orderForm.pharmacistEmail}`;
            const orderTransaction = createTransaction({
              medId: orderForm.med.internalId || orderForm.med.id,
              medName: orderForm.med.name,
              type: 'order',
              amount: parseInt(orderForm.quantity),
              user: userInfo?.fullName || auth.currentUser,
              location: 'Order Request',
              note: orderNote
            }, transactions.length + 1);
            setTransactions([orderTransaction, ...transactions]);

            // Open email client
            const { subject, body } = generateEmailContent();
            const mailtoLink = `mailto:${orderForm.pharmacistEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;

            // Close the modal after a short delay
            setTimeout(async () => {
              setOrderForm({ med: null, quantity: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk' });

              // Refresh data to show updated order status
              try {
                const data = await window.api.fetchAllData();
                setMedications(data.medications || []);
                setTransactions([orderTransaction, ...(data.transactions || [])]);
                setOrders(data.orders || []);
              } catch (refreshErr) {
                console.error('Failed to refresh data:', refreshErr);
              }
            }, 1000);
          } catch (err) {
            console.error('Failed to place order:', err);
            alert('Failed to place order. Please try again.');
          }
      };

      const generateLowStockEmailContent = () => {
        const reportDate = new Date().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
          const itemsList = lowStockMedications.sort((a, b) => a.name.localeCompare(b.name)).map(med => {
            const currentBoxes = getTotalBoxes(med);
            const suggestedBoxes = Math.max(0, med.minLevelBoxes - currentBoxes);
            return `${med.name}\n   Current Stock: ${currentBoxes} ${currentBoxes === 1 ? 'box' : 'boxes'}\n   Minimum Level: ${med.minLevelBoxes} ${med.minLevelBoxes === 1 ? 'box' : 'boxes'}\n   Suggested Order: ${suggestedBoxes} ${suggestedBoxes === 1 ? 'box' : 'boxes'}`;
          }).join('\n\n');
        const subject = `LOW STOCK ALERT - ${lowStockMedications.length} Medication${lowStockMedications.length !== 1 ? 's' : ''} Below Minimum Level`;
          const body = `Dear Ash,\n\nPlease find below the low stock alert report for Medicana Winchester.\n\nMEDICATION LOW STOCK REPORT\n\nGenerated: ${reportDate}\nReported by: ${auth.currentUser}\n\nSUMMARY:\n${lowStockMedications.length} medication${lowStockMedications.length !== 1 ? 's are' : ' is'} currently below minimum stock level and require${lowStockMedications.length === 1 ? 's' : ''} immediate attention.\n\nMEDICATIONS REQUIRING ORDER:\n\n${itemsList}\n\nACTIONS REQUIRED:\nPlease review and process orders for the above medications at your earliest convenience.`;
        return { subject, body };
      };

      const generateNewMedicationEmailContent = () => {
        const orderDate = new Date().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const medicationName = `${newMedicationOrderForm.name} ${newMedicationOrderForm.strength}`;
        const unitName = getUnitName(newMedicationOrderForm.type);
        
        // Format quantity - use the user's input directly
        let quantityText = newMedicationOrderForm.quantityNeeded;
        if (newMedicationOrderForm.type === 'Fluid bag' && newMedicationOrderForm.bagSize) {
          quantityText = `${newMedicationOrderForm.quantityNeeded} (${newMedicationOrderForm.bagSize} bags)`;
        }
        
        const subject = `NEW MEDICATION ORDER REQUEST - ${medicationName}`;
        const body = `Dear Ash,\n\nPlease find below a new medication order request for Medicana Winchester.\n\nNEW MEDICATION ORDER REQUEST\n\nGenerated: ${orderDate}\nRequested by: ${getCurrentUserInfo()?.fullName || auth.currentUser}\n\nMEDICATION DETAILS:\n\nMedication: ${medicationName}\nType: ${newMedicationOrderForm.type}\nStrength: ${newMedicationOrderForm.strength}\nQuantity Requested: ${quantityText}\nUrgency: ${newMedicationOrderForm.urgency.toUpperCase()}${newMedicationOrderForm.notes ? `\nAdditional Notes: ${newMedicationOrderForm.notes}` : ''}\n\nACTION REQUIRED:\nPlease review and process this new medication order at your earliest convenience. This medication is not currently in our stock system and needs to be added to our inventory.\n\nThank you for your attention to this matter.`;
        
        return { subject, body };
      };

        const exportLowStockReport = () => { if (lowStockMedications.length === 0) { alert('No low stock medications to report'); return; } setModals(prev => ({ ...prev, showLowStockReport: true })); };

      const handleNewMedicationOrder = () => {
        if (!newMedicationOrderForm.name.trim() || !newMedicationOrderForm.strength.trim() || !newMedicationOrderForm.quantityNeeded.trim()) {
          setNewMedicationOrderForm(prev => ({ ...prev, error: 'Please fill in all required fields' }));
          return;
        }
        if (newMedicationOrderForm.type === 'Fluid bag' && !newMedicationOrderForm.bagSize.trim()) {
          setNewMedicationOrderForm(prev => ({ ...prev, error: 'Please specify the bag size for Fluid bags' }));
          return;
        }
        setModals(prev => ({ ...prev, showNewMedicationOrder: true }));
      };

      const handleCopyNewMedicationOrder = () => {
        const medicationName = `${newMedicationOrderForm.name} ${newMedicationOrderForm.strength}`;
        const unitName = getUnitName(newMedicationOrderForm.type);
        
        // Format quantity for transaction note
        let quantityText = newMedicationOrderForm.quantityNeeded;
        if (newMedicationOrderForm.type === 'Fluid bag' && newMedicationOrderForm.bagSize) {
          quantityText = `${newMedicationOrderForm.quantityNeeded} (${newMedicationOrderForm.bagSize} bags)`;
        }
        
        const orderTransaction = createTransaction({ 
          medId: 0, 
          medName: medicationName, 
          type: 'order', 
          amount: parseInt(newMedicationOrderForm.containerQuantity), 
          user: getCurrentUserInfo()?.fullName || auth.currentUser, 
          location: 'New Medication Order Request', 
          note: `New medication order request (copied to clipboard) - ${medicationName} - Quantity: ${quantityText} - Urgency: ${newMedicationOrderForm.urgency.toUpperCase()}${newMedicationOrderForm.notes ? ` - ${newMedicationOrderForm.notes}` : ''} - Sent to: ${newMedicationOrderForm.pharmacistEmail}` 
        }, transactions.length + 1);
        setTransactions([orderTransaction, ...transactions]);
        const { subject, body } = generateNewMedicationEmailContent();
        const fullText = `To: ${newMedicationOrderForm.pharmacistEmail}\nSubject: ${subject}\n\n${body}`;
        navigator.clipboard.writeText(fullText).then(() => {
          setNewMedicationOrderForm({ name: '', type: 'Tablet', strength: '', quantityNeeded: '', bagSize: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk', error: '' });
          setModals(prev => ({ ...prev, showNewMedicationOrder: false }));
        }).catch(() => { alert('Failed to copy to clipboard. Please try selecting and copying the text manually.'); });
      };

      const handleOpenOutlookNewMedication = () => {
        const medicationName = `${newMedicationOrderForm.name} ${newMedicationOrderForm.strength}`;
        const unitName = getUnitName(newMedicationOrderForm.type);

        // Format quantity for transaction note
        let quantityText = newMedicationOrderForm.quantityNeeded;
        if (newMedicationOrderForm.type === 'Fluid bag' && newMedicationOrderForm.bagSize) {
          quantityText = `${newMedicationOrderForm.quantityNeeded} (${newMedicationOrderForm.bagSize} bags)`;
        }

        const orderTransaction = createTransaction({
          medId: 0,
          medName: medicationName,
          type: 'order',
          amount: parseInt(newMedicationOrderForm.containerQuantity),
          user: getCurrentUserInfo()?.fullName || auth.currentUser,
          location: 'New Medication Order Request',
          note: `New medication order request - ${medicationName} - Quantity: ${quantityText} - Urgency: ${newMedicationOrderForm.urgency.toUpperCase()}${newMedicationOrderForm.notes ? ` - ${newMedicationOrderForm.notes}` : ''} - Sent to: ${newMedicationOrderForm.pharmacistEmail}`
        }, transactions.length + 1);
        setTransactions([orderTransaction, ...transactions]);
        const { subject, body } = generateNewMedicationEmailContent();
        const mailtoLink = `mailto:${newMedicationOrderForm.pharmacistEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailtoLink;
        setTimeout(() => {
          setNewMedicationOrderForm({ name: '', type: 'Tablet', strength: '', quantityNeeded: '', bagSize: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk', error: '' });
          setModals(prev => ({ ...prev, showNewMedicationOrder: false }));
        }, 1000);
      };

      const handleFulfilOrderBatchSelect = (batchId) => {
        if (!batchId) {
          // Reset to new batch mode
          setFulfilOrderForm(prev => ({
            ...prev,
            selectedBatchId: '',
            brand: '',
            batchNumber: '',
            expiryMonth: '',
            expiryYear: '',
            itemsPerBox: prev.med?.standardItemsPerBox || '',
            error: ''
          }));
          return;
        }

        // Get all batches from all locations for this medication
        const allBatches = [];
        medications.forEach(med => {
          if (med.medicationName === fulfilOrderForm.med.medicationName &&
              med.strengthRaw === fulfilOrderForm.med.strengthRaw &&
              med.type === fulfilOrderForm.med.type) {
            if (med.batches && Array.isArray(med.batches)) {
              allBatches.push(...med.batches);
            }
          }
        });

        const selectedBatch = allBatches.find(b => b.id === parseInt(batchId));
        if (selectedBatch) {
          const expiryDate = selectedBatch.expiryDate ? new Date(selectedBatch.expiryDate + '-01') : null;
          const expiryMonth = expiryDate ? String(expiryDate.getMonth() + 1).padStart(2, '0') : '';
          const expiryYear = expiryDate ? String(expiryDate.getFullYear()) : '';

          setFulfilOrderForm(prev => ({
            ...prev,
            selectedBatchId: batchId,
            batchNumber: selectedBatch.batchNumber || selectedBatch.batchCode || '',
            brand: selectedBatch.brand || '',
            expiryMonth: expiryMonth,
            expiryYear: expiryYear,
            itemsPerBox: selectedBatch.itemsPerBox ? String(selectedBatch.itemsPerBox) : (prev.med?.standardItemsPerBox || ''),
            error: ''
          }));
        } else {
          // Update selectedBatchId even if batch not found, to show selection in dropdown
          setFulfilOrderForm(prev => ({
            ...prev,
            selectedBatchId: batchId,
            error: ''
          }));
        }
      };

      const handleFulfilOrder = async () => {
        // Validate form
        if (!fulfilOrderForm.brand.trim() || !fulfilOrderForm.expiryMonth || !fulfilOrderForm.expiryYear) {
          setFulfilOrderForm(prev => ({ ...prev, error: 'Please enter brand name and expiry date' }));
          return;
        }
        if (!fulfilOrderForm.selectedLocationId) {
          setFulfilOrderForm(prev => ({ ...prev, error: 'Please select a delivery location' }));
          return;
        }

        let totalQuantity = 0;
        let itemsPerBox = null;

        if (fulfilOrderForm.quantityType === 'boxes') {
          if (!fulfilOrderForm.boxQuantity || !fulfilOrderForm.itemsPerBox ||
              parseInt(fulfilOrderForm.boxQuantity) <= 0 || parseInt(fulfilOrderForm.itemsPerBox) <= 0) {
            setFulfilOrderForm(prev => ({ ...prev, error: 'Please enter valid box quantity and items per box' }));
            return;
          }
          totalQuantity = parseInt(fulfilOrderForm.boxQuantity) * parseInt(fulfilOrderForm.itemsPerBox);
          itemsPerBox = parseInt(fulfilOrderForm.itemsPerBox);
        } else {
          if (!fulfilOrderForm.individualQuantity || parseInt(fulfilOrderForm.individualQuantity) <= 0) {
            setFulfilOrderForm(prev => ({ ...prev, error: 'Please enter valid quantity' }));
            return;
          }
          totalQuantity = parseInt(fulfilOrderForm.individualQuantity);
        }

        // Set submitting state
        setFulfilOrderForm(prev => ({ ...prev, isSubmitting: true, error: '' }));

        try {
          const currentUser = getCurrentUserInfo();
          if (!currentUser || !currentUser.id) {
            setFulfilOrderForm(prev => ({ ...prev, error: 'User not logged in', isSubmitting: false }));
            return;
          }

          const displayAmount = formatQuantityDisplay(
            totalQuantity,
            itemsPerBox,
            fulfilOrderForm.med.unit,
            fulfilOrderForm.quantityType,
            fulfilOrderForm.quantityType === 'boxes' ? fulfilOrderForm.boxQuantity : null
          );

          const deliveryNote = `Order fulfilled - Brand: ${fulfilOrderForm.brand} - ${displayAmount} - Order ID: ${fulfilOrderForm.order.id}`;

          // Add the batch with stock
          await window.api.addBatch({
            medicationId: fulfilOrderForm.med.id,
            batchNumber: fulfilOrderForm.batchNumber || `BATCH-${Date.now()}`,
            expiryMonth: parseInt(fulfilOrderForm.expiryMonth),
            expiryYear: parseInt(fulfilOrderForm.expiryYear),
            brand: fulfilOrderForm.brand,
            itemsPerBox: itemsPerBox || null,
            quantityBoxes: fulfilOrderForm.quantityType === 'boxes' ? parseInt(fulfilOrderForm.boxQuantity) : 0,
            quantityIndividuals: fulfilOrderForm.quantityType === 'individuals' ? parseInt(fulfilOrderForm.individualQuantity) : 0,
            locationId: fulfilOrderForm.selectedLocationId,
            userId: currentUser.id,
            note: deliveryNote
          });

          // Mark order as fulfilled
          await window.api.fulfillOrder(fulfilOrderForm.order.id);

          // Refresh data from backend
          await new Promise(resolve => setTimeout(resolve, 100));
          const data = await window.api.fetchAllData();
          setMedications(data.medications || []);
          setTransactions(data.transactions || []);
          setOrders(data.orders || []);

          // Reset form and close modal
          setFulfilOrderForm({
            order: null,
            med: null,
            selectedLocationId: '',
            batchOption: 'new',
            selectedBatchId: '',
            brand: '',
            batchNumber: '',
            expiryMonth: '',
            expiryYear: '',
            quantityType: 'boxes',
            boxQuantity: '',
            itemsPerBox: '',
            individualQuantity: '',
            error: '',
            isSubmitting: false
          });
          setModals(prev => ({ ...prev, showFulfilOrder: false }));

        } catch (err) {
          console.error('Failed to fulfill order:', err);
          setFulfilOrderForm(prev => ({ ...prev, error: err.message || 'Failed to fulfill order', isSubmitting: false }));
        }
      };

      const handleCopyLowStockReport = () => {
          const reportTransaction = createTransaction({ medId: 0, medName: 'Low Stock Report', type: 'order', amount: lowStockMedications.length, user: getCurrentUserInfo()?.fullName || auth.currentUser, location: 'Bulk Order Request', note: `Low stock report generated (copied to clipboard) for ${lowStockMedications.length} medication${lowStockMedications.length !== 1 ? 's' : ''} - Sent to: ${orderForm.pharmacistEmail}` }, transactions.length + 1);
        setTransactions([reportTransaction, ...transactions]);
        const { subject, body } = generateLowStockEmailContent();
        const fullText = `To: ${orderForm.pharmacistEmail}\nSubject: ${subject}\n\n${body}`;
          navigator.clipboard.writeText(fullText).then(() => { setModals(prev => ({ ...prev, showLowStockReport: false })); }).catch(() => { alert('Failed to copy to clipboard. Please try selecting and copying the text manually.'); });
      };

      const handleOpenOutlookLowStock = () => {
          const reportTransaction = createTransaction({ medId: 0, medName: 'Low Stock Report', type: 'order', amount: lowStockMedications.length, user: getCurrentUserInfo()?.fullName || auth.currentUser, location: 'Bulk Order Request', note: `Low stock report generated for ${lowStockMedications.length} medication${lowStockMedications.length !== 1 ? 's' : ''} - Sent to: ${orderForm.pharmacistEmail}` }, transactions.length + 1);
        setTransactions([reportTransaction, ...transactions]);
        const { subject, body } = generateLowStockEmailContent();
        const mailtoLink = `mailto:${orderForm.pharmacistEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailtoLink;
          setTimeout(() => { setModals(prev => ({ ...prev, showLowStockReport: false })); }, 1000);
      };

      if (!auth.isLoggedIn) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-cyan-50 flex items-center justify-center p-3 sm:p-4">
            <div className="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-md w-full mx-2 sm:mx-0">
              <div className="flex flex-col items-center justify-center mb-4 sm:mb-6">
                  <div className="mb-3 sm:mb-4">
                    <div className="flex items-center justify-center gap-2">
                      <h1 className="text-2xl sm:text-3xl font-bold tracking-tight" style={{color: '#0c2753'}}>MEDICANA</h1>
                      <span className="text-2xl sm:text-3xl font-bold text-cyan-500">\\</span>
                    </div>
                  <div className="flex justify-between items-center mt-1 w-full">
                    <h2 className="text-lg sm:text-xl font-bold text-cyan-500 tracking-widest">HEALTH GROUP</h2>
                  </div>
                </div>
                <h3 className="text-lg sm:text-xl font-semibold text-gray-700">Winchester</h3>
                <p className="text-xs sm:text-sm text-gray-500 mt-2">Medication Stock Management</p>
              </div>
                {auth.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-xs sm:text-sm text-red-700">{auth.error}</div>)}
              <div>
                <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Username</label>
                  <input type="text" value={auth.currentUser} onChange={(e) => setAuth(prev => ({ ...prev, currentUser: e.target.value }))} onKeyPress={handleKeyPress} className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent mb-4 text-sm" placeholder="Enter username" />
                <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Password</label>
                  <input type="password" value={auth.password} onChange={(e) => setAuth(prev => ({ ...prev, password: e.target.value }))} onKeyPress={handleKeyPress} className="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent mb-4 text-sm" placeholder="Enter password" />
                  <button onClick={handleLogin} className="w-full bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-700 transition-colors font-medium text-sm sm:text-base">Log In</button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-cyan-50">
          {/* Header */}
          <div className="bg-white text-gray-900 p-3 sm:p-4 shadow-lg border-b-2 border-gray-200 relative">
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <span className="text-3xl sm:text-4xl md:text-6xl font-black text-slate-500 opacity-50">PROTOTYPE</span>
            </div>
            <div className="max-w-7xl mx-auto flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-0 relative z-10">
              <div className="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-0">
                <div className="mr-0 sm:mr-4">
                  <div className="flex items-center gap-2">
                    <h1 className="text-lg sm:text-xl font-bold tracking-tight" style={{color: '#0c2753'}}>MEDICANA</h1>
                    <span className="text-lg sm:text-xl font-bold text-cyan-500">\\</span>
                  </div>
                  <div className="flex justify-between w-full">
                    <p className="text-sm sm:text-base text-cyan-500 font-bold tracking-widest">HEALTH GROUP</p>
                  </div>
                  <p className="text-xs text-slate-600 font-semibold tracking-wide">WINCHESTER</p>
                </div>
                <div className="border-l-0 sm:border-l border-t sm:border-t-0 border-gray-300 pl-0 sm:pl-4 pt-3 sm:pt-0">
                  <p className="text-xs sm:text-sm font-medium text-gray-900">Medication Stock Management</p>
                  <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                    <p className="text-xs text-gray-600">Logged in as: {getCurrentUserInfo()?.fullName || auth.currentUser}</p>
                    <button onClick={() => setModals(prev => ({ ...prev, showChangePassword: true }))} className="text-xs text-cyan-600 hover:text-cyan-700 underline">Change Password</button>
                  </div>
                  {globalBarcodeScanner.isActive && (
                    <div className="flex items-center gap-1 mt-1">
                      <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                      <p className="text-xs text-green-600 font-medium">Global Scanner Active</p>
                    </div>
                  )}
                </div>
                </div>
                <button onClick={handleLogout} className="bg-cyan-500 px-4 py-2 rounded hover:bg-cyan-600 transition-colors text-sm font-medium text-white w-full sm:w-auto">Log Out</button>
            </div>
          </div>

          {/* Location Selector */}
          <div className="bg-slate-50 border-b border-gray-200 shadow-sm">
            <div className="max-w-7xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
              <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                <label className="text-xs sm:text-sm font-semibold text-gray-700 whitespace-nowrap">Current Location:</label>
                  <select value={ui.currentLocation} onChange={(e) => setUi(prev => ({ ...prev, currentLocation: e.target.value }))} className="w-full sm:w-auto px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent bg-white font-medium text-gray-900 text-sm">
                  <option value="All">All Locations</option>
                    {(() => {
                      // Group locations by groupName
                      const grouped = {};
                      locations.forEach(loc => {
                        if (loc.groupName) {
                          if (!grouped[loc.groupName]) grouped[loc.groupName] = [];
                          grouped[loc.groupName].push(loc);
                        } else {
                          if (!grouped['_ungrouped']) grouped['_ungrouped'] = [];
                          grouped['_ungrouped'].push(loc);
                        }
                      });

                      const elements = [];
                      // Render grouped locations
                      Object.keys(grouped).forEach(groupName => {
                        if (groupName !== '_ungrouped') {
                          elements.push(
                            <optgroup key={groupName} label={groupName}>
                              <option value={groupName}>{groupName} (All)</option>
                              {grouped[groupName].map(loc => (
                                <option key={loc.id} value={loc.displayName}>{loc.displayName}</option>
                              ))}
                            </optgroup>
                          );
                        }
                      });
                      // Render ungrouped locations
                      if (grouped['_ungrouped']) {
                        grouped['_ungrouped'].forEach(loc => {
                          elements.push(<option key={loc.id} value={loc.displayName}>{loc.displayName}</option>);
                        });
                      }
                      return elements;
                    })()}
                </select>
                  <p className="text-xs sm:text-sm text-gray-600">
                    {ui.currentLocation === 'All' ? 'Viewing stock across all locations' :
                     isGroupName(ui.currentLocation, locations) ? `Viewing combined stock for ${ui.currentLocation}` :
                     `Viewing stock for ${ui.currentLocation}`}
                  </p>
              </div>
            </div>
          </div>

          {/* Main Content */}
          <div className="max-w-7xl mx-auto p-3 sm:p-4 md:p-6">
            <div className="bg-white rounded-lg shadow">
              {/* Tabs */}
              <div className="border-b border-gray-200 shadow-lg relative z-30">
                <nav className="flex -mb-px overflow-x-auto scrollbar-hide relative z-10">
                    {canAccessTab('medications') && (
                      <button onClick={() => setUi(prev => ({ ...prev, activeTab: 'medications' }))} className={`px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap relative ${ui.activeTab === 'medications' ? 'border-cyan-500 text-cyan-600 shadow-lg z-20' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Medications List</button>
                    )}
                    {canAccessTab('transactions') && (
                      <button onClick={() => setUi(prev => ({ ...prev, activeTab: 'transactions' }))} className={`px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-medium border-b-2 transition-all whitespace-nowrap relative ${ui.activeTab === 'transactions' ? 'border-cyan-500 text-cyan-600 shadow-lg z-20' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Activity Log</button>
                    )}
                    {canAccessTab('lowstock') && (
                      <button onClick={() => setUi(prev => ({ ...prev, activeTab: 'lowstock' }))} className={`px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors relative whitespace-nowrap ${ui.activeTab === 'lowstock' ? 'border-cyan-500 text-cyan-600 shadow-lg' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                      Low Stock
                        {lowStockMedications.length > 0 && (<span className="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">{lowStockMedications.length}</span>)}
                    </button>
                    )}
                    {canAccessTab('newmedication') && (
                      <button onClick={() => setUi(prev => ({ ...prev, activeTab: 'newmedication' }))} className={`px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${ui.activeTab === 'newmedication' ? 'border-cyan-500 text-cyan-600 shadow-lg' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                      New Medication Order
                    </button>
                    )}
                </nav>
              </div>

                {/* Medications Tab */}
              {ui.activeTab === 'medications' && (
                <>
                  <div className="p-3 sm:p-4 border-b">
                    <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 items-stretch sm:items-center mb-3">
                      <div className="relative flex-1 min-w-0">
                        <Search className="absolute left-3 top-3 w-4 h-4 sm:w-5 sm:h-5 text-gray-400" />
                          <input 
                            type="text" 
                            id="medication-search-input" 
                            placeholder="Search medications..." 
                            value={ui.searchTerm} 
                            onChange={(e) => setUi(prev => ({ ...prev, searchTerm: e.target.value }))}
                            onKeyDown={(e) => {
                              const now = Date.now();
                              const timeSinceLastKey = now - searchBarcodeDetection.lastKeyTime;
                              // Track input speed to detect barcode scanner (typically < 50ms between characters)
                              setSearchBarcodeDetection(prev => ({
                                ...prev,
                                lastKeyTime: now,
                                inputSpeed: timeSinceLastKey
                              }));
                            }}
                            className="w-full pl-9 sm:pl-10 pr-9 sm:pr-10 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                          />
                          {ui.searchTerm && (
                            <button
                              onClick={() => setUi(prev => ({ ...prev, searchTerm: '' }))}
                              className="absolute right-3 top-3 text-gray-400 hover:text-gray-600 focus:outline-none"
                              aria-label="Clear search"
                            >
                              <X className="w-4 h-4 sm:w-5 sm:h-5" />
                            </button>
                          )}
                      </div>
                      <div className="flex gap-2 sm:gap-3 flex-shrink-0">
                        <button 
                          onClick={(e) => {
                            setGlobalBarcodeScanner(prev => ({ ...prev, isActive: !prev.isActive }));
                            e.currentTarget.blur(); // Remove focus from button to prevent barcode scanner from triggering it
                          }}
                          className={`px-3 sm:px-4 py-2 rounded-lg transition-colors text-xs sm:text-sm font-medium whitespace-nowrap flex items-center gap-2 ${
                            globalBarcodeScanner.isActive 
                              ? 'bg-blue-500 text-white hover:bg-blue-600' 
                              : 'bg-gray-300 text-gray-700 hover:bg-gray-400'
                          }`}
                          title={globalBarcodeScanner.isActive ? "Global scanner is ON - scan barcodes from anywhere" : "Global scanner is OFF - click to enable"}
                        >
                          <div className={`w-2 h-2 sm:w-3 sm:h-3 rounded-full ${globalBarcodeScanner.isActive ? 'bg-green-400' : 'bg-gray-400'}`}></div>
                          <span className="hidden sm:inline">Global Scan</span>
                          <span className="sm:hidden">Scan</span>
                        </button>
                          {getUserRole() !== 'Basic User' && (
                            <button onClick={() => { if (ui.currentLocation === 'All' || ui.currentLocation === 'Medication Stock L1') { alert('Please select a specific location (Cupboard 1, 2, or 3) from the dropdown above before adding stock.'); } else { setModals(prev => ({ ...prev, showAddMedication: true })); } }} className="bg-cyan-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-cyan-600 transition-colors text-xs sm:text-sm font-medium whitespace-nowrap flex items-center gap-2">
                              <Plus className="w-3 h-3 sm:w-4 sm:h-4" />
                              <span className="hidden sm:inline">Add New Stock</span>
                              <span className="sm:hidden">Add</span>
                            </button>
                          )}
                      </div>
                    </div>

                    {/* Filters */}
                    <div className="space-y-2">
                      <div className="flex justify-between items-center">
                        <p className="text-xs font-medium text-gray-700">Filters:</p>
                        <button
                          onClick={() => setMedicationFilters({ types: [], locations: [], statuses: [] })}
                          className="text-xs text-gray-600 hover:text-gray-700 underline"
                        >
                          Clear All Filters
                        </button>
                      </div>

                      {/* Type Filter */}
                      {availableTypes.length > 0 && (
                        <div>
                          <p className="text-xs font-medium text-gray-600 mb-1">Type:</p>
                          <div className="flex flex-wrap gap-1">
                            {availableTypes.map(type => (
                              <button
                                key={type}
                                onClick={() => {
                                  if (medicationFilters.types.includes(type)) {
                                    setMedicationFilters(prev => ({ ...prev, types: prev.types.filter(t => t !== type) }));
                                  } else {
                                    setMedicationFilters(prev => ({ ...prev, types: [...prev.types, type] }));
                                  }
                                }}
                                className={`px-2 py-1 rounded text-xs font-medium border transition-all capitalize ${
                                  medicationFilters.types.includes(type)
                                    ? 'bg-cyan-100 text-cyan-800 border-cyan-300'
                                    : 'bg-white text-gray-600 border-gray-300 hover:border-cyan-300'
                                }`}
                              >
                                {type}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Location Filter - Only show when "All" is selected */}
                      {ui.currentLocation === 'All' && availableLocations.length > 0 && (
                        <div>
                          <p className="text-xs font-medium text-gray-600 mb-1">Location:</p>
                          <div className="flex flex-wrap gap-1">
                            {availableLocations.map(location => (
                              <button
                                key={location}
                                onClick={() => {
                                  if (medicationFilters.locations.includes(location)) {
                                    setMedicationFilters(prev => ({ ...prev, locations: prev.locations.filter(l => l !== location) }));
                                  } else {
                                    setMedicationFilters(prev => ({ ...prev, locations: [...prev.locations, location] }));
                                  }
                                }}
                                className={`px-2 py-1 rounded text-xs font-medium border transition-all ${
                                  medicationFilters.locations.includes(location)
                                    ? 'bg-blue-100 text-blue-800 border-blue-300'
                                    : 'bg-white text-gray-600 border-gray-300 hover:border-blue-300'
                                }`}
                              >
                                {location}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Status Filter */}
                      {availableStatuses.length > 0 && (
                        <div>
                          <p className="text-xs font-medium text-gray-600 mb-1">Status:</p>
                          <div className="flex flex-wrap gap-1">
                            {availableStatuses.map(status => (
                              <button
                                key={status}
                                onClick={() => {
                                  if (medicationFilters.statuses.includes(status)) {
                                    setMedicationFilters(prev => ({ ...prev, statuses: prev.statuses.filter(s => s !== status) }));
                                  } else {
                                    setMedicationFilters(prev => ({ ...prev, statuses: [...prev.statuses, status] }));
                                  }
                                }}
                                className={`px-2 py-1 rounded text-xs font-medium border transition-all ${
                                  medicationFilters.statuses.includes(status)
                                    ? status === 'Low Stock' ? 'bg-red-100 text-red-800 border-red-300'
                                      : status === 'OK' ? 'bg-green-100 text-green-800 border-green-300'
                                      : 'bg-blue-100 text-blue-800 border-blue-300'
                                    : 'bg-white text-gray-600 border-gray-300 hover:border-gray-400'
                                }`}
                              >
                                {status}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="overflow-x-auto -mx-3 sm:mx-0">
                    <table className="w-full min-w-[640px]">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase">Medication</th>
                            {(ui.currentLocation === 'All' || ui.currentLocation === 'Medication Stock L1') && (<th className="px-2 sm:px-4 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase">Location</th>)}
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-center text-xs font-semibold text-gray-600 uppercase">Type</th>
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-center text-xs font-semibold text-gray-600 uppercase">Current Stock</th>
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-center text-xs font-semibold text-gray-600 uppercase">Min Level</th>
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-center text-xs font-semibold text-gray-600 uppercase">Status</th>
                          <th className="px-2 sm:px-4 py-2 sm:py-3 text-center text-xs font-semibold text-gray-600 uppercase">Action</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {displayMedications.map(med => {
                          // Use composite key: medication_name|strength_raw|type|location for stable identity
                          const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                          return (
                            <React.Fragment key={stableKey}>
                            <tr className="hover:bg-gray-50" data-med-id={med.id}>
                              <td className="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-gray-900">
                                  <button onClick={() => setUi(prev => ({ ...prev, expandedMedId: prev.expandedMedId === med.id ? null : med.id }))} className="flex items-center gap-1 sm:gap-2 hover:text-cyan-600 text-left w-full">
                                  <span className="flex-shrink-0" style={{color: '#0c2753'}}>{ui.expandedMedId === med.id ? '▼' : '▶'}</span>
                                  <span className="break-words">{med.name}</span>
                                </button>
                              </td>
                                {(ui.currentLocation === 'All' || ui.currentLocation === 'Medication Stock L1') && (
                                  <td className="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-gray-700">
                                    {ui.currentLocation === 'All' && med.locations && med.locations.length > 1 ? (
                                      <div className="flex flex-wrap gap-1">
                                        {med.locations.sort().map((loc, idx) => (
                                          <span key={idx} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{loc}</span>
                                        ))}
                                      </div>
                                    ) : (
                                      med.location
                                    )}
                                  </td>
                                )}
                              <td className="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-gray-600 text-center capitalize">{med.type}</td>
                                <td className="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-center"><span className={`font-semibold ${getTotalBoxes(med) < med.minLevelBoxes ? 'text-red-600' : 'text-gray-900'}`}>{formatStockDisplay(med)}</span></td>
                              <td className="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-gray-600 text-center">
                                <div className="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2">
                                  <span>{formatMinLevelDisplay(med)}</span>
                                    <button onClick={() => setEditMinLevel({ editing: med, newLevel: '', type: 'boxes', boxes: (med.minLevelBoxes || 0).toString(), error: '' })} className="text-cyan-600 hover:text-cyan-700 text-xs underline">Edit</button>
                                </div>
                              </td>
                              <td className="px-2 sm:px-4 py-2 sm:py-3 text-center">
                                <div className="flex flex-col gap-1 items-center">
                                  {getTotalBoxes(med) === 0 && hasPendingOrder(med) ? (
                                      <span className="inline-flex items-center px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><Download className="w-2.5 h-2.5 sm:w-3 sm:h-3 mr-0.5 sm:mr-1" />Order Pending</span>
                                  ) : getTotalBoxes(med) < med.minLevelBoxes ? (
                                      <>
                                        <span className="inline-flex items-center px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><AlertTriangle className="w-2.5 h-2.5 sm:w-3 sm:h-3 mr-0.5 sm:mr-1" />Low</span>
                                        {hasPendingOrder(med) && (
                                          <span className="inline-flex items-center px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><Download className="w-2.5 h-2.5 sm:w-3 sm:h-3 mr-0.5 sm:mr-1" />Ordered</span>
                                        )}
                                      </>
                                  ) : (
                                      <>
                                        <span className="inline-flex items-center px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">OK</span>
                                        {hasPendingOrder(med) && (
                                          <span className="inline-flex items-center px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><Download className="w-2.5 h-2.5 sm:w-3 sm:h-3 mr-0.5 sm:mr-1" />Ordered</span>
                                        )}
                                      </>
                                  )}
                                </div>
                              </td>
                              <td className="px-2 sm:px-4 py-2 sm:py-3 text-center">
                                <div className="flex gap-1 sm:gap-2 justify-center">
                                  {hasPendingOrder(med) && (
                                    <button onClick={() => {
                                      // Check if this is a grouped medication (multiple locations)
                                      if (ui.currentLocation === 'All' && med.locations && med.locations.length > 1) {
                                        alert(`This medication is in multiple locations: ${med.locations.sort().join(', ')}. Please select a specific location to fulfil the order.`);
                                        return;
                                      }
                                      // Get the pending order
                                      const pendingOrder = getMostRecentOrder(med);
                                      const defaultQuantityType = med.standardItemsPerBox ? 'boxes' : 'individuals';

                                      // Pre-fill location if medication is only in one location
                                      let defaultLocationId = '';
                                      if (med.locationId) {
                                        defaultLocationId = med.locationId;
                                      } else if (med.locations && med.locations.length === 1) {
                                        const location = locations.find(l => l.displayName === med.locations[0]);
                                        if (location) defaultLocationId = location.id;
                                      }

                                      setFulfilOrderForm({
                                        order: pendingOrder,
                                        med: med,
                                        selectedLocationId: defaultLocationId,
                                        batchOption: 'new',
                                        selectedBatchId: '',
                                        brand: '',
                                        batchNumber: '',
                                        expiryMonth: '',
                                        expiryYear: '',
                                        quantityType: defaultQuantityType,
                                        boxQuantity: '',
                                        itemsPerBox: med.standardItemsPerBox || '',
                                        individualQuantity: '',
                                        error: ''
                                      });
                                      setModals(prev => ({ ...prev, showFulfilOrder: true }));
                                    }} className="bg-purple-600 hover:bg-purple-700 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium transition-colors">Fulfil Order</button>
                                  )}
                                  <button onClick={() => {
                                    // Check if this is a grouped medication (multiple locations)
                                    if (ui.currentLocation === 'All' && med.locations && med.locations.length > 1) {
                                      alert(`This medication is in multiple locations: ${med.locations.sort().join(', ')}. Please select a specific location to adjust stock.`);
                                      return;
                                    }
                                    const defaultQuantityType = med.standardItemsPerBox ? 'boxes' : 'individuals';
                                    setUi(prev => ({ ...prev, selectedMed: med }));
                                    setModals(prev => ({ ...prev, showAdjustStock: true }));
                                    setAdjustmentForm({ amount: '', note: '', location: '', type: defaultQuantityType, action: 'out', batchId: '', sourceDepartment: '', stockInSource: 'transfer', transferBatchOption: 'existing', deliveryBatchOption: 'new', stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' });
                                    setDeliveryForm({ brand: '', expiryMonth: '', expiryYear: '', quantityType: defaultQuantityType, boxQuantity: '', itemsPerBox: '', individualQuantity: '', batchNumber: '' });
                                  }} className="text-cyan-600 hover:text-cyan-700 font-medium text-xs sm:text-sm">Adjust</button>
                                </div>
                              </td>
                            </tr>
                            {ui.expandedMedId === med.id && (
                              <tr className="bg-gray-50">
                                <td colSpan={(ui.currentLocation === 'All' || ui.currentLocation === 'Medication Stock L1') ? "7" : "6"} className="px-2 sm:px-4 py-2 sm:py-3">
                                  <div className="ml-8">
                                    {med.barcode && (
                                      <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded">
                                        <span className="text-sm text-blue-700 font-medium">🔍 Barcode: </span>
                                        <span className="text-sm text-blue-900 font-mono">{med.barcode}</span>
                                      </div>
                                    )}
                                    <h4 className="text-sm font-semibold text-gray-700 mb-2">Batch Details:</h4>
                                    <div className="space-y-2">
                                      {med.batches.sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01')).map((batch, idx) => {
                                        const formattedExpiry = formatExpiry(batch.expiryDate);
                                        const displayQuantity = batch.totalQuantity || batch.quantity;
                                        const batchDetailsForDisplay = batch.totalQuantity ? { ...batch, quantity: batch.totalQuantity } : batch;
                                        const batchDetails = formatBatchDetails(batchDetailsForDisplay, med.unit);
                                        return (
                                          <div key={batch.id} className="bg-white p-3 rounded border border-gray-200">
                                            <div className="flex items-center justify-between gap-4 text-sm mb-2">
                                              <div className="flex items-center gap-4 flex-wrap">
                                                <span className="text-gray-600 font-medium">Batch {idx + 1}:</span>
                                                <span className="font-medium text-gray-900">{batchDetails}</span>
                                                {batch.batchNumber && (
                                                  <>
                                                    <span className="text-gray-600">Batch #:</span>
                                                    <span className="font-medium text-gray-900">{batch.batchNumber}</span>
                                                  </>
                                                )}
                                                <span className="text-gray-600">Expiry:</span>
                                                <span className="font-medium text-gray-900">{formattedExpiry}</span>
                                              </div>
                                              {!batch.locations && (
                                                <button onClick={() => {
                                                  setBatchRemoval({ batch: { med, batch }, password: '', reason: '', customReason: '', error: '' });
                                                }} className="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition-colors text-xs font-medium">Remove</button>
                                              )}
                                            </div>
                                            {batch.locations && ui.currentLocation === 'All' && (
                                              <div className="mt-2 pl-4 border-l-2 border-gray-300">
                                                <p className="text-xs font-semibold text-gray-600 mb-1">Location Breakdown:</p>
                                                <div className="space-y-1">
                                                  {batch.locations.map((loc, locIdx) => {
                                                    // Format location quantity with × notation
                                                    const formatLocationQuantity = () => {
                                                      if (!batch.itemsPerBox) {
                                                        return `${loc.quantity} ${pluralizeUnit(loc.quantity, med.unit)}`;
                                                      }
                                                      const fullBoxes = Math.floor(loc.quantity / batch.itemsPerBox);
                                                      const looseItems = loc.quantity % batch.itemsPerBox;

                                                      if (fullBoxes === 0) {
                                                        return `${looseItems} ${pluralizeUnit(looseItems, med.unit)} (from open box)`;
                                                      } else if (looseItems === 0) {
                                                        return `${fullBoxes} ${fullBoxes === 1 ? 'box' : 'boxes'} × ${batch.itemsPerBox} items per box`;
                                                      } else {
                                                        return `${fullBoxes} ${fullBoxes === 1 ? 'box' : 'boxes'} × ${batch.itemsPerBox} items per box + ${looseItems} ${pluralizeUnit(looseItems, med.unit)}`;
                                                      }
                                                    };
                                                    return (
                                                    <div key={locIdx} className="flex items-center justify-between text-xs">
                                                      <div className="flex items-center gap-2">
                                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded font-medium">{loc.location}</span>
                                                        <span className="text-gray-700">{formatLocationQuantity()}</span>
                                                      </div>
                                                      <button onClick={() => {
                                                        const targetMed = med.originalMeds.find(m => m.location === loc.location);
                                                        const targetBatch = targetMed?.batches.find(b => 
                                                          b.expiryDate === batch.expiryDate && 
                                                          b.batchNumber === batch.batchNumber &&
                                                          b.brand === batch.brand
                                                        );
                                                        if (targetMed && targetBatch) {
                                                          setBatchRemoval({ batch: { med: targetMed, batch: targetBatch }, password: '', reason: '', customReason: '', error: '' });
                                                        }
                                                      }} className="bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 transition-colors text-xs">Remove</button>
                                                    </div>
                                                    );
                                                  })}
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        );
                                      })}
                                    </div>
                                    {hasPendingOrder(med) && (
                                      <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                                          <p className="text-sm font-semibold text-blue-900 mb-1"><Download className="w-4 h-4 inline mr-1" />Order Status: Pending</p>
                                        {(() => {
                                          const order = getMostRecentOrder(med);
                                          if (order) {
                                            return (
                                              <div className="text-xs text-blue-800">
                                                <p>Order Date: {new Date(order.orderedAt).toLocaleString('en-GB')}</p>
                                                <p>Quantity: {(() => {
                                                  const qty = order.quantity;
                                                  const itemsPerBox = med.standardItemsPerBox;
                                                  if (itemsPerBox && qty >= itemsPerBox) {
                                                    const boxes = Math.floor(qty / itemsPerBox);
                                                    const loose = qty % itemsPerBox;
                                                    if (loose > 0) {
                                                      return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${itemsPerBox} items per box + ${loose} ${pluralizeUnit(loose, med.unit)}`;
                                                    }
                                                    return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${itemsPerBox} items per box`;
                                                  }
                                                  return `${qty} ${pluralizeUnit(qty, med.unit)}`;
                                                })()}</p>
                                                <p>Urgency: {order.urgency.toUpperCase()}</p>
                                                <p>Ordered by: {order.user}</p>
                                                {order.notes && <p className="mt-1">Notes: {order.notes}</p>}
                                              </div>
                                            );
                                          }
                                        })()}
                                      </div>
                                    )}
                                  </div>
                                </td>
                              </tr>
                            )}
                            </React.Fragment>
                          );
                        })}
                      </tbody>
                    </table>
                    {displayMedications.length === 0 && (
                      <div className="p-8 text-center text-gray-500">
                        <p className="text-lg font-medium">No medications found</p>
                          <p className="text-sm mt-1">{ui.searchTerm ? 'Try adjusting your search term' : `No medications currently stored at ${ui.currentLocation}`}</p>
                      </div>
                    )}
                  </div>
                </>
              )}

                {/* Activity Log Tab */}
              {ui.activeTab === 'transactions' && (
                <>
                  <div className="p-4 border-b bg-gray-50 relative z-0">
                    <div className="flex justify-between items-start mb-3">
                      <p className="text-sm font-medium text-gray-700">Filter by Activity Type:</p>
                      <div className="flex gap-2">
                          <button onClick={() => setActivityLogFilters(['delivery', 'dispensing', 'transfer', 'order', 'order_fulfilled', 'removal', 'system'])} className="text-xs text-cyan-600 hover:text-cyan-700 font-medium underline">Select All</button>
                        <span className="text-gray-400">|</span>
                          <button onClick={() => setActivityLogFilters([])} className="text-xs text-gray-600 hover:text-gray-700 font-medium underline">Deselect All</button>
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {ACTIVITY_FILTERS.map(filter => (
                          <button key={filter.id} onClick={() => { if (activityLogFilters.includes(filter.id)) { setActivityLogFilters(activityLogFilters.filter(f => f !== filter.id)); } else { setActivityLogFilters([...activityLogFilters, filter.id]); } }} className={`px-3 py-1.5 rounded-lg text-xs font-medium border-2 transition-all ${activityLogFilters.includes(filter.id) ? filter.color : 'bg-white text-gray-400 border-gray-200'}`}>{filter.label}</button>
                      ))}
                    </div>
                  </div>
                  
                  <div className="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                  {(() => {
                        // Compute category once and filter
                        const transactionsWithCategory = filteredTransactions.map(trans => ({
                          ...trans,
                          _category: categorizeTransaction(trans, LOCATIONS)
                        }));
                        const filteredByType = transactionsWithCategory.filter(trans => activityLogFilters.includes(trans._category));
                    
                    // Combine transfer pairs into single entries
                    const processedTransactions = [];
                    const usedIds = new Set();
                    
                    filteredByType.forEach(trans => {
                      if (usedIds.has(trans.id)) return;
                      
                      // Check if this is part of a transfer pair
                      const isTransferOut = trans.type === 'out' && trans.note && trans.note.includes('Transfer to');
                      const isTransferIn = trans.type === 'in' && trans.note && trans.note.includes('Transfer from');
                      
                      if (isTransferOut || isTransferIn) {
                        // Find matching transfer transaction
                        const match = filteredByType.find(t => 
                          t.id !== trans.id &&
                          !usedIds.has(t.id) &&
                          t.medId === trans.medId &&
                          Math.abs(new Date(t.timestamp) - new Date(trans.timestamp)) < 2000 && // Within 2 seconds
                          ((isTransferOut && t.type === 'in' && t.note && t.note.includes('Transfer from')) ||
                           (isTransferIn && t.type === 'out' && t.note && t.note.includes('Transfer to')))
                        );
                        
                        if (match) {
                          // Combine into single transfer entry
                          const sourceLocation = isTransferOut ? trans.location : match.location;
                          const targetLocation = isTransferOut ? match.location : trans.location;
                          const transferNote = trans.note || match.note;
                          
                          // Extract quantity and brand from note
                          const quantityMatch = transferNote.match(/(\d+.*?)(?:\s-\s|$)/);
                          const brandMatch = transferNote.match(/Brand:\s*([^-]+)/);
                          const quantity = quantityMatch ? quantityMatch[1].trim() : trans.amount;
                          const brand = brandMatch ? brandMatch[1].trim() : '';
                          
                          processedTransactions.push({
                            ...trans,
                            id: `transfer-${trans.id}-${match.id}`,
                            type: 'transfer',
                            location: `${sourceLocation} to ${targetLocation}`,
                            note: `Quantity: ${quantity}${brand ? ` - Brand: ${brand}` : ''}`,
                            originalAmount: trans.amount,
                            timestamp: trans.timestamp, // Use earlier timestamp
                            user: trans.user
                          });
                          usedIds.add(trans.id);
                          usedIds.add(match.id);
                          return;
                        }
                      }
                      
                      // Not a transfer pair, add as-is
                      processedTransactions.push(trans);
                      usedIds.add(trans.id);
                    });
                    
                    const groupedByDate = processedTransactions.reduce((groups, trans) => {
                      const date = new Date(trans.timestamp);
                          const dateKey = date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                      if (!groups[dateKey]) groups[dateKey] = [];
                      groups[dateKey].push(trans);
                      return groups;
                    }, {});
                        const sortedDates = Object.keys(groupedByDate).sort((a, b) => { const dateA = new Date(groupedByDate[a][0].timestamp); const dateB = new Date(groupedByDate[b][0].timestamp); return dateB - dateA; });
                    if (sortedDates.length === 0) {
                      return (
                        <div className="p-8 text-center text-gray-500">
                          <p className="text-lg font-medium">No Activities found</p>
                          <p className="text-sm mt-1">Try adjusting your filters</p>
                        </div>
                      );
                    }
                    return sortedDates.map(dateKey => {
                      const isCollapsed = collapsedDates.includes(dateKey);
                      return (
                        <div key={dateKey}>
                              <button onClick={() => { if (isCollapsed) { setCollapsedDates(collapsedDates.filter(d => d !== dateKey)); } else { setCollapsedDates([...collapsedDates, dateKey]); } }} className="w-full bg-slate-100 px-4 py-2 sticky top-0 hover:bg-slate-200 transition-colors text-left flex items-center justify-between">
                            <h3 className="text-sm font-bold text-slate-700">{dateKey}</h3>
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-slate-600">({groupedByDate[dateKey].length} {groupedByDate[dateKey].length === 1 ? 'Activity' : 'Activities'})</span>
                              <span className="text-slate-700">{isCollapsed ? '▼' : '▲'}</span>
                            </div>
                          </button>
                          {!isCollapsed && groupedByDate[dateKey].map(trans => {
                            const category = trans._category || categorizeTransaction(trans, LOCATIONS);
                            const isOrderFulfilled = category === 'order_fulfilled';
                            const isBatchRemoval = category === 'removal';
                            // Ensure amount is a number and strip any existing signs
                            const amountValue = Math.abs(typeof trans.amount === 'string' ? parseFloat(trans.amount.replace(/^[+-]/, '')) || 0 : trans.amount || 0);
                            return (
                            <div key={trans.id} className="p-4 hover:bg-gray-50">
                              <div className="flex justify-between items-start mb-1">
                                <span className="font-medium text-gray-900">{trans.medName}</span>
                                {isBatchRemoval ? (
                                  <div className="bg-red-100 text-red-800 px-3 py-2 rounded border border-red-300 text-right">
                                    <div className="text-xs font-bold uppercase">Batch Removed</div>
                                    <div className="text-lg font-bold mt-1">{amountValue}</div>
                                  </div>
                                ) : (
                                    <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${trans.type === 'transfer' ? 'bg-blue-100 text-blue-800' : isOrderFulfilled ? 'bg-emerald-100 text-emerald-800' : trans.type === 'in' ? 'bg-green-100 text-green-800' : trans.type === 'delete' ? 'bg-red-100 text-red-800' : trans.type === 'order' ? 'bg-blue-100 text-blue-800' : 'bg-cyan-100 text-cyan-800'}`}>
                                      {trans.type === 'transfer' ? <Download className="w-3 h-3 mr-1" /> : isOrderFulfilled ? <Download className="w-3 h-3 mr-1" /> : trans.type === 'in' ? <Plus className="w-3 h-3 mr-1" /> : trans.type === 'delete' ? <AlertTriangle className="w-3 h-3 mr-1" /> : trans.type === 'order' ? <Download className="w-3 h-3 mr-1" /> : <Minus className="w-3 h-3 mr-1" />}
                                      {trans.type === 'transfer' ? 'TRANSFER' : isOrderFulfilled ? 'FULFILLED' : trans.type === 'delete' ? 'DELETED' : trans.type === 'order' ? 'ORDERED' : trans.type === 'in' ? `+${amountValue}` : `-${amountValue}`}
                                </span>
                                )}
                              </div>
                              <div className="text-sm text-gray-600">
                                <p><span className="font-medium">Location:</span> {trans.location}</p>
                                {trans.note && <p className="mt-1">{trans.note}</p>}
                                <p className="text-xs mt-1">{trans.user} • {new Date(trans.timestamp).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit' })}</p>
                              </div>
                            </div>
                            );
                          })}
                        </div>
                      );
                    });
                  })()}
                  </div>
                </>
              )}

                {/* Low Stock Tab */}
              {ui.activeTab === 'lowstock' && (
                <>
                  <div className="p-4 bg-amber-50 border-b border-amber-200 mt-2">
                    <div className="flex items-center">
                      <AlertTriangle className="w-5 h-5 text-amber-600 mr-2" />
                      <div className="flex-1">
                          <h3 className="font-semibold text-amber-800">{lowStockMedications.length} Medication{lowStockMedications.length !== 1 ? 's' : ''} Below Minimum Level</h3>
                          <p className="text-sm text-amber-700">These medications require immediate ordering attention.</p>
                      </div>
                        {hasAccessTo('intelligenceReport') && (
                          <button onClick={() => setModals(prev => ({ ...prev, showIntelligenceReport: true }))} className="flex items-center bg-cyan-600 text-white px-4 py-2 rounded hover:bg-cyan-700 transition-colors text-sm mr-2">
                            <TrendingUp className="w-4 h-4 mr-2" />
                            Intelligence Report
                          </button>
                        )}
                        {hasAccessTo('exportSimpleReport') && (
                          <button onClick={exportLowStockReport} className="flex items-center bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700 transition-colors text-sm">
                            <Download className="w-4 h-4 mr-2" />
                            Export Simple Report
                          </button>
                        )}
                    </div>
                  </div>
                  
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Medication</th>
                            {(ui.currentLocation === 'All' || isGroupName(ui.currentLocation, locations)) && (<th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Location</th>)}
                          <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Current Stock</th>
                          <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Min Level</th>
                          <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Suggested Order</th>
                          <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Action</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {lowStockMedications.sort((a, b) => a.name.localeCompare(b.name)).map(med => {
                          // Use composite key: medication_name|strength_raw|type|location for stable identity
                          const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                          return (
                            <tr key={stableKey} className="hover:bg-gray-50">
                            <td className="px-4 py-3 text-sm text-gray-900">
                              <div className="flex items-center gap-2">
                                <span>{med.name}</span>
                                  {getTotalBoxes(med) === 0 && hasPendingOrder(med) ? (
                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><Download className="w-3 h-3 mr-1" />Order Pending</span>
                                  ) : hasPendingOrder(med) && (
                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><Download className="w-3 h-3 mr-1" />Ordered</span>
                                  )}
                              </div>
                            </td>
                              {(ui.currentLocation === 'All' || isGroupName(ui.currentLocation, locations)) && (
                                <td className="px-4 py-3 text-sm text-gray-700">
                                  {ui.currentLocation === 'All' && med.locations && med.locations.length > 1 ? (
                                    <div className="flex flex-wrap gap-1">
                                      {med.locations.sort().map((loc, idx) => (
                                        <span key={idx} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{loc}</span>
                                      ))}
                                    </div>
                                  ) : (
                                    med.location
                                  )}
                                </td>
                              )}
                              <td className="px-4 py-3 text-sm text-center"><span className="font-semibold text-red-600">{formatStockDisplay(med)}</span></td>
                            <td className="px-4 py-3 text-sm text-gray-600 text-center">{formatMinLevelDisplay(med)}</td>
                            <td className="px-4 py-3 text-sm text-center">
                              <span className="font-semibold text-blue-600">
                                {(() => {
                                  const currentBoxes = getTotalBoxes(med);
                                  const suggestedBoxes = Math.max(0, med.minLevelBoxes - currentBoxes);
                                  return `${suggestedBoxes} ${suggestedBoxes === 1 ? 'box' : 'boxes'}`;
                                })()}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-center">
                                <button onClick={() => {
                                  const currentBoxes = getTotalBoxes(med);
                                  const suggestedBoxes = Math.max(0, med.minLevelBoxes - currentBoxes);
                                  const batchWithBoxes = med.batches.find(b => b.itemsPerBox);
                                  const finalQty = batchWithBoxes ? suggestedBoxes * batchWithBoxes.itemsPerBox : suggestedBoxes;
                                  setOrderForm({ med, quantity: finalQty.toString(), urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk' });
                                }} className={`${hasPendingOrder(med) ? 'bg-blue-500 hover:bg-blue-600' : 'bg-cyan-500 hover:bg-cyan-600'} text-white px-3 py-1 rounded text-sm transition-colors font-medium`}>
                                {hasPendingOrder(med) ? 'Re-order' : 'Order'}
                              </button>
                            </td>
                          </tr>
                          );
                        })}
                      </tbody>
                    </table>
                    {lowStockMedications.length === 0 && (
                      <div className="p-8 text-center text-gray-500">
                        <p className="text-lg font-medium">No low stock items</p>
                        <p className="text-sm mt-1">All medications are above minimum stock levels</p>
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* New Medication Order Tab */}
              {ui.activeTab === 'newmedication' && (
                <div className="p-6">
                  <div className="max-w-2xl mx-auto">
                    <div className="bg-gradient-to-r from-cyan-50 to-blue-50 border border-cyan-200 rounded-lg p-6 mb-6">
                      <h2 className="text-2xl font-bold text-gray-800 mb-2">Order New Medication</h2>
                      <p className="text-gray-600">Request a new medication that is not currently in the stock system.</p>
            </div>

                    <div className="bg-white rounded-lg shadow-md p-6">
                      <form onSubmit={(e) => { e.preventDefault(); handleNewMedicationOrder(); }}>
                        {newMedicationOrderForm.error && (
                          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p className="text-sm text-red-600">{newMedicationOrderForm.error}</p>
                          </div>
                        )}

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Medication Name <span className="text-red-600">*</span>
                          </label>
                          <input
                            type="text"
                            value={newMedicationOrderForm.name}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, name: e.target.value, error: '' }))}
                            placeholder="e.g., Amoxicillin"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Type <span className="text-red-600">*</span>
                          </label>
                          <select
                            value={newMedicationOrderForm.type}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, type: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                          >
                            {MEDICATION_TYPES.map(type => (
                              <option key={type} value={type}>{type}</option>
                            ))}
                          </select>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Strength/Concentration <span className="text-red-600">*</span>
                          </label>
                          <input
                            type="text"
                            value={newMedicationOrderForm.strength}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, strength: e.target.value, error: '' }))}
                            placeholder="e.g., 500mg"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Quantity Needed <span className="text-red-600">*</span>
                          </label>
                          <input
                            type="text"
                            value={newMedicationOrderForm.quantityNeeded}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, quantityNeeded: e.target.value, error: '' }))}
                            placeholder="e.g., 5 boxes, 100 tablets, 3 vials"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                          />
                          <p className="text-xs text-gray-500 mt-1">Enter the quantity needed in any format (numbers, letters, or both)</p>
                        </div>

                        {newMedicationOrderForm.type === 'IV Fluid Bag' && (
                          <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Bag Size <span className="text-red-600">*</span>
                            </label>
                            <input
                              type="text"
                              value={newMedicationOrderForm.bagSize}
                              onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, bagSize: e.target.value, error: '' }))}
                              placeholder="e.g., 500ml, 1000ml"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                            />
                          </div>
                        )}

                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Urgency</label>
                          <select
                            value={newMedicationOrderForm.urgency}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, urgency: e.target.value }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                          >
                            <option value="routine">Routine</option>
                            <option value="urgent">Urgent</option>
                            <option value="emergency">Emergency</option>
                          </select>
                        </div>

                        <div className="mb-6">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
                          <textarea
                            value={newMedicationOrderForm.notes}
                            onChange={(e) => setNewMedicationOrderForm(prev => ({ ...prev, notes: e.target.value }))}
                            placeholder="Any additional information or special requirements..."
                            rows="3"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent resize-none"
                          />
                        </div>

                        <div className="flex gap-3">
                          <button
                            type="submit"
                            className="flex-1 bg-cyan-500 text-white py-3 rounded-lg hover:bg-cyan-600 transition-colors font-medium"
                          >
                            Review Order
                          </button>
                          <button
                            type="button"
                            onClick={() => setNewMedicationOrderForm({ name: '', type: 'Tablet', strength: '', quantityNeeded: '', bagSize: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk', error: '' })}
                            className="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors font-medium"
                          >
                            Clear Form
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

            {/* Adjust Stock Modal */}
          {modals.showAdjustStock && ui.selectedMed && !modals.showFefoOverride && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showAdjustStock: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
              <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                  <h2 className="text-base sm:text-lg font-bold text-gray-800">Adjust Stock</h2>
                  <p className="text-xs text-gray-600 mt-1">Location: {ui.selectedMed.location}</p>
                </div>
                <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {adjustmentForm.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{adjustmentForm.error}</div>)}
                <div className="mb-4 p-3 bg-gray-50 border border-gray-200 rounded">
                  <p className="text-sm font-medium text-gray-900 mb-1">{ui.selectedMed.name}</p>
                  <p className="text-lg font-bold text-gray-900">Current Stock: {formatStockDisplay(ui.selectedMed)}</p>
                  <p className="text-xs text-gray-600">Minimum Level: {formatMinLevelDisplay(ui.selectedMed)}</p>
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
                  <div className="flex gap-4 mb-4">
                    <label className="flex items-center cursor-pointer">
                      <input 
                        type="radio" 
                        name="adjustmentAction" 
                        value="out" 
                        checked={adjustmentForm.action === 'out'} 
                        onClick={(e) => { 
                          setAdjustmentForm(prev => ({ ...prev, action: 'out', stockInSource: 'transfer', transferBatchOption: 'existing', stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' })); 
                        }} 
                        className="mr-2" 
                      />
                      Transfer Location
                    </label>
                    {getUserRole() !== 'Basic User' && (
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="adjustmentAction" 
                          value="in" 
                          checked={adjustmentForm.action === 'in'} 
                          onClick={(e) => { 
                            setAdjustmentForm(prev => ({ ...prev, action: 'in', stockInSource: 'delivery', deliveryBatchOption: 'new', error: '' })); 
                          }} 
                          className="mr-2" 
                        />
                        Stock In (Add)
                      </label>
                    )}
                    {getUserRole() === 'Basic User' && (
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="adjustmentAction" 
                          value="in" 
                          checked={adjustmentForm.action === 'in'} 
                          onClick={(e) => { 
                            setAdjustmentForm(prev => ({ ...prev, action: 'in', stockInSource: 'transfer', transferBatchOption: 'existing', error: '' })); 
                          }} 
                          className="mr-2" 
                        />
                        Receive Transfer
                      </label>
                    )}
                  </div>
                </div>

                {adjustmentForm.action === 'out' && ui.currentLocation !== 'All' && ui.currentLocation !== 'Medication Stock L1' && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Stock Out Purpose</label>
                    <div className="flex gap-4 mb-3">
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="stockOutPurpose" 
                          value="transfer" 
                          checked={adjustmentForm.stockOutPurpose === 'transfer'} 
                          onClick={(e) => { 
                            setAdjustmentForm(prev => ({ ...prev, stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' })); 
                          }} 
                          className="mr-2" 
                        />
                        Transfer Location
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="stockOutPurpose" 
                          value="patient" 
                          checked={adjustmentForm.stockOutPurpose === 'patient'} 
                          onClick={(e) => { 
                            setAdjustmentForm(prev => ({ ...prev, stockOutPurpose: 'patient', patientLastName: '', patientLocalId: '', useReason: '', error: '' })); 
                          }} 
                          className="mr-2" 
                        />
                        Patient Use
                      </label>
                    </div>
                  </div>
                )}

                {adjustmentForm.action === 'in' && (
                  <>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Stock Source</label>
                      <div className="flex gap-4 mb-3">
                        {getUserRole() !== 'Basic User' && (
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="stockInSource" 
                              value="delivery" 
                              checked={adjustmentForm.stockInSource === 'delivery'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, stockInSource: 'delivery', batchId: '', sourceDepartment: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            New Delivery
                          </label>
                        )}
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="stockInSource" 
                            value="transfer" 
                            checked={adjustmentForm.stockInSource === 'transfer'} 
                            onClick={(e) => { 
                              setAdjustmentForm(prev => ({ ...prev, stockInSource: 'transfer', transferBatchOption: 'existing', batchId: '', sourceDepartment: '', error: '' }));
                            }} 
                            className="mr-2" 
                          />
                          Internal Transfer
                        </label>
                      </div>
                    </div>

                    {adjustmentForm.stockInSource === 'transfer' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Batch Option</label>
                        <div className="flex gap-4 mb-3">
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="transferBatchOption" 
                              value="existing" 
                              checked={adjustmentForm.transferBatchOption === 'existing'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, transferBatchOption: 'existing', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            Add to Existing Batch
                          </label>
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="transferBatchOption" 
                              value="new" 
                              checked={adjustmentForm.transferBatchOption === 'new'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, transferBatchOption: 'new', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            New Batch
                          </label>
                        </div>
                      </div>
                    )}

                    {adjustmentForm.stockInSource === 'delivery' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Batch Option</label>
                        <div className="flex gap-4 mb-3">
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="deliveryBatchOption" 
                              value="new" 
                              checked={adjustmentForm.deliveryBatchOption === 'new'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, deliveryBatchOption: 'new', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            New Batch
                          </label>
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="deliveryBatchOption" 
                              value="existing" 
                              checked={adjustmentForm.deliveryBatchOption === 'existing'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, deliveryBatchOption: 'existing', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            Add to Existing Batch
                          </label>
                        </div>
                      </div>
                    )}

                    {adjustmentForm.stockInSource === 'transfer' && (
                      <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Department (Stock Coming From) <span className="text-red-600">*</span></label>
                            <select value={adjustmentForm.sourceDepartment} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, sourceDepartment: e.target.value, batchId: '' })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                          <option value="">Select department...</option>
                          {(() => {
                            // Group locations by groupName
                            const grouped = {};
                            locations.forEach(loc => {
                              if (loc.groupName) {
                                if (!grouped[loc.groupName]) grouped[loc.groupName] = [];
                                grouped[loc.groupName].push(loc);
                              } else {
                                if (!grouped['_ungrouped']) grouped['_ungrouped'] = [];
                                grouped['_ungrouped'].push(loc);
                              }
                            });

                            const elements = [];
                            // Render grouped locations
                            Object.keys(grouped).forEach(groupName => {
                              if (groupName !== '_ungrouped') {
                                elements.push(
                                  <optgroup key={groupName} label={groupName}>
                                    {grouped[groupName].map(location => {
                                      // Check if location has the same medication (name, strength, type)
                                      const medInLocation = medications.find(m =>
                                        m.medicationName === ui.selectedMed.medicationName &&
                                        m.strengthRaw === ui.selectedMed.strengthRaw &&
                                        m.type === ui.selectedMed.type &&
                                        m.location === location.displayName
                                      );
                                      const hasBatches = medInLocation && medInLocation.batches.length > 0 && location.displayName !== ui.selectedMed.location;
                                      return (
                                        <option key={location.id} value={location.displayName} style={hasBatches ? { color: '#059669', fontWeight: '600' } : {}}>
                                          {location.displayName}{hasBatches ? ' ✓' : ''}
                                        </option>
                                      );
                                    })}
                                  </optgroup>
                                );
                              }
                            });
                            // Render ungrouped locations
                            if (grouped['_ungrouped']) {
                              grouped['_ungrouped'].forEach(location => {
                                const medInLocation = medications.find(m =>
                                  m.medicationName === ui.selectedMed.medicationName &&
                                  m.strengthRaw === ui.selectedMed.strengthRaw &&
                                  m.type === ui.selectedMed.type &&
                                  m.location === location.displayName
                                );
                                const hasBatches = medInLocation && medInLocation.batches.length > 0 && location.displayName !== ui.selectedMed.location;
                                elements.push(
                                  <option key={location.id} value={location.displayName} style={hasBatches ? { color: '#059669', fontWeight: '600' } : {}}>
                                    {location.displayName}{hasBatches ? ' ✓' : ''}
                                  </option>
                                );
                              });
                            }
                            return elements;
                          })()}
                        </select>
                            <p className="text-xs text-gray-500 mt-1"><span className="text-green-600 font-semibold">Green departments ✓</span> contain batches of {ui.selectedMed.name}</p>
                      </div>
                    )}
                  </>
                )}

                {((adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'transfer') || (adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing') || (adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'existing')))) && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Select Batch <span className="text-red-600">*</span></label>
                        <select value={adjustmentForm.batchId} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, batchId: e.target.value, error: '' })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                      <option value="">Select batch...</option>
                      {(() => {
                        let batchSource = ui.selectedMed;
                        if (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing' && adjustmentForm.sourceDepartment) {
                              const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
                              if (!sourceMed) { return (<option value="" disabled>No batches available - {ui.selectedMed.name} does not exist in {adjustmentForm.sourceDepartment}</option>); }
                          batchSource = sourceMed;
                        }
                            return batchSource.batches.sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01')).map((batch, idx) => {
                            const formattedExpiry = formatExpiry(batch.expiryDate);
                            const batchDetails = formatBatchDetails(batch, batchSource.unit);
                              return (<option key={batch.id} value={batch.id}>Batch {idx + 1}: {batch.brand} - {batchDetails} - Exp: {formattedExpiry}</option>);
                          });
                      })()}
                    </select>
                  </div>
                )}

                {adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new')) ? (
                  <>
                    <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                          <p className="text-sm text-blue-800">{adjustmentForm.stockInSource === 'delivery' ? 'Adding new stock from delivery. Enter the batch details below.' : 'Adding stock from a new batch. Enter the batch details below.'}</p>
                    </div>
                    {ui.selectedMed.batches.length > 0 && (
                      <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded">
                        <p className="text-sm font-semibold text-amber-800 mb-2">Existing Batches for {ui.selectedMed.name}:</p>
                        <div className="space-y-1">
                          {ui.selectedMed.batches.sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01')).map((batch, idx) => (
                            <div key={batch.id} className="text-xs text-amber-900 bg-white p-2 rounded">
                              <span className="font-medium">Batch {idx + 1}:</span>
                              {batch.batchNumber && <span className="ml-2">#{batch.batchNumber}</span>}
                              <span className="ml-2">• Exp: {formatExpiry(batch.expiryDate)}</span>
                            </div>
                          ))}
                        </div>
                        <p className="text-xs text-amber-700 mt-2">⚠️ Only create a new batch if the batch number or expiry date differs from above</p>
                      </div>
                    )}
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Brand <span className="text-red-600">*</span></label>
                          <input type="text" list="adjustBrandList" value={deliveryForm.brand} onChange={(e) => setDeliveryForm(prev => ({ ...prev, brand: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. Actavis, Accord, Teva" />
                          <datalist id="adjustBrandList">
                            {[...new Set(ui.selectedMed.batches.map(b => b.brand))].map(brand => (
                              <option key={brand} value={brand} />
                            ))}
                          </datalist>
                          <p className="text-xs text-gray-500 mt-1">Select an existing brand or type a new one</p>
                    </div>
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Batch Number</label>
                          <input type="text" value={deliveryForm.batchNumber} onChange={(e) => setDeliveryForm(prev => ({ ...prev, batchNumber: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. BN123456" />
                    </div>
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Expiry Date <span className="text-red-600">*</span></label>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Month</label>
                              <select value={deliveryForm.expiryMonth} onChange={(e) => setDeliveryForm(prev => ({ ...prev, expiryMonth: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="">Select...</option>
                                {['January','February','March','April','May','June','July','August','September','October','November','December'].map((month, idx) => (<option key={month} value={String(idx + 1).padStart(2, '0')}>{month}</option>))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Year</label>
                          <div className="flex items-center gap-2">
                                <button type="button" onClick={() => setDeliveryForm(prev => { const year = prev.expiryYear ? parseInt(prev.expiryYear) : new Date().getFullYear(); return { ...prev, expiryYear: String(year - 1) }; })} className="text-slate-700 hover:text-slate-900 text-2xl leading-none p-0 border-0 bg-transparent">←</button>
                                <input type="number" value={deliveryForm.expiryYear} onChange={(e) => setDeliveryForm(prev => ({ ...prev, expiryYear: e.target.value }))} placeholder={String(new Date().getFullYear())} className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-center" min="2024" max="2099" />
                                <button type="button" onClick={() => setDeliveryForm(prev => { const year = prev.expiryYear ? parseInt(prev.expiryYear) : new Date().getFullYear(); return { ...prev, expiryYear: String(year + 1) }; })} className="text-slate-700 hover:text-slate-900 text-2xl leading-none p-0 border-0 bg-transparent">→</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                      <div className="flex gap-4">
                            <label className="flex items-center cursor-pointer">
                              <input 
                                type="radio" 
                                name="deliveryQuantityType" 
                                value="boxes" 
                                checked={deliveryForm.quantityType === 'boxes'} 
                                onClick={(e) => {
                                  setDeliveryForm(prev => ({ ...prev, quantityType: 'boxes', boxQuantity: '', itemsPerBox: '' }));
                                }} 
                                className="mr-2" 
                              />
                              Boxes
                            </label>
                            <label className="flex items-center cursor-pointer">
                              <input 
                                type="radio" 
                                name="deliveryQuantityType" 
                                value="individual" 
                                checked={deliveryForm.quantityType === 'individual'} 
                                onClick={(e) => {
                                  setDeliveryForm(prev => ({ ...prev, quantityType: 'individual', individualQuantity: '' }));
                                }} 
                                className="mr-2" 
                              />
                              Individual {getIndividualUnitLabel(ui.selectedMed.unit)}
                            </label>
                      </div>
                    </div>
                    {deliveryForm.quantityType === 'boxes' ? (
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Number of {deliveryForm.boxQuantity && parseInt(deliveryForm.boxQuantity) === 1 ? 'Box' : 'Boxes'} <span className="text-red-600">*</span>
                              </label>
                              <input type="number" value={deliveryForm.boxQuantity} onChange={(e) => setDeliveryForm(prev => ({ ...prev, boxQuantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 5" min="1" />
                        </div>
                        <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Items per Box <span className="text-red-600">*</span></label>
                              <input 
                                type="number" 
                                value={deliveryForm.itemsPerBox} 
                                onChange={(e) => {
                                  if (!deliveryForm.batchLocked) {
                                    setDeliveryForm(prev => ({ ...prev, itemsPerBox: e.target.value }));
                                  }
                                }}
                                readOnly={deliveryForm.batchLocked}
                                className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${deliveryForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                placeholder="e.g. 100" 
                                min="1" 
                              />
                        </div>
                        {deliveryForm.boxQuantity && deliveryForm.itemsPerBox && (
                          <div className="col-span-2 p-2 bg-blue-50 border border-blue-200 rounded">
                                <p className="text-sm text-blue-800">Total: <span className="font-bold">{parseInt(deliveryForm.boxQuantity) * parseInt(deliveryForm.itemsPerBox)} {ui.selectedMed.unit}</span></p>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                            <input type="number" value={deliveryForm.individualQuantity} onChange={(e) => setDeliveryForm(prev => ({ ...prev, individualQuantity: e.target.value }))} onClick={(e) => e.stopPropagation()} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter quantity" min="1" />
                      </div>
                    )}
                  </>
                ) : (
                  ((adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'transfer') || (adjustmentForm.action === 'in' && ((adjustmentForm.transferBatchOption === 'existing' && adjustmentForm.stockInSource === 'transfer') || (adjustmentForm.deliveryBatchOption === 'existing' && adjustmentForm.stockInSource === 'delivery')))) && adjustmentForm.batchId && (
                    <>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                        <div className="flex gap-4 mb-3">
                          {(() => {
                            let batchToCheck = null;
                            if (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing' && adjustmentForm.sourceDepartment) {
                                  const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
                              batchToCheck = sourceMed?.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
                            } else {
                              batchToCheck = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
                            }
                            return (
                              <>
                                {batchToCheck?.itemsPerBox && (
                                      <label className="flex items-center cursor-pointer">
                                        <input 
                                          type="radio" 
                                          name="adjustmentType" 
                                          value="boxes" 
                                          checked={adjustmentForm.type === 'boxes'} 
                                          onClick={(e) => {
                                            setAdjustmentForm(prev => ({ ...prev, type: 'boxes', amount: '' }));
                                          }} 
                                          className="mr-2" 
                                        />
                                        Whole Boxes
                                      </label>
                                    )}
                                    <label className="flex items-center cursor-pointer">
                                      <input 
                                        type="radio" 
                                        name="adjustmentType" 
                                        value="individual" 
                                        checked={adjustmentForm.type === 'individual'} 
                                        onClick={(e) => { 
                                          setAdjustmentForm(prev => ({ ...prev, type: 'individual', amount: '' }));
                                        }} 
                                        className="mr-2" 
                                      />
                                      Individual {getIndividualUnitLabel(ui.selectedMed.unit)}
                                    </label>
                              </>
                            );
                          })()}
                        </div>
                      </div>
                      <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                            <input type="number" value={adjustmentForm.amount} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, amount: e.target.value })); }} onClick={(e) => e.stopPropagation()} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder={adjustmentForm.type === 'boxes' ? 'Enter number of boxes' : 'Enter amount'} min="1" />
                        {adjustmentForm.type === 'boxes' && adjustmentForm.amount && adjustmentForm.batchId && (() => {
                          let itemsPerBox = 0;
                          if (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing' && adjustmentForm.sourceDepartment) {
                                const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
                            itemsPerBox = sourceMed?.batches.find(b => b.id === parseInt(adjustmentForm.batchId))?.itemsPerBox || 0;
                          } else {
                            itemsPerBox = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId))?.itemsPerBox || 0;
                          }
                              return (<p className="text-sm text-gray-600 mt-2">= {parseInt(adjustmentForm.amount) * itemsPerBox} {ui.selectedMed.unit}</p>);
                        })()}
                      </div>
                    </>
                  )
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Select Batch <span className="text-red-600">*</span></label>
                        <select value={adjustmentForm.batchId} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, batchId: e.target.value, error: '' })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                      <option value="">Select batch...</option>
                      {ui.selectedMed.batches.map(batch => (
                        <option key={batch.id} value={batch.id}>
                          Brand: {batch.brand}, Expiry: {formatExpiry(batch.expiryDate)}, Qty: {formatBatchDetails(batch, ui.selectedMed.unit)}
                        </option>
                      ))}
                    </select>
                  </div>
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && adjustmentForm.batchId && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                        <div className="flex gap-4 mb-3">
                          {(() => {
                            let batchToCheck = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId));
                            return (
                              <>
                                {batchToCheck?.itemsPerBox && (
                                      <label className="flex items-center cursor-pointer">
                                        <input 
                                          type="radio" 
                                          name="adjustmentType" 
                                          value="boxes" 
                                          checked={adjustmentForm.type === 'boxes'} 
                                          onClick={(e) => {
                                            setAdjustmentForm(prev => ({ ...prev, type: 'boxes', amount: '' }));
                                          }} 
                                          className="mr-2" 
                                        />
                                        Whole Boxes
                                      </label>
                                    )}
                                    <label className="flex items-center cursor-pointer">
                                      <input 
                                        type="radio" 
                                        name="adjustmentType" 
                                        value="individual" 
                                        checked={adjustmentForm.type === 'individual'} 
                                        onClick={(e) => { 
                                          setAdjustmentForm(prev => ({ ...prev, type: 'individual', amount: '' }));
                                        }} 
                                        className="mr-2" 
                                      />
                                      Individual {getIndividualUnitLabel(ui.selectedMed.unit)}
                                    </label>
                              </>
                            );
                          })()}
                        </div>
                      </div>
                    )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && adjustmentForm.batchId && (
                  <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                            <input type="number" value={adjustmentForm.amount} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, amount: e.target.value })); }} onClick={(e) => e.stopPropagation()} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder={adjustmentForm.type === 'boxes' ? 'Enter number of boxes' : 'Enter amount'} min="1" />
                        {adjustmentForm.type === 'boxes' && adjustmentForm.amount && adjustmentForm.batchId && (() => {
                          let itemsPerBox = 0;
                          itemsPerBox = ui.selectedMed.batches.find(b => b.id === parseInt(adjustmentForm.batchId))?.itemsPerBox || 0;
                              return (<p className="text-sm text-gray-600 mt-2">= {parseInt(adjustmentForm.amount) * itemsPerBox} {ui.selectedMed.unit}</p>);
                        })()}
                      </div>
                    )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Patient Last Name <span className="text-red-600">*</span></label>
                        <input type="text" value={adjustmentForm.patientLastName} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, patientLastName: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter patient's last name" />
                  </div>
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Local ID No. <span className="text-red-600">*</span></label>
                        <input type="text" value={adjustmentForm.patientLocalId} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, patientLocalId: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter patient's local ID number" />
                  </div>
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Usage Type</label>
                        <div className="grid grid-cols-1 gap-2">
                          {(() => {
                            const location = ui.currentLocation;
                            let options = [];
                            
                            if (location === 'PACU') {
                              options = [
                                { value: 'post-op', label: 'Post-op use' },
                                { value: 'pain-relief', label: 'Pain relief' },
                                { value: 'nausea', label: 'Nausea' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else if (location.startsWith('Theatre')) {
                              options = [
                                { value: 'anaesthesia', label: 'Anaesthesia' },
                                { value: 'antibiotic-prophylaxis', label: 'Antibiotic prophylaxis' },
                                { value: 'emergency-use', label: 'Emergency use' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else if (location.startsWith('Ward')) {
                              options = [
                                { value: 'regular-dose', label: 'Regular dose' },
                                { value: 'prn-use', label: 'PRN use' },
                                { value: 'tto', label: 'TTOs' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else if (location === 'Sapphire Clinic') {
                              options = [
                                { value: 'pre-op-prep', label: 'Pre-op prep' },
                                { value: 'local-anaesthetic', label: 'Local anaesthetic' },
                                { value: 'post-op-drop', label: 'Post-op drop' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else if (location === 'Radiology') {
                              options = [
                                { value: 'contrast', label: 'Contrast' },
                                { value: 'sedation', label: 'Sedation' },
                                { value: 'allergy-prophylaxis', label: 'Allergy prophylaxis' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else if (location === 'Pharmacy') {
                              options = [
                                { value: 'supply', label: 'Supply' },
                                { value: 'restock', label: 'Re-stock' },
                                { value: 'disposal', label: 'Disposal' },
                                { value: 'other', label: 'Other' }
                              ];
                            } else {
                              // Default options for other locations
                              options = [
                                { value: 'general-use', label: 'General use' },
                                { value: 'emergency', label: 'Emergency use' },
                                { value: 'routine', label: 'Routine use' },
                                { value: 'other', label: 'Other' }
                              ];
                            }
                            
                            return options.map(option => (
                              <label key={option.value} className="flex items-center cursor-pointer">
                                <input 
                                  type="radio" 
                                  name="useReason" 
                                  value={option.value} 
                                  checked={adjustmentForm.useReason === option.value} 
                                  onClick={(e) => { 
                                    setAdjustmentForm(prev => ({ ...prev, useReason: option.value, error: '' })); 
                                  }} 
                                  className="mr-2" 
                                />
                                {option.label}
                              </label>
                            ));
                          })()}
                        </div>
                  </div>
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Additional Details (optional)</label>
                        <input type="text" value={adjustmentForm.note} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, note: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Additional notes (e.g., procedure, ward, special instructions)" />
                  </div>
                )}

                {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'transfer' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Location <span className="text-red-600">*</span></label>
                        <select value={adjustmentForm.location} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, location: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                      <option value="">Select location...</option>
                      {locations.map(location => {
                        const isInternalLocation = true; // All locations from backend are internal
                            // Check if location has the same medication (name, strength, type)
                            const medInLocation = medications.find(m => 
                              m.medicationName === ui.selectedMed.medicationName && 
                              m.strengthRaw === ui.selectedMed.strengthRaw && 
                              m.type === ui.selectedMed.type && 
                              m.location === location.displayName
                            );
                        const hasStock = isInternalLocation && medInLocation && medInLocation.batches.length > 0;
                        return (
                              <option key={location.id} value={location.displayName} style={hasStock ? { color: '#059669', fontWeight: '600' } : {}}>
                            {location.displayName}{hasStock ? ' ✓' : ''}
                          </option>
                        );
                      })}
                    </select>
                        <p className="text-xs text-gray-500 mt-1"><span className="text-green-600 font-semibold">Green locations ✓</span> already have stock of {ui.selectedMed.name}</p>
                  </div>
                )}

                {(adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'transfer') || (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing') || (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'existing') && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Additional Note (optional)</label>
                        <input type="text" value={adjustmentForm.note} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, note: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. Emergency surgery" />
                  </div>
                )}
                </div>
                <div className="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 flex-shrink-0">
                  <div className="flex flex-col sm:flex-row gap-2">
                      {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'transfer' && (<button onClick={() => handleStockAdjustment('out')} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium flex items-center justify-center text-sm"><Minus className="w-4 h-4 mr-1" />Remove Stock</button>)}
                      {adjustmentForm.action === 'out' && adjustmentForm.stockOutPurpose === 'patient' && (<button onClick={() => handleStockAdjustment('out')} className="flex-1 bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors font-medium flex items-center justify-center"><Minus className="w-4 h-4 mr-1" />Record Patient Use</button>)}
                  {adjustmentForm.action === 'in' && (
                        <button onClick={() => handleStockAdjustment('in')} className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center">
                      <Plus className="w-4 h-4 mr-1" />
                          {adjustmentForm.stockInSource === 'delivery' ? (adjustmentForm.deliveryBatchOption === 'new' ? 'Receive Delivery' : 'Add to Batch') : (adjustmentForm.transferBatchOption === 'new' ? 'Add New Batch' : 'Add Stock')}
                    </button>
                  )}
                      <button onClick={resetAdjustmentForms} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Barcode Stock Adjustment Modal */}
            {modals.showBarcodeStockAdjust && ui.selectedMed && !modals.showFefoOverride && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showBarcodeStockAdjust: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
              <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                  <h2 className="text-base sm:text-lg font-bold text-gray-800">Quick Stock Adjustment</h2>
                  <p className="text-xs text-gray-600 mt-1">Scanned: {ui.selectedMed.name} - Location: {ui.selectedMed.location}</p>
                </div>
                <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {adjustmentForm.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{adjustmentForm.error}</div>)}
                <div className="mb-4 p-3 bg-gray-50 border border-gray-200 rounded">
                  <p className="text-sm font-medium text-gray-900 mb-1">{ui.selectedMed.name}</p>
                  <p className="text-lg font-bold text-gray-900">Current Stock: {formatStockDisplay(ui.selectedMed)}</p>
                  <p className="text-xs text-gray-600">Minimum Level: {formatMinLevelDisplay(ui.selectedMed)}</p>
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
                  <div className="flex gap-4 mb-4">
                    <label className="flex items-center cursor-pointer">
                      <input 
                        type="radio" 
                        name="barcodeAdjustmentAction" 
                        value="out" 
                        checked={adjustmentForm.action === 'out'} 
                        onClick={(e) => { 
                          setAdjustmentForm(prev => ({ ...prev, action: 'out', stockInSource: 'transfer', transferBatchOption: 'existing', stockOutPurpose: 'transfer', patientLastName: '', patientLocalId: '', useReason: '', error: '' })); 
                        }} 
                        className="mr-2" 
                      />
                      Transfer Location
                    </label>
                    <label className="flex items-center cursor-pointer">
                      <input 
                        type="radio" 
                        name="barcodeAdjustmentAction" 
                        value="in" 
                        checked={adjustmentForm.action === 'in'} 
                        onClick={(e) => { 
                          setAdjustmentForm(prev => ({ ...prev, action: 'in', stockInSource: 'delivery', deliveryBatchOption: 'new', error: '' })); 
                        }} 
                        className="mr-2" 
                      />
                      Stock In (Add)
                    </label>
                  </div>
                </div>

                {adjustmentForm.action === 'in' && (
                  <>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Stock Source</label>
                      <div className="flex gap-4 mb-3">
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="barcodeStockInSource" 
                            value="delivery" 
                            checked={adjustmentForm.stockInSource === 'delivery'} 
                            onClick={(e) => { 
                              setAdjustmentForm(prev => ({ ...prev, stockInSource: 'delivery', batchId: '', sourceDepartment: '', error: '' }));
                            }} 
                            className="mr-2" 
                          />
                          New Delivery
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="barcodeStockInSource" 
                            value="transfer" 
                            checked={adjustmentForm.stockInSource === 'transfer'} 
                            onClick={(e) => { 
                              setAdjustmentForm(prev => ({ ...prev, stockInSource: 'transfer', transferBatchOption: 'existing', batchId: '', sourceDepartment: '', error: '' }));
                            }} 
                            className="mr-2" 
                          />
                          Internal Transfer
                        </label>
                      </div>
                    </div>

                    {adjustmentForm.stockInSource === 'delivery' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Batch Option</label>
                        <div className="flex gap-4 mb-3">
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="barcodeDeliveryBatchOption" 
                              value="new" 
                              checked={adjustmentForm.deliveryBatchOption === 'new'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, deliveryBatchOption: 'new', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            New Batch
                          </label>
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="barcodeDeliveryBatchOption" 
                              value="existing" 
                              checked={adjustmentForm.deliveryBatchOption === 'existing'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, deliveryBatchOption: 'existing', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            Add to Existing Batch
                          </label>
                        </div>
                      </div>
                    )}

                    {adjustmentForm.stockInSource === 'transfer' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Batch Option</label>
                        <div className="flex gap-4 mb-3">
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="barcodeTransferBatchOption" 
                              value="existing" 
                              checked={adjustmentForm.transferBatchOption === 'existing'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, transferBatchOption: 'existing', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            Add to Existing Batch
                          </label>
                          <label className="flex items-center cursor-pointer">
                            <input 
                              type="radio" 
                              name="barcodeTransferBatchOption" 
                              value="new" 
                              checked={adjustmentForm.transferBatchOption === 'new'} 
                              onClick={(e) => { 
                                setAdjustmentForm(prev => ({ ...prev, transferBatchOption: 'new', batchId: '', error: '' }));
                              }} 
                              className="mr-2" 
                            />
                            New Batch
                          </label>
                        </div>
                      </div>
                    )}

                    {adjustmentForm.stockInSource === 'transfer' && (
                      <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Department (Stock Coming From) <span className="text-red-600">*</span></label>
                            <select value={adjustmentForm.sourceDepartment} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, sourceDepartment: e.target.value, batchId: '' })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                          <option value="">Select department...</option>
                          {(() => {
                            // Group locations by groupName
                            const grouped = {};
                            locations.forEach(loc => {
                              if (loc.groupName) {
                                if (!grouped[loc.groupName]) grouped[loc.groupName] = [];
                                grouped[loc.groupName].push(loc);
                              } else {
                                if (!grouped['_ungrouped']) grouped['_ungrouped'] = [];
                                grouped['_ungrouped'].push(loc);
                              }
                            });

                            const elements = [];
                            // Render grouped locations
                            Object.keys(grouped).forEach(groupName => {
                              if (groupName !== '_ungrouped') {
                                elements.push(
                                  <optgroup key={groupName} label={groupName}>
                                    {grouped[groupName].map(location => {
                                      // Check if location has the same medication (name, strength, type)
                                      const medInLocation = medications.find(m =>
                                        m.medicationName === ui.selectedMed.medicationName &&
                                        m.strengthRaw === ui.selectedMed.strengthRaw &&
                                        m.type === ui.selectedMed.type &&
                                        m.location === location.displayName
                                      );
                                      const hasBatches = medInLocation && medInLocation.batches.length > 0 && location.displayName !== ui.selectedMed.location;
                                      return (
                                        <option key={location.id} value={location.displayName} style={hasBatches ? { color: '#059669', fontWeight: '600' } : {}}>
                                          {location.displayName}{hasBatches ? ' ✓' : ''}
                                        </option>
                                      );
                                    })}
                                  </optgroup>
                                );
                              }
                            });
                            // Render ungrouped locations
                            if (grouped['_ungrouped']) {
                              grouped['_ungrouped'].forEach(location => {
                                const medInLocation = medications.find(m =>
                                  m.medicationName === ui.selectedMed.medicationName &&
                                  m.strengthRaw === ui.selectedMed.strengthRaw &&
                                  m.type === ui.selectedMed.type &&
                                  m.location === location.displayName
                                );
                                const hasBatches = medInLocation && medInLocation.batches.length > 0 && location.displayName !== ui.selectedMed.location;
                                elements.push(
                                  <option key={location.id} value={location.displayName} style={hasBatches ? { color: '#059669', fontWeight: '600' } : {}}>
                                    {location.displayName}{hasBatches ? ' ✓' : ''}
                                  </option>
                                );
                              });
                            }
                            return elements;
                          })()}
                        </select>
                            <p className="text-xs text-gray-500 mt-1"><span className="text-green-600 font-semibold">Green departments ✓</span> contain batches of {ui.selectedMed.name}</p>
                      </div>
                    )}
                  </>
                )}

                {((adjustmentForm.action === 'out') || (adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing') || (adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'existing')))) && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Select Batch <span className="text-red-600">*</span></label>
                        <select value={adjustmentForm.batchId} onChange={(e) => { setAdjustmentForm(prev => ({ ...prev, batchId: e.target.value, error: '' })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                      <option value="">Select batch...</option>
                      {(() => {
                        let batchSource = ui.selectedMed;
                        if (adjustmentForm.action === 'in' && adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'existing' && adjustmentForm.sourceDepartment) {
                              const sourceMed = medications.find(m => m.name === ui.selectedMed.name && m.location === adjustmentForm.sourceDepartment);
                              if (!sourceMed) { return (<option value="" disabled>No batches available - {ui.selectedMed.name} does not exist in {adjustmentForm.sourceDepartment}</option>); }
                          batchSource = sourceMed;
                        }
                            return batchSource.batches.sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01')).map((batch, idx) => {
                            const formattedExpiry = formatExpiry(batch.expiryDate);
                            const batchDetails = formatBatchDetails(batch, batchSource.unit);
                              return (<option key={batch.id} value={batch.id}>Batch {idx + 1}: {batch.brand} - {batchDetails} - Exp: {formattedExpiry}</option>);
                          });
                      })()}
                    </select>
                  </div>
                )}

                {adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new')) ? (
                  <>
                    <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                          <p className="text-sm text-blue-800">{adjustmentForm.stockInSource === 'delivery' ? 'Adding new stock from delivery. Enter the batch details below.' : 'Adding stock from a new batch. Enter the batch details below.'}</p>
                    </div>
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Brand <span className="text-red-600">*</span></label>
                          <input 
                            type="text" 
                            list="barcodeBrandList" 
                            value={deliveryForm.brand} 
                            onChange={(e) => {
                              if (!deliveryForm.batchLocked) {
                                setDeliveryForm(prev => ({ ...prev, brand: e.target.value }));
                              }
                            }}
                            readOnly={deliveryForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${deliveryForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g. Actavis, Accord, Teva" 
                          />
                          <datalist id="barcodeBrandList">
                            {[...new Set(ui.selectedMed.batches.map(b => b.brand))].map(brand => (
                              <option key={brand} value={brand} />
                            ))}
                          </datalist>
                          {!deliveryForm.batchLocked && (
                            <p className="text-xs text-gray-500 mt-1">Select an existing brand or type a new one</p>
                          )}
                    </div>
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Batch Number</label>
                          <input 
                            type="text" 
                            value={deliveryForm.batchNumber} 
                            onChange={(e) => {
                              setDeliveryForm(prev => ({ ...prev, batchNumber: e.target.value }));
                              // Batch integrity safeguard — do not remove.
                              // Check batch code after user stops typing (debounce)
                              const code = e.target.value.trim();
                              if (code) {
                                setTimeout(() => checkBatchCode(code, 'delivery'), 500);
                              } else {
                                setDeliveryForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
                              }
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                            placeholder="e.g. BN123456" 
                          />
                          {deliveryForm.batchExists && (
                            <p className="text-xs text-blue-700 mt-1">✓ Batch code already exists — existing details applied.</p>
                          )}
                    </div>
                    <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Expiry Date <span className="text-red-600">*</span></label>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Month</label>
                              <select 
                                value={deliveryForm.expiryMonth} 
                                onChange={(e) => {
                                  if (!deliveryForm.batchLocked) {
                                    setDeliveryForm(prev => ({ ...prev, expiryMonth: e.target.value }));
                                  }
                                }}
                                disabled={deliveryForm.batchLocked}
                                className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${deliveryForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              >
                            <option value="">Select...</option>
                                {['January','February','March','April','May','June','July','August','September','October','November','December'].map((month, idx) => (<option key={month} value={String(idx + 1).padStart(2, '0')}>{month}</option>))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Year</label>
                              <select 
                                value={deliveryForm.expiryYear} 
                                onChange={(e) => {
                                  if (!deliveryForm.batchLocked) {
                                    setDeliveryForm(prev => ({ ...prev, expiryYear: e.target.value }));
                                  }
                                }}
                                disabled={deliveryForm.batchLocked}
                                className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${deliveryForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              >
                            <option value="">Select...</option>
                                {Array.from({ length: 10 }, (_, i) => new Date().getFullYear() + i).map(year => (<option key={year} value={year}>{year}</option>))}
                          </select>
                        </div>
                      </div>
                    </div>
                  </>
                ) : null}

                {adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new')) && ui.selectedMed.batches.length > 0 && (
                  <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded">
                    <p className="text-sm font-semibold text-amber-800 mb-2">Existing Batches for {ui.selectedMed.name}:</p>
                    <div className="space-y-1">
                      {ui.selectedMed.batches.sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01')).map((batch, idx) => (
                        <div key={batch.id} className="text-xs text-amber-900 bg-white p-2 rounded">
                          <span className="font-medium">Batch {idx + 1}:</span>
                          {batch.batchNumber && <span className="ml-2">#{batch.batchNumber}</span>}
                          <span className="ml-2">• Exp: {formatExpiry(batch.expiryDate)}</span>
                        </div>
                      ))}
                    </div>
                    <p className="text-xs text-amber-700 mt-2">⚠️ Only create a new batch if the batch number or expiry date differs from above</p>
                  </div>
                )}

                {adjustmentForm.action === 'out' && (
                  <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Destination Location <span className="text-red-600">*</span></label>
                        <select value={adjustmentForm.location} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, location: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                      <option value="">Select destination...</option>
                          {locations.filter(loc => loc.displayName !== ui.selectedMed.location).map(location => {
                            // Check if location has the same medication (name, strength, type)
                            const medInLocation = medications.find(m => 
                              m.medicationName === ui.selectedMed.medicationName && 
                              m.strengthRaw === ui.selectedMed.strengthRaw && 
                              m.type === ui.selectedMed.type && 
                              m.location === location.displayName
                            );
                            const hasBatches = medInLocation && medInLocation.batches.length > 0;
                            return (
                              <option key={location.id} value={location.displayName} style={hasBatches ? { color: '#059669', fontWeight: '600' } : {}}>
                                {location.displayName}{hasBatches ? ' ✓' : ''}
                              </option>
                            );
                          })}
                    </select>
                    <p className="text-xs text-gray-500 mt-1"><span className="text-green-600 font-semibold">Green locations ✓</span> contain the same medication ({ui.selectedMed.name})</p>
                  </div>
                )}

                {adjustmentForm.action === 'in' && ((adjustmentForm.stockInSource === 'delivery' && adjustmentForm.deliveryBatchOption === 'new') || (adjustmentForm.stockInSource === 'transfer' && adjustmentForm.transferBatchOption === 'new')) && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                    <div className="flex gap-4 mb-3">
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="barcodeDeliveryQuantityType" 
                          value="boxes" 
                          checked={deliveryForm.quantityType === 'boxes'} 
                          onClick={(e) => {
                            setDeliveryForm(prev => ({ ...prev, quantityType: 'boxes', boxQuantity: '', itemsPerBox: '', individualQuantity: '' }));
                          }} 
                          className="mr-2" 
                        />
                        Boxes
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input 
                          type="radio" 
                          name="barcodeDeliveryQuantityType" 
                          value="individual" 
                          checked={deliveryForm.quantityType === 'individual'} 
                          onClick={(e) => {
                            setDeliveryForm(prev => ({ ...prev, quantityType: 'individual', individualQuantity: '', boxQuantity: '', itemsPerBox: '' }));
                          }} 
                          className="mr-2" 
                        />
                        Individual {getIndividualUnitLabel(ui.selectedMed.unit)}
                      </label>
                    </div>
                    {deliveryForm.quantityType === 'boxes' ? (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Number of {deliveryForm.boxQuantity && parseInt(deliveryForm.boxQuantity) === 1 ? 'Box' : 'Boxes'} <span className="text-red-600">*</span>
                          </label>
                          <input type="number" value={deliveryForm.boxQuantity} onChange={(e) => setDeliveryForm(prev => ({ ...prev, boxQuantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 5" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Items per Box <span className="text-red-600">*</span></label>
                          <input 
                            type="number" 
                            value={deliveryForm.itemsPerBox} 
                            onChange={(e) => {
                              if (!deliveryForm.batchLocked) {
                                setDeliveryForm(prev => ({ ...prev, itemsPerBox: e.target.value }));
                              }
                            }}
                            readOnly={deliveryForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${deliveryForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g. 100" 
                          />
                        </div>
                        {deliveryForm.boxQuantity && deliveryForm.itemsPerBox && (
                          <div className="col-span-2 p-2 bg-blue-50 border border-blue-200 rounded">
                            <p className="text-sm text-blue-800">Total: <span className="font-bold">{parseInt(deliveryForm.boxQuantity) * parseInt(deliveryForm.itemsPerBox)} {ui.selectedMed.unit}</span></p>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                        <input type="number" value={deliveryForm.individualQuantity} onChange={(e) => setDeliveryForm(prev => ({ ...prev, individualQuantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder={`Enter number of ${ui.selectedMed.unit}`} />
                      </div>
                    )}
                  </div>
                )}

                {adjustmentForm.action === 'out' && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                    <div className="flex gap-2 mb-2">
                      <label className="flex items-center cursor-pointer">
                        <input type="radio" name="barcodeQuantityType" value="boxes" checked={adjustmentForm.type === 'boxes'} onClick={(e) => { setAdjustmentForm(prev => ({ ...prev, type: 'boxes', amount: '' })); }} className="mr-2" />
                        Boxes
                      </label>
                      <label className="flex items-center cursor-pointer">
                        <input type="radio" name="barcodeQuantityType" value="individual" checked={adjustmentForm.type === 'individual'} onClick={(e) => { setAdjustmentForm(prev => ({ ...prev, type: 'individual', amount: '' })); }} className="mr-2" />
                        Individual {getIndividualUnitLabel(ui.selectedMed.unit)}
                      </label>
                    </div>
                    <input type="number" value={adjustmentForm.amount} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, amount: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder={adjustmentForm.type === 'boxes' ? 'Enter number of boxes' : `Enter number of ${ui.selectedMed.unit}`} />
                  </div>
                )}

                <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Additional Note (optional)</label>
                      <input type="text" value={adjustmentForm.note} onChange={(e) => setAdjustmentForm(prev => ({ ...prev, note: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. Emergency surgery" />
                </div>
                </div>
                <div className="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 flex-shrink-0">
                  <div className="flex flex-col sm:flex-row gap-2">
                  {adjustmentForm.action === 'in' && (
                        <button onClick={() => handleStockAdjustment('in')} className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center justify-center">
                      <Plus className="w-4 h-4 mr-1" />
                          {adjustmentForm.stockInSource === 'delivery' ? (adjustmentForm.deliveryBatchOption === 'new' ? 'Receive Delivery' : 'Add to Batch') : (adjustmentForm.transferBatchOption === 'new' ? 'Add New Batch' : 'Add Stock')}
                    </button>
                  )}
                      {adjustmentForm.action === 'out' && (<button onClick={() => handleStockAdjustment('out')} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium flex items-center justify-center"><Minus className="w-4 h-4 mr-1" />Transfer Stock</button>)}
                      <button onClick={() => { setModals(prev => ({ ...prev, showBarcodeStockAdjust: false })); setUi(prev => ({ ...prev, selectedMed: null })); }} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Add Medication Modal */}
            {modals.showAddMedication && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showAddMedication: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                    <h2 className="text-base sm:text-lg font-bold text-gray-800">Add New Stock</h2>
                    <p className="text-xs text-gray-600 mt-1">Location: {ui.currentLocation}</p>
                  </div>
                  <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {addMedForm.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{addMedForm.error}</div>)}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Mode</label>
                      <button 
                        onClick={() => {
                          setAddMedForm(prev => ({ ...prev, mode: prev.mode === 'existing' ? 'new' : 'existing' }));
                        }}
                        className="mb-2 px-2 py-1 bg-blue-500 text-white text-xs rounded"
                      >
                        Test: Toggle Mode
                      </button>
                      <div className="flex gap-4">
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="addMedMode" 
                            value="existing" 
                            checked={addMedForm.mode === 'existing'} 
                            onClick={(e) => {
                              setAddMedForm(prev => ({ ...prev, mode: 'existing', searchTerm: '', selectedExistingMedId: '' }));
                            }} 
                            className="mr-2" 
                          />
                          Add Existing Medication
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="addMedMode" 
                            value="new" 
                            checked={addMedForm.mode === 'new'} 
                            onClick={(e) => {
                              setAddMedForm(prev => ({ ...prev, mode: 'new', searchTerm: '', selectedExistingMedId: '' }));
                            }} 
                            className="mr-2" 
                          />
                          Create New Medication
                        </label>
                      </div>
                    </div>

                    {addMedForm.mode === 'existing' ? (
                      <>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Search Medication <span className="text-red-600">*</span></label>
                          <div className="relative">
                            <Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                            <input type="text" id="add-medication-search-input" value={addMedForm.searchTerm} onChange={(e) => setAddMedForm(prev => ({ ...prev, searchTerm: e.target.value, selectedExistingMedId: '' }))} className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Search for medication across all locations..." />
                            {addMedForm.searchTerm && (
                              <button
                                onClick={() => setAddMedForm(prev => ({ ...prev, searchTerm: '', selectedExistingMedId: '' }))}
                                className="absolute right-3 top-3 text-gray-400 hover:text-gray-600 focus:outline-none"
                                aria-label="Clear search"
                              >
                                <X className="w-5 h-5" />
                              </button>
                            )}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Search will find medications in any location or ward</p>
                        </div>
                        {addMedForm.searchTerm && (
                          <div className="mb-4 max-h-60 overflow-y-auto border border-gray-300 rounded-lg">
                            {(() => {
                              const searchResults = medications.filter(med => 
                                med.name.toLowerCase().includes(addMedForm.searchTerm.toLowerCase()) ||
                                (med.barcode && med.barcode.toLowerCase().includes(addMedForm.searchTerm.toLowerCase())) ||
                                (med.batches && med.batches.some(batch => batch.batchNumber && batch.batchNumber.toLowerCase().includes(addMedForm.searchTerm.toLowerCase())))
                              ).sort((a, b) => a.name.localeCompare(b.name));
                              if (searchResults.length === 0) { return (<div className="p-4 text-center text-gray-500 text-sm">No medications found matching "{addMedForm.searchTerm}"</div>); }
                              const groupedResults = searchResults.reduce((acc, med) => { if (!acc[med.name]) { acc[med.name] = []; } acc[med.name].push(med); return acc; }, {});
                              return Object.entries(groupedResults).map(([medName, meds]) => (
                                <div key={medName} className="border-b border-gray-200 last:border-b-0">
                                  <div className="bg-gray-50 px-4 py-2">
                                    <p className="font-medium text-gray-900 text-sm">{medName}</p>
                                    <p className="text-xs text-gray-600">Found in {meds.length} location{meds.length !== 1 ? 's' : ''}</p>
                                  </div>
                                  {meds.map(med => (
                                    <button key={med.id} onClick={() => setAddMedForm(prev => ({ ...prev, selectedExistingMedId: String(med.id) }))} className={`w-full text-left px-4 py-3 hover:bg-cyan-50 transition-colors ${addMedForm.selectedExistingMedId === String(med.id) ? 'bg-cyan-100 border-l-4 border-cyan-500' : ''}`}>
                                      <div className="flex justify-between items-center">
                                        <div>
                                          <p className="text-sm font-medium text-gray-900">{med.location}</p>
                                          <p className="text-xs text-gray-600">Stock: {formatStockDisplay(med)} | {med.batches.length} batch{med.batches.length !== 1 ? 'es' : ''}</p>
                                        </div>
                                        {addMedForm.selectedExistingMedId === String(med.id) && (<span className="text-cyan-600 font-semibold text-sm">Selected</span>)}
                                      </div>
                  </button>
                                  ))}
                </div>
                              ));
                            })()}
                </div>
                        )}
                        {!addMedForm.selectedExistingMedId && !addMedForm.searchTerm && (
                          <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                            <p className="text-sm text-blue-800 font-semibold mb-1">Stock will be added to: {ui.currentLocation}</p>
                            <p className="text-sm text-blue-800">Search for any medication across all hospital locations. The search helps you find the correct medication details (name, type, strength/concentration). Your new stock will be added to {ui.currentLocation}.</p>
              </div>
                        )}
                        {addMedForm.selectedExistingMedId && (
                          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p className="text-sm text-green-800">✓ Medication template selected. New stock will be added to <strong>{ui.currentLocation}</strong></p>
            </div>
                        )}
                      </>
                    ) : (
                      <>
                        <div className="grid grid-cols-2 gap-3 mb-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Medication Name <span className="text-red-600">*</span></label>
                            <input type="text" value={addMedForm.name} onChange={(e) => setAddMedForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. Paracetamol" />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Strength/Concentration <span className="text-red-600">*</span></label>
                            <div className="mb-2">
                              <div className="flex gap-4">
                                <label className="flex items-center cursor-pointer">
                                  <input 
                                    type="radio" 
                                    name="strengthType" 
                                    value="value" 
                                    checked={addMedForm.strengthType === 'value'} 
                                    onClick={(e) => setAddMedForm(prev => ({ ...prev, strengthType: 'value', error: '' }))} 
                                    className="mr-2"
                                  />
                                  <span className="text-sm text-gray-700">Value</span>
                                </label>
                                <label className="flex items-center cursor-pointer">
                                  <input 
                                    type="radio" 
                                    name="strengthType" 
                                    value="na" 
                                    checked={addMedForm.strengthType === 'na'} 
                                    onClick={(e) => setAddMedForm(prev => ({ ...prev, strengthType: 'na', strength: '', error: '' }))} 
                                    className="mr-2"
                                  />
                                  <span className="text-sm text-gray-700">N/A</span>
                                </label>
                              </div>
                            </div>
                            {addMedForm.strengthType === 'value' && (
                              <input type="text" value={addMedForm.strength} onChange={(e) => setAddMedForm(prev => ({ ...prev, strength: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 500mg" />
                            )}
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Barcode (Optional)</label>
                            <input type="text" value={addMedForm.barcode} onChange={(e) => setAddMedForm(prev => ({ ...prev, barcode: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 123456789012" />
                            <p className="text-xs text-gray-500 mt-1">Leave empty if no barcode available</p>
                          </div>
                        </div>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Type <span className="text-red-600">*</span></label>
                          <select value={addMedForm.type} onChange={(e) => setAddMedForm(prev => ({ ...prev, type: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            {MEDICATION_TYPES.map(type => (<option key={type} value={type}>{type}</option>))}
                          </select>
                        </div>
                      </>
                    )}

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Brand <span className="text-red-600">*</span></label>
                      <input 
                        type="text" 
                        value={addMedForm.brand} 
                        onChange={(e) => {
                          if (!addMedForm.batchLocked) {
                            setAddMedForm(prev => ({ ...prev, brand: e.target.value }));
                          }
                        }}
                        readOnly={addMedForm.batchLocked}
                        className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                        placeholder="e.g. Actavis, Accord, Teva" 
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Batch Number</label>
                      <input 
                        type="text" 
                        value={addMedForm.batchNumber} 
                        onChange={(e) => {
                          setAddMedForm(prev => ({ ...prev, batchNumber: e.target.value }));
                          // Batch integrity safeguard — do not remove.
                          // Check batch code after user stops typing (debounce)
                          const code = e.target.value.trim();
                          if (code) {
                            setTimeout(() => checkBatchCode(code, 'addMed'), 500);
                          } else {
                            setAddMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
                          }
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
                        placeholder="e.g. BN123456" 
                      />
                      {addMedForm.batchExists && (
                        <p className="text-xs text-blue-700 mt-1">✓ Batch code already exists — existing details applied.</p>
                      )}
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Expiry Date <span className="text-red-600">*</span></label>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Month</label>
                          <select 
                            value={addMedForm.expiryMonth} 
                            onChange={(e) => {
                              if (!addMedForm.batchLocked) {
                                setAddMedForm(prev => ({ ...prev, expiryMonth: e.target.value }));
                              }
                            }}
                            disabled={addMedForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                          >
                            <option value="">Select...</option>
                            {['January','February','March','April','May','June','July','August','September','October','November','December'].map((month, idx) => (<option key={month} value={String(idx + 1).padStart(2, '0')}>{month}</option>))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Year</label>
                          <input 
                            type="number" 
                            value={addMedForm.expiryYear} 
                            onChange={(e) => {
                              if (!addMedForm.batchLocked) {
                                setAddMedForm(prev => ({ ...prev, expiryYear: e.target.value }));
                              }
                            }}
                            disabled={addMedForm.batchLocked}
                            placeholder={String(new Date().getFullYear())} 
                            className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            min="2024" 
                            max="2099" 
                          />
                        </div>
                      </div>
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                      <div className="flex gap-4">
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="addMedQuantityType" 
                            value="boxes" 
                            checked={addMedForm.quantityType === 'boxes'} 
                            onClick={(e) => {
                              setAddMedForm(prev => ({ ...prev, quantityType: 'boxes' }));
                            }} 
                            className="mr-2" 
                          />
                          Boxes
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="addMedQuantityType" 
                            value="individual" 
                            checked={addMedForm.quantityType === 'individual'} 
                            onClick={(e) => {
                              setAddMedForm(prev => ({ ...prev, quantityType: 'individual' }));
                            }} 
                            className="mr-2" 
                          />
                          Individual Items
                        </label>
                      </div>
                    </div>
                    {addMedForm.quantityType === 'boxes' ? (
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Number of {addMedForm.boxQuantity && parseInt(addMedForm.boxQuantity) === 1 ? 'Box' : 'Boxes'} <span className="text-red-600">*</span>
                          </label>
                          <input type="number" value={addMedForm.boxQuantity} onChange={(e) => setAddMedForm(prev => ({ ...prev, boxQuantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 5" min="1" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Items per Box <span className="text-red-600">*</span></label>
                          <input 
                            type="number" 
                            value={addMedForm.itemsPerBox} 
                            onChange={(e) => {
                              if (!addMedForm.batchLocked) {
                                setAddMedForm(prev => ({ ...prev, itemsPerBox: e.target.value }));
                              }
                            }}
                            readOnly={addMedForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g. 100" 
                            min="1" 
                          />
                        </div>
                      </div>
                    ) : (
                      <>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Quantity <span className="text-red-600">*</span></label>
                          <input type="number" value={addMedForm.individualQuantity} onChange={(e) => setAddMedForm(prev => ({ ...prev, individualQuantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter quantity" min="1" />
                        </div>
                        <div className="mb-4">
                          <label className="block text-sm font-medium text-gray-700 mb-2">Items per Box (optional)</label>
                          <input type="number" value={addMedForm.itemsPerBox} onChange={(e) => setAddMedForm(prev => ({ ...prev, itemsPerBox: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 100" min="1" />
                          <p className="text-xs text-gray-500 mt-1">Specify box size for future batch tracking (e.g., adding 50 tablets from a 100-tablet box)</p>
                        </div>
                      </>
                    )}
                    {addMedForm.mode === 'new' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Min stock (boxes)</label>
                        <input type="number" value={addMedForm.minLevelBoxes} onChange={(e) => setAddMedForm(prev => ({ ...prev, minLevelBoxes: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter minimum level in boxes (optional)" min="0" />
                      </div>
                    )}
                  </div>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 flex-shrink-0">
                    <div className="flex flex-col sm:flex-row gap-2">
                      <button onClick={handleAddNewMedication} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium text-sm">Add Stock</button>
                      <button onClick={() => { setModals(prev => ({ ...prev, showAddMedication: false })); setAddMedForm({ mode: 'existing', selectedExistingMedId: '', searchTerm: '', name: '', strength: '', type: 'tablet', expiryMonth: '', expiryYear: '', quantityType: 'boxes', boxQuantity: '', itemsPerBox: '', individualQuantity: '', minLevelType: 'boxes', minLevel: '', minLevelBoxes: '', brand: '', batchNumber: '', batchLocked: false, batchExists: false, error: '' }); }} className="sm:px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium text-sm">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Barcode New Medication Modal */}
            {modals.showBarcodeNewMedication && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; resetBarcodeNewMedForm(); setModals(prev => ({ ...prev, showBarcodeNewMedication: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-2xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                    <h2 className="text-base sm:text-lg font-bold text-gray-800">Add New Medication by Barcode</h2>
                  </div>
                  <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {barcodeNewMedForm.error && (
                      <div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">
                        {barcodeNewMedForm.error}
                      </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Medication Details */}
                      <div className="space-y-4">
                        <h3 className="text-md font-semibold text-gray-700 border-b pb-2">Medication Details</h3>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                          <input
                            type="text"
                            id="barcodeInput"
                            value={barcodeNewMedForm.barcode}
                            onChange={(e) => {
                              const barcode = e.target.value;
                              setBarcodeNewMedForm(prev => ({ ...prev, barcode, error: '' }));
                              // Clear any existing timeout
                              if (barcodeLookupTimeoutRef.current) {
                                clearTimeout(barcodeLookupTimeoutRef.current);
                                barcodeLookupTimeoutRef.current = null;
                              }
                              // Trigger lookup when barcode changes (debounced for typing)
                              if (barcode.trim()) {
                                barcodeLookupTimeoutRef.current = setTimeout(() => {
                                  handleBarcodeLookup(barcode);
                                  barcodeLookupTimeoutRef.current = null;
                                }, 500);
                              } else {
                                handleBarcodeLookup('');
                              }
                            }}
                            onKeyDown={(e) => {
                              // Handle Enter key (barcode scanners typically send Enter after scan)
                              if (e.key === 'Enter') {
                                e.preventDefault();
                                // Clear any pending debounced timeout
                                if (barcodeLookupTimeoutRef.current) {
                                  clearTimeout(barcodeLookupTimeoutRef.current);
                                  barcodeLookupTimeoutRef.current = null;
                                }
                                // Trigger immediate lookup
                                const barcode = e.target.value.trim();
                                if (barcode) {
                                  handleBarcodeLookup(barcode);
                                }
                              }
                            }}
                            onBlur={(e) => {
                              // Clear any pending timeout
                              if (barcodeLookupTimeoutRef.current) {
                                clearTimeout(barcodeLookupTimeoutRef.current);
                                barcodeLookupTimeoutRef.current = null;
                              }
                              // Also trigger lookup on blur to ensure it runs if user tabs away
                              const barcode = e.target.value.trim();
                              if (barcode) {
                                handleBarcodeLookup(barcode);
                              }
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            placeholder="Scan or enter barcode"
                            autoComplete="off"
                          />
                          {barcodeNewMedForm.medicationLocked && (
                            <p className="text-xs text-green-700 mt-1">✓ Medication found — details auto-filled.</p>
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Medication Name *</label>
                          <input
                            type="text"
                            value={barcodeNewMedForm.name}
                            onChange={(e) => {
                              if (!barcodeNewMedForm.medicationLocked) {
                                setBarcodeNewMedForm(prev => ({ ...prev, name: e.target.value, error: '' }));
                              }
                            }}
                            readOnly={barcodeNewMedForm.medicationLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.medicationLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., Paracetamol"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Strength/Concentration *</label>
                          <div className="mb-2">
                            <div className="flex gap-4">
                              <label className={`flex items-center ${barcodeNewMedForm.medicationLocked ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}`}>
                                <input 
                                  type="radio" 
                                  name="barcodeStrengthType" 
                                  value="value" 
                                  checked={barcodeNewMedForm.strengthType === 'value'} 
                                  onClick={(e) => {
                                    if (!barcodeNewMedForm.medicationLocked) {
                                      setBarcodeNewMedForm(prev => ({ ...prev, strengthType: 'value', error: '' }));
                                    }
                                  }}
                                  disabled={barcodeNewMedForm.medicationLocked}
                                  className="mr-2"
                                />
                                <span className="text-sm text-gray-700">Value</span>
                              </label>
                              <label className={`flex items-center ${barcodeNewMedForm.medicationLocked ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}`}>
                                <input 
                                  type="radio" 
                                  name="barcodeStrengthType" 
                                  value="na" 
                                  checked={barcodeNewMedForm.strengthType === 'na'} 
                                  onClick={(e) => {
                                    if (!barcodeNewMedForm.medicationLocked) {
                                      setBarcodeNewMedForm(prev => ({ ...prev, strengthType: 'na', strength: '', error: '' }));
                                    }
                                  }}
                                  disabled={barcodeNewMedForm.medicationLocked}
                                  className="mr-2"
                                />
                                <span className="text-sm text-gray-700">N/A</span>
                              </label>
                            </div>
                          </div>
                          {barcodeNewMedForm.strengthType === 'value' && (
                            <input
                              type="text"
                              value={barcodeNewMedForm.strength}
                              onChange={(e) => {
                                if (!barcodeNewMedForm.medicationLocked) {
                                  setBarcodeNewMedForm(prev => ({ ...prev, strength: e.target.value, error: '' }));
                                }
                              }}
                              readOnly={barcodeNewMedForm.medicationLocked}
                              className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.medicationLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              placeholder="e.g., 500mg"
                            />
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                          <select
                            value={barcodeNewMedForm.type}
                            onChange={(e) => {
                              if (!barcodeNewMedForm.medicationLocked) {
                                setBarcodeNewMedForm(prev => ({ ...prev, type: e.target.value, error: '' }));
                              }
                            }}
                            disabled={barcodeNewMedForm.medicationLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.medicationLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                          >
                            {MEDICATION_TYPES.map(type => (
                              <option key={type} value={type.toLowerCase()}>{type}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Brand *</label>
                          <input
                            type="text"
                            value={barcodeNewMedForm.brand}
                            onChange={(e) => {
                              if (!barcodeNewMedForm.batchLocked) {
                                setBarcodeNewMedForm(prev => ({ ...prev, brand: e.target.value, error: '' }));
                              }
                            }}
                            readOnly={barcodeNewMedForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., Pfizer"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Location *</label>
                          <select
                            value={barcodeNewMedForm.location}
                            onChange={(e) => setBarcodeNewMedForm(prev => ({ ...prev, location: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                          >
                            <option value="">Select Location</option>
                            {(() => {
                              // Group locations by groupName
                              const grouped = {};
                              locations.forEach(loc => {
                                if (loc.groupName) {
                                  if (!grouped[loc.groupName]) grouped[loc.groupName] = [];
                                  grouped[loc.groupName].push(loc);
                                } else {
                                  if (!grouped['_ungrouped']) grouped['_ungrouped'] = [];
                                  grouped['_ungrouped'].push(loc);
                                }
                              });

                              const elements = [];
                              // Render grouped locations
                              Object.keys(grouped).forEach(groupName => {
                                if (groupName !== '_ungrouped') {
                                  elements.push(
                                    <optgroup key={groupName} label={groupName}>
                                      <option value={groupName}>{groupName} (All)</option>
                                      {grouped[groupName].map(loc => (
                                        <option key={loc.id} value={loc.displayName}>{loc.displayName}</option>
                                      ))}
                                    </optgroup>
                                  );
                                }
                              });
                              // Render ungrouped locations
                              if (grouped['_ungrouped']) {
                                grouped['_ungrouped'].forEach(loc => {
                                  elements.push(<option key={loc.id} value={loc.displayName}>{loc.displayName}</option>);
                                });
                              }
                              return elements;
                            })()}
                          </select>
                        </div>
                      </div>

                      {/* Stock Details */}
                      <div className="space-y-4">
                        <h3 className="text-md font-semibold text-gray-700 border-b pb-2">Stock Details</h3>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Expiry Date *</label>
                          <div className="grid grid-cols-2 gap-2">
                            <select
                              value={barcodeNewMedForm.expiryMonth}
                              onChange={(e) => {
                                if (!barcodeNewMedForm.batchLocked) {
                                  setBarcodeNewMedForm(prev => ({ ...prev, expiryMonth: e.target.value, error: '' }));
                                }
                              }}
                              disabled={barcodeNewMedForm.batchLocked}
                              className={`px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            >
                              <option value="">Select Month</option>
                              <option value="01">January</option>
                              <option value="02">February</option>
                              <option value="03">March</option>
                              <option value="04">April</option>
                              <option value="05">May</option>
                              <option value="06">June</option>
                              <option value="07">July</option>
                              <option value="08">August</option>
                              <option value="09">September</option>
                              <option value="10">October</option>
                              <option value="11">November</option>
                              <option value="12">December</option>
                            </select>
                            <input
                              type="number"
                              value={barcodeNewMedForm.expiryYear}
                              onChange={(e) => {
                                if (!barcodeNewMedForm.batchLocked) {
                                  setBarcodeNewMedForm(prev => ({ ...prev, expiryYear: e.target.value, error: '' }));
                                }
                              }}
                              disabled={barcodeNewMedForm.batchLocked}
                              className={`px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              placeholder="YYYY"
                              min={new Date().getFullYear()}
                              max={new Date().getFullYear() + 20}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Batch Number {barcodeNewMedForm.existingBatches && barcodeNewMedForm.existingBatches.length > 0 ? '(select existing or type new)' : ''}</label>
                          <input
                            type="text"
                            list="existingBatchesList"
                            value={barcodeNewMedForm.batchNumber}
                            onChange={(e) => {
                              const inputValue = e.target.value;
                              setBarcodeNewMedForm(prev => ({ ...prev, batchNumber: inputValue, error: '' }));
                              
                              // Check if the input matches an existing batch by batchCode
                              if (barcodeNewMedForm.existingBatches && barcodeNewMedForm.existingBatches.length > 0) {
                                const matchingBatch = barcodeNewMedForm.existingBatches.find(b => b.batchCode === inputValue);
                                if (matchingBatch) {
                                  // User selected an existing batch
                                  handleExistingBatchSelect(matchingBatch.id);
                                } else {
                                  // User is typing a new batch number
                                  setBarcodeNewMedForm(prev => ({ ...prev, existingBatchId: null, batchLocked: false, batchExists: false }));
                                  // Batch integrity safeguard — do not remove.
                                  // Check batch code after user stops typing (debounce)
                                  const code = inputValue.trim();
                                  if (code) {
                                    setTimeout(() => checkBatchCode(code, 'barcode'), 500);
                                  } else {
                                    setBarcodeNewMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
                                  }
                                }
                              } else {
                                // No existing batches, just check if batch exists in system
                                const code = inputValue.trim();
                                if (code) {
                                  setTimeout(() => checkBatchCode(code, 'barcode'), 500);
                                } else {
                                  setBarcodeNewMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
                                }
                              }
                            }}
                            disabled={barcodeNewMedForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${barcodeNewMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., BN123456"
                          />
                          {barcodeNewMedForm.existingBatches && barcodeNewMedForm.existingBatches.length > 0 && (
                            <datalist id="existingBatchesList">
                              {barcodeNewMedForm.existingBatches.map(batch => {
                                const expiryStr = batch.expiryDate ? new Date(batch.expiryDate).toISOString().slice(0, 7) : 'N/A';
                                const displayText = `${batch.batchCode} — ${batch.brand || 'N/A'} — Exp: ${expiryStr} — Items/Box: ${batch.itemsPerBox || 'N/A'}`;
                                return (
                                  <option key={batch.id} value={batch.batchCode}>{displayText}</option>
                                );
                              })}
                            </datalist>
                          )}
                          {barcodeNewMedForm.batchExists && (
                            <p className="text-xs text-blue-700 mt-1">✓ Batch code already exists — existing details applied.</p>
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Number of {barcodeNewMedForm.boxQuantity && parseInt(barcodeNewMedForm.boxQuantity) === 1 ? 'Box' : 'Boxes'}
                          </label>
                          <input
                            type="number"
                            value={barcodeNewMedForm.boxQuantity}
                            onChange={(e) => setBarcodeNewMedForm(prev => ({ ...prev, boxQuantity: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            min="0"
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Items per Box {barcodeNewMedForm.medicationLocked ? '*' : ''}</label>
                          <input
                            type="number"
                            value={barcodeNewMedForm.itemsPerBox}
                            onChange={(e) => {
                              if (!barcodeNewMedForm.batchLocked && !barcodeNewMedForm.medicationLocked) {
                                setBarcodeNewMedForm(prev => ({ ...prev, itemsPerBox: e.target.value, error: '' }));
                              }
                            }}
                            readOnly={barcodeNewMedForm.batchLocked || barcodeNewMedForm.medicationLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${(barcodeNewMedForm.batchLocked || barcodeNewMedForm.medicationLocked) ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            min="1"
                            placeholder="e.g., 100"
                          />
                        </div>


                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Min stock (boxes)</label>
                          <input
                            type="number"
                            value={barcodeNewMedForm.minLevelBoxes}
                            onChange={(e) => setBarcodeNewMedForm(prev => ({ ...prev, minLevelBoxes: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            min="0"
                            placeholder="Enter number of boxes (optional)"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0">
                    <div className="flex gap-2">
                      <button 
                        onClick={handleBarcodeNewMedication} 
                        disabled={barcodeNewMedForm.isSubmitting}
                        className={`flex-1 py-2 rounded-lg transition-colors font-medium ${
                          barcodeNewMedForm.isSubmitting 
                            ? 'bg-gray-400 text-gray-600 cursor-not-allowed' 
                            : 'bg-cyan-500 text-white hover:bg-cyan-600'
                        }`}
                      >
                        {barcodeNewMedForm.isSubmitting ? 'Adding Medication...' : 'Add New Medication'}
                      </button>
                      <button 
                        onClick={() => { 
                          resetBarcodeNewMedForm();
                          setModals(prev => ({ ...prev, showBarcodeNewMedication: false })); 
                        }}
                        className="sm:px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium text-sm">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Add New Medication Modal */}
            {modals.showAddMedication && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showAddMedication: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-2xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                    <h2 className="text-base sm:text-lg font-bold text-gray-800">Add New Medication</h2>
                  </div>
                  <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {addMedForm.error && (
                      <div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">
                        {addMedForm.error}
                      </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Medication Details */}
                      <div className="space-y-4">
                        <h3 className="text-md font-semibold text-gray-700 border-b pb-2">Medication Details</h3>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                          <input type="text" value={addMedForm.barcode} onChange={(e) => setAddMedForm(prev => ({ ...prev, barcode: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="e.g. 123456789012" />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Medication Name *</label>
                          <input
                            type="text"
                            value={addMedForm.name}
                            onChange={(e) => {
                              if (addMedForm.mode === 'new') {
                                setAddMedForm(prev => ({ ...prev, name: e.target.value, error: '' }));
                              }
                            }}
                            readOnly={addMedForm.mode === 'existing'}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.mode === 'existing' ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., Paracetamol"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Strength</label>
                          <div className="flex gap-4 mb-2">
                            <label className={`flex items-center ${addMedForm.mode === 'existing' ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}`}>
                              <input
                                type="radio"
                                name="strengthType"
                                value="value"
                                checked={addMedForm.strengthType === 'value'} 
                                onClick={(e) => {
                                  if (addMedForm.mode === 'new') {
                                    setAddMedForm(prev => ({ ...prev, strengthType: 'value', error: '' }));
                                  }
                                }}
                                disabled={addMedForm.mode === 'existing'}
                                className="mr-2"
                              />
                              <span>Value</span>
                            </label>
                            <label className={`flex items-center ${addMedForm.mode === 'existing' ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}`}>
                              <input
                                type="radio"
                                name="strengthType"
                                value="na"
                                checked={addMedForm.strengthType === 'na'} 
                                onClick={(e) => {
                                  if (addMedForm.mode === 'new') {
                                    setAddMedForm(prev => ({ ...prev, strengthType: 'na', error: '' }));
                                  }
                                }}
                                disabled={addMedForm.mode === 'existing'}
                                className="mr-2"
                              />
                              <span>N/A</span>
                            </label>
                          </div>
                          {addMedForm.strengthType === 'value' && (
                            <input
                              type="text"
                              value={addMedForm.strength}
                              onChange={(e) => {
                                if (addMedForm.mode === 'new') {
                                  setAddMedForm(prev => ({ ...prev, strength: e.target.value, error: '' }));
                                }
                              }}
                              readOnly={addMedForm.mode === 'existing'}
                              className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.mode === 'existing' ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              placeholder="e.g., 500mg"
                            />
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                          <select
                            value={addMedForm.type}
                            onChange={(e) => {
                              if (addMedForm.mode === 'new') {
                                setAddMedForm(prev => ({ ...prev, type: e.target.value, error: '' }));
                              }
                            }}
                            disabled={addMedForm.mode === 'existing'}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.mode === 'existing' ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                          >
                            <option value="tablet">Tablet</option>
                            <option value="capsule">Capsule</option>
                            <option value="liquid">Liquid</option>
                            <option value="injection">Injection</option>
                            <option value="cream">Cream</option>
                            <option value="ointment">Ointment</option>
                            <option value="drops">Drops</option>
                            <option value="spray">Spray</option>
                            <option value="other">Other</option>
                          </select>
                        </div>
                      </div>

                      {/* Batch Details */}
                      <div className="space-y-4">
                        <h3 className="text-md font-semibold text-gray-700 border-b pb-2">Batch Details</h3>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                          <input
                            type="text"
                            value={addMedForm.brand}
                            onChange={(e) => {
                              if (!addMedForm.batchLocked) {
                                setAddMedForm(prev => ({ ...prev, brand: e.target.value, error: '' }));
                              }
                            }}
                            readOnly={addMedForm.batchLocked}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., Generic"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
                          <select
                            value={addMedForm.location}
                            onChange={(e) => setAddMedForm(prev => ({ ...prev, location: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                          >
                            <option value="">Select location</option>
                            {locations.filter(loc => loc.displayName !== 'All' && loc.displayName !== 'Medication Stock L1').map(loc => (
                              <option key={loc.id} value={loc.displayName}>{loc.displayName}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                          <div className="flex gap-2">
                            <select
                              value={addMedForm.expiryMonth}
                              onChange={(e) => {
                                if (!addMedForm.batchLocked) {
                                  setAddMedForm(prev => ({ ...prev, expiryMonth: e.target.value, error: '' }));
                                }
                              }}
                              disabled={addMedForm.batchLocked}
                              className={`px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            >
                              <option value="">Month</option>
                              <option value="01">January</option>
                              <option value="02">February</option>
                              <option value="03">March</option>
                              <option value="04">April</option>
                              <option value="05">May</option>
                              <option value="06">June</option>
                              <option value="07">July</option>
                              <option value="08">August</option>
                              <option value="09">September</option>
                              <option value="10">October</option>
                              <option value="11">November</option>
                              <option value="12">December</option>
                            </select>
                            <input
                              type="number"
                              value={addMedForm.expiryYear}
                              onChange={(e) => {
                                if (!addMedForm.batchLocked) {
                                  setAddMedForm(prev => ({ ...prev, expiryYear: e.target.value, error: '' }));
                                }
                              }}
                              disabled={addMedForm.batchLocked}
                              className={`px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.batchLocked ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                              placeholder="YYYY"
                              min={new Date().getFullYear()}
                              max={new Date().getFullYear() + 20}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Batch Number</label>
                          <input
                            type="text"
                            value={addMedForm.batchNumber}
                            onChange={(e) => {
                              setAddMedForm(prev => ({ ...prev, batchNumber: e.target.value, existingBatchId: null, error: '' }));
                              // Batch integrity safeguard — do not remove.
                              // Check batch code after user stops typing (debounce)
                              const code = e.target.value.trim();
                              if (code) {
                                setTimeout(() => checkBatchCode(code, 'addMed'), 500);
                              } else {
                                setAddMedForm(prev => ({ ...prev, batchLocked: false, batchExists: false }));
                              }
                            }}
                            disabled={!!addMedForm.existingBatchId}
                            className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 ${addMedForm.existingBatchId ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            placeholder="e.g., BN123456"
                          />
                          {addMedForm.batchExists && (
                            <p className="text-xs text-blue-700 mt-1">✓ Batch code already exists — existing details applied.</p>
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Number of {addMedForm.boxQuantity && parseInt(addMedForm.boxQuantity) === 1 ? 'Box' : 'Boxes'}
                          </label>
                          <input
                            type="number"
                            value={addMedForm.boxQuantity}
                            onChange={(e) => setAddMedForm(prev => ({ ...prev, boxQuantity: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            min="0"
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Items per Box</label>
                          <input
                            type="number"
                            value={addMedForm.itemsPerBox}
                            onChange={(e) => setAddMedForm(prev => ({ ...prev, itemsPerBox: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            min="1"
                            placeholder="e.g., 100"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Individual Items</label>
                          <input
                            type="number"
                            value={addMedForm.individualQuantity}
                            onChange={(e) => setAddMedForm(prev => ({ ...prev, individualQuantity: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            min="0"
                            placeholder="0"
                          />
                          <p className="text-xs text-gray-500 mt-1">Total: (Boxes × Items per Box) + Individual Items</p>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Minimum Stock Level</label>
                          <div className="flex gap-4 mb-2">
                            <label className="flex items-center cursor-pointer">
                              <input
                                type="radio"
                                name="minLevelType"
                                value="boxes"
                                checked={addMedForm.minLevelType === 'boxes'}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setAddMedForm(prev => ({ ...prev, minLevelType: 'boxes', error: '' }));
                                }}
                                className="mr-2"
                              />
                              <span>Boxes</span>
                            </label>
                            <label className="flex items-center cursor-pointer">
                              <input
                                type="radio"
                                name="minLevelType"
                                value="individual"
                                checked={addMedForm.minLevelType === 'individual'}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setAddMedForm(prev => ({ ...prev, minLevelType: 'individual', error: '' }));
                                }}
                                className="mr-2"
                              />
                              <span>Individual Items</span>
                            </label>
                          </div>
                          {addMedForm.minLevelType === 'boxes' ? (
                            <input
                              type="number"
                              value={addMedForm.minLevelBoxes}
                              onChange={(e) => setAddMedForm(prev => ({ ...prev, minLevelBoxes: e.target.value, error: '' }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                              min="0"
                              placeholder="e.g., 2"
                            />
                          ) : (
                            <input
                              type="number"
                              value={addMedForm.minLevel}
                              onChange={(e) => setAddMedForm(prev => ({ ...prev, minLevel: e.target.value, error: '' }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                              min="0"
                              placeholder="e.g., 200"
                            />
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 flex-shrink-0 flex justify-end gap-2">
                    <button
                      onClick={handleAddNewMedication}
                      disabled={addMedForm.isSubmitting}
                      className={`sm:px-6 py-2 rounded-lg transition-colors font-medium text-sm ${
                        addMedForm.isSubmitting 
                          ? 'bg-gray-400 text-gray-600 cursor-not-allowed' 
                          : 'bg-cyan-500 text-white hover:bg-cyan-600'
                      }`}
                    >
                      {addMedForm.isSubmitting ? 'Adding Medication...' : 'Add New Medication'}
                    </button>
                    <button onClick={() => { setModals(prev => ({ ...prev, showAddMedication: false })); setAddMedForm({ mode: 'existing', selectedExistingMedId: '', searchTerm: '', name: '', strength: '', type: 'tablet', expiryMonth: '', expiryYear: '', quantityType: 'boxes', boxQuantity: '', itemsPerBox: '', individualQuantity: '', minLevelType: 'boxes', minLevel: '', minLevelBoxes: '', brand: '', batchNumber: '', batchLocked: false, batchExists: false, error: '' }); }} className="sm:px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium text-sm">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Low Stock Alert Modal for Pharmacist */}
            {modals.showLowStockAlert && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style={{zIndex: 9999}} onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showLowStockAlert: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full flex flex-col" style={{maxHeight: '80vh'}}>
                  <div className="px-6 py-4 border-b border-gray-200 flex-shrink-0 bg-red-50">
                    <div className="flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold text-red-800 flex items-center gap-2">
                          <div className="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                            <span className="text-white text-sm font-bold">!</span>
                          </div>
                          Low Stock Alert
                        </h2>
                        <p className="text-sm text-red-600 mt-1">Medications requiring immediate attention</p>
                      </div>
                      <button
                        onClick={() => setModals(prev => ({ ...prev, showLowStockAlert: false }))}
                        className="text-gray-400 hover:text-gray-600 text-2xl"
                      >
                        ×
                      </button>
                    </div>
                  </div>
                  <div className="overflow-y-auto px-6 py-4 flex-1">
                    <div className="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                      <p className="text-amber-800 font-medium">
                        ⚠️ {lowStockMedications.length} medication{lowStockMedications.length !== 1 ? 's are' : ' is'} currently below minimum stock level and require{lowStockMedications.length === 1 ? 's' : ''} immediate ordering.
                      </p>
                    </div>
                    
                    <div className="space-y-3">
                      {lowStockMedications.map((med, index) => {
                        const currentQty = getTotalQuantity(med);
                        const suggestedQty = Math.max(0, med.minLevel - currentQty);
                        const formatQuantityInBoxes = (qty) => {
                          const batchWithBoxes = med.batches.find(b => b.itemsPerBox);
                          if (batchWithBoxes) {
                            const boxes = Math.ceil(qty / batchWithBoxes.itemsPerBox);
                            return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${batchWithBoxes.itemsPerBox} items per box`;
                          }
                          return `${qty} ${med.unit}`;
                        };
                        
                        // Use composite key: medication_name|strength_raw|type|location for stable identity
                        const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                        return (
                          <div key={stableKey} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <h3 className="font-semibold text-gray-900 text-lg">{med.name}</h3>
                                <p className="text-sm text-gray-600 mt-1">Location: {med.location}</p>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                                  <div className="bg-red-50 p-3 rounded border border-red-200">
                                    <p className="text-xs font-medium text-red-700 uppercase tracking-wide">Current Stock</p>
                                    <p className="text-red-900 font-bold text-lg">{formatQuantityInBoxes(currentQty)}</p>
                                  </div>
                                  <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                    <p className="text-xs font-medium text-blue-700 uppercase tracking-wide">Minimum Level</p>
                                    <p className="text-blue-900 font-bold text-lg">{med.minLevelBoxes} {med.minLevelBoxes === 1 ? 'box' : 'boxes'}</p>
                                  </div>
                                  <div className="bg-green-50 p-3 rounded border border-green-200">
                                    <p className="text-xs font-medium text-green-700 uppercase tracking-wide">Suggested Order</p>
                                    <p className="text-green-900 font-bold text-lg">{formatQuantityInBoxes(suggestedQty)}</p>
                                  </div>
                                </div>
                              </div>
                              <div className="ml-4 flex flex-col gap-2">
                                <button
                                  onClick={() => {
                                    setModals(prev => ({ ...prev, showLowStockAlert: false }));
                                    setUi(prev => ({ ...prev, activeTab: 'lowstock' }));
                                  }}
                                  className="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors text-sm font-medium"
                                >
                                  View Details
                                </button>
                                <button
                                  onClick={() => {
                                    setModals(prev => ({ ...prev, showLowStockAlert: false }));
                                    setUi(prev => ({ ...prev, activeTab: 'lowstock' }));
                                    // Trigger the low stock report generation
                                    setTimeout(() => {
                                      const exportLowStockReport = () => { 
                                        if (lowStockMedications.length === 0) { 
                                          alert('No low stock medications to report'); 
                                          return; 
                                        } 
                                        setModals(prev => ({ ...prev, showLowStockReport: true })); 
                                      };
                                      exportLowStockReport();
                                    }, 100);
                                  }}
                                  className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium"
                                >
                                  Generate Order
                                </button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                    <div className="flex gap-3 justify-end">
                      <button
                        onClick={() => {
                          setModals(prev => ({ ...prev, showLowStockAlert: false }));
                          setUi(prev => ({ ...prev, activeTab: 'lowstock' }));
                        }}
                        className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-medium"
                      >
                        View All Low Stock
                      </button>
                      <button
                        onClick={() => setModals(prev => ({ ...prev, showLowStockAlert: false }))}
                        className="px-6 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors font-medium"
                      >
                        Dismiss
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* FEFO Override Modal */}
            {modals.showFefoOverride && fefoOverride.pending && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100]" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showFefoOverride: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">FEFO Override Required</h2>
                  {fefoOverride.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{fefoOverride.error}</div>)}
                  <div className="mb-4 p-4 bg-amber-50 border border-amber-300 rounded">
                    <p className="text-sm text-amber-900 font-semibold mb-2">Stock Rotation Alert</p>
                    <p className="text-sm text-amber-800 mb-2">You are attempting to remove stock from a later-expiring batch:</p>
                    <div className="text-sm text-amber-900 ml-3 mb-2">
                      <p><strong>Selected:</strong> {fefoOverride.pending.selectedBatch.brand}, expires {fefoOverride.pending.selectedExpiry}</p>
                    </div>
                    <p className="text-sm text-amber-800 mb-2">The earliest expiring batch is:</p>
                    <div className="text-sm text-amber-900 ml-3">
                      <p><strong>Earliest:</strong> {fefoOverride.pending.earliestBatch.brand}, expires {fefoOverride.pending.earliestExpiry}</p>
                    </div>
                  </div>
                  <p className="text-sm text-gray-600 mb-4">To override FEFO (First Expired, First Out) stock rotation policy, please enter your password and provide a valid reason (e.g., "Specific box size required for TTO").</p>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Password <span className="text-red-600">*</span></label>
                    <input type="password" value={fefoOverride.password} onChange={(e) => setFefoOverride(prev => ({ ...prev, password: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="Enter your password" />
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Reason for Override <span className="text-red-600">*</span></label>
                    <textarea value={fefoOverride.reason} onChange={(e) => setFefoOverride(prev => ({ ...prev, reason: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="e.g., Specific box size required for TTO" rows="3" />
                  </div>
                  <div className="flex gap-2">
                    <button onClick={handleFefoOverride} className="flex-1 bg-amber-600 text-white py-2 rounded-lg hover:bg-amber-700 transition-colors font-medium">Confirm Override</button>
                    <button onClick={() => { setModals(prev => ({ ...prev, showFefoOverride: false })); setFefoOverride({ pending: null, password: '', reason: '', error: '' }); }} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Remove Batch Modal */}
            {batchRemoval.batch && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Remove Batch</h2>
                  {batchRemoval.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{batchRemoval.error}</div>)}
                  <div className="mb-4 p-4 bg-red-50 border border-red-300 rounded">
                    <p className="text-sm text-red-800 mb-3 font-semibold">You are about to remove this batch from the system:</p>
                    <div className="text-sm space-y-1 bg-white p-3 rounded border border-red-200">
                      <p><span className="font-medium text-gray-700">Medication:</span> <span className="text-gray-900">{batchRemoval.batch.med.name}</span></p>
                      <p><span className="font-medium text-gray-700">Brand:</span> <span className="text-gray-900">{batchRemoval.batch.batch.brand}</span></p>
                      <p><span className="font-medium text-gray-700">Quantity:</span> <span className="text-gray-900">{batchRemoval.batch.batch.quantity} {batchRemoval.batch.med.unit}</span></p>
                      <p><span className="font-medium text-gray-700">Expiry:</span> <span className="text-gray-900">{formatExpiry(batchRemoval.batch.batch.expiryDate, 'long')}</span></p>
                    </div>
                  </div>
                  <p className="text-sm text-gray-600 mb-4">This action will permanently remove the batch from stock. This may indicate destruction, disposal, return to supplier, or other removal from circulation. Transaction history will be preserved for audit purposes.</p>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Reason for Removal <span className="text-red-600">*</span></label>
                    <select value={batchRemoval.reason} onChange={(e) => { setBatchRemoval(prev => ({ ...prev, reason: e.target.value })); if (e.target.value !== 'other') { setBatchRemoval(prev => ({ ...prev, customReason: '' })); } }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent mb-2">
                      <option value="">Select reason...</option>
                      {REMOVAL_REASONS.map(reason => (<option key={reason} value={reason}>{reason}</option>))}
                    </select>
                    {batchRemoval.reason === 'other' && (<textarea value={batchRemoval.customReason} onChange={(e) => setBatchRemoval(prev => ({ ...prev, customReason: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Please provide a detailed reason for removing this batch" rows="3" />)}
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Enter your password to confirm removal <span className="text-red-600">*</span></label>
                    <input type="password" value={batchRemoval.password} onChange={(e) => setBatchRemoval(prev => ({ ...prev, password: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Password" />
                  </div>
                  <div className="flex gap-2">
                    <button onClick={handleRemoveBatch} className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors font-medium">Remove Batch</button>
                    <button onClick={() => setBatchRemoval({ batch: null, password: '', reason: '', customReason: '', error: '' })} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Edit Minimum Level Modal */}
            {editMinLevel.editing && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Edit Minimum Stock Level</h2>
                  {editMinLevel.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{editMinLevel.error}</div>)}
                  <div className="mb-4 p-3 bg-gray-50 border border-gray-200 rounded">
                    <p className="text-sm font-medium text-gray-900 mb-1">{editMinLevel.editing.name}</p>
                    <p className="text-xs text-gray-600">Current Minimum Level: {formatMinLevelDisplay(editMinLevel.editing)}</p>
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Min stock (boxes) <span className="text-red-600">*</span></label>
                    <input type="number" value={editMinLevel.boxes} onChange={(e) => setEditMinLevel(prev => ({ ...prev, boxes: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter number of boxes" min="0" />
                  </div>
                  <p className="text-xs text-gray-500 mb-4">This will trigger alerts when stock falls below this level.</p>
                  <div className="flex gap-2">
                    <button onClick={handleUpdateMinLevel} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium">Update</button>
                    <button onClick={() => setEditMinLevel({ editing: null, newLevel: '', type: 'boxes', boxes: '', error: '' })} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Order Modal */}
            {orderForm.med && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-xl w-full flex flex-col" style={{maxHeight: '80vh'}}>
                  <div className="px-6 py-4 border-b border-gray-200 flex-shrink-0"><h2 className="text-lg font-bold text-gray-800">Place Order</h2></div>
                  <div className="overflow-y-auto px-6 py-4 flex-1">
                    <div className="mb-4 p-3 bg-gray-50 border border-gray-200 rounded">
                      <p className="text-sm font-medium text-gray-900 mb-1">{orderForm.med.name}</p>
                      <p className="text-xs text-gray-600">Current Stock: {formatStockDisplay(orderForm.med)}</p>
                      <p className="text-xs text-gray-600">Minimum Level: {formatMinLevelDisplay(orderForm.med)}</p>
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Order Quantity <span className="text-red-600">*</span></label>
                      <input type="number" value={orderForm.quantity} onChange={(e) => setOrderForm(prev => ({ ...prev, quantity: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder={`Enter quantity in ${orderForm.med.unit}`} min="1" />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Urgency</label>
                      <div className="flex gap-4">
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="urgency" 
                            value="routine" 
                            checked={orderForm.urgency === 'routine'} 
                            onClick={(e) => {
                              setOrderForm(prev => ({ ...prev, urgency: 'routine' }));
                            }} 
                            className="mr-2" 
                          />
                          Routine
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input 
                            type="radio" 
                            name="urgency" 
                            value="urgent" 
                            checked={orderForm.urgency === 'urgent'} 
                            onClick={(e) => {
                              setOrderForm(prev => ({ ...prev, urgency: 'urgent' }));
                            }} 
                            className="mr-2" 
                          />
                          Urgent
                        </label>
                      </div>
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Additional Notes (optional)</label>
                      <textarea value={orderForm.notes} onChange={(e) => setOrderForm(prev => ({ ...prev, notes: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Any additional information..." rows="3" />
                    </div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Pharmacist Email <span className="text-red-600">*</span></label>
                      <input type="email" value={orderForm.pharmacistEmail} onChange={(e) => setOrderForm(prev => ({ ...prev, pharmacistEmail: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="pharmacist@example.com" />
                    </div>
                    {orderForm.quantity && parseInt(orderForm.quantity) > 0 && (
                      <div className="mb-4 p-4 bg-slate-50 border border-slate-300 rounded-lg">
                        <h3 className="text-sm font-bold text-gray-800 mb-3">Email Preview</h3>
                        <div className="space-y-2 text-sm">
                          <div><span className="font-semibold text-gray-700">To:</span> <span className="text-gray-900">{orderForm.pharmacistEmail}</span></div>
                          <div><span className="font-semibold text-gray-700">Subject:</span> <span className="text-gray-900">{generateEmailContent().subject}</span></div>
                          <div className="border-t border-slate-300 pt-3 mt-3">
                            <pre className="whitespace-pre-wrap font-sans text-gray-800 text-xs leading-relaxed">{generateEmailContent().body}</pre>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0">
                    <div className="flex gap-2">
                      <button onClick={handleOpenOutlook} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium">Open in Outlook</button>
                      <button onClick={handleCopyToClipboard} className="flex-1 bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-700 transition-colors font-medium">Copy to Clipboard</button>
                      <button onClick={() => setOrderForm({ med: null, quantity: '', urgency: 'routine', notes: '', pharmacistEmail: 'Aasit.Badiani@Medicana.co.uk' })} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Low Stock Report Modal */}
            {modals.showLowStockReport && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showLowStockReport: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-2xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0"><h2 className="text-base sm:text-lg font-bold text-gray-800">Export Low Stock Report</h2></div>
                  <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded"><p className="text-sm text-amber-800">This will generate an email report for {lowStockMedications.length} medication{lowStockMedications.length !== 1 ? 's' : ''} below minimum stock level.</p></div>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Pharmacist Email <span className="text-red-600">*</span></label>
                      <input type="email" value={orderForm.pharmacistEmail} onChange={(e) => setOrderForm(prev => ({ ...prev, pharmacistEmail: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="pharmacist@example.com" />
                    </div>
                    <div className="mb-4 p-4 bg-slate-50 border border-slate-300 rounded-lg">
                      <h3 className="text-sm font-bold text-gray-800 mb-3">Email Preview</h3>
                      <div className="space-y-2 text-sm">
                        <div><span className="font-semibold text-gray-700">To:</span> <span className="text-gray-900">{orderForm.pharmacistEmail}</span></div>
                        <div><span className="font-semibold text-gray-700">Subject:</span> <span className="text-gray-900">{generateLowStockEmailContent().subject}</span></div>
                        <div className="border-t border-slate-300 pt-3 mt-3">
                          <pre className="whitespace-pre-wrap font-sans text-gray-800 text-xs leading-relaxed">{generateLowStockEmailContent().body}</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0">
                    <div className="flex gap-2">
                      <button onClick={handleOpenOutlookLowStock} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium">Open in Outlook</button>
                      <button onClick={handleCopyLowStockReport} className="flex-1 bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-700 transition-colors font-medium">Copy to Clipboard</button>
                      <button onClick={() => setModals(prev => ({ ...prev, showLowStockReport: false }))} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Weekly Intelligence Report Modal */}
            {modals.showIntelligenceReport && (() => {
              const reportData = generateWeeklyIntelligenceReport();
              const criticalMeds = reportData.medications.filter(m => m.recommendation.action === 'order' || m.recommendation.action === 'increase');
              const optimizeMeds = reportData.medications.filter(m => m.recommendation.action === 'decrease');
              const weeklyActiveMeds = reportData.medications.filter(m => m.analytics.totalUsed > 0);

              return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showIntelligenceReport: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                  <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full flex flex-col" style={{maxHeight: '90vh'}}>
                    <div className="px-6 py-4 border-b border-gray-200 flex-shrink-0 bg-gradient-to-r from-cyan-600 to-blue-600">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <BarChart className="w-6 h-6 text-white mr-3" />
                          <div>
                            <h2 className="text-xl font-bold text-white">Weekly Stock Intelligence Report</h2>
                            <p className="text-sm text-cyan-100">Advanced analytics and smart recommendations</p>
                          </div>
                        </div>
                        <button onClick={() => setModals(prev => ({ ...prev, showIntelligenceReport: false }))} className="text-white hover:text-cyan-200 text-2xl">&times;</button>
                      </div>
                    </div>
                    
                    <div className="overflow-y-auto px-6 py-4 flex-1 bg-gray-50">
                      {/* Executive Summary */}
                      <div className="grid grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-4 rounded-lg border-2 border-cyan-200 shadow-sm">
                          <div className="text-2xl font-bold text-cyan-600">{reportData.medications.length}</div>
                          <div className="text-sm text-gray-600">Active Medications</div>
                        </div>
                        <div className="bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm">
                          <div className="text-2xl font-bold text-red-600">{criticalMeds.length}</div>
                          <div className="text-sm text-gray-600">Requiring Attention</div>
                        </div>
                        <div className="bg-white p-4 rounded-lg border-2 border-blue-200 shadow-sm">
                          <div className="text-2xl font-bold text-blue-600">{weeklyActiveMeds.length}</div>
                          <div className="text-sm text-gray-600">Used This Week</div>
                        </div>
                        <div className="bg-white p-4 rounded-lg border-2 border-amber-200 shadow-sm">
                          <div className="text-2xl font-bold text-amber-600">{optimizeMeds.length}</div>
                          <div className="text-sm text-gray-600">Can Be Optimized</div>
                        </div>
                      </div>

                      {/* Critical Medications - Need Orders or Increases */}
                      {criticalMeds.length > 0 && (
                        <div className="mb-6">
                          <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                            <h3 className="text-lg font-bold text-red-800 mb-2 flex items-center">
                              <AlertTriangle className="w-5 h-5 mr-2" />
                              Critical: {criticalMeds.length} Medication{criticalMeds.length !== 1 ? 's' : ''} Requiring Immediate Action
                            </h3>
                          </div>
                          <div className="space-y-3">
                            {criticalMeds.map(med => {
                              // Use composite key: medication_name|strength_raw|type|location for stable identity
                              const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                              return (
                                <div key={stableKey} className="bg-white rounded-lg border-2 border-red-200 p-4 shadow-sm">
                                <div className="flex justify-between items-start mb-3">
                                  <div>
                                    <h4 className="font-bold text-gray-900 text-lg">{med.name}</h4>
                                    <div className="flex gap-4 mt-2 text-sm">
                                      <span className={`px-2 py-1 rounded ${getTotalBoxes(med) < med.minLevelBoxes ? 'bg-red-100 text-red-800 font-semibold' : 'bg-green-100 text-green-800'}`}>
                                        Current: {getTotalBoxes(med)} boxes
                                      </span>
                                      <span className="px-2 py-1 rounded bg-gray-100 text-gray-800">
                                        Min Level: {med.minLevelBoxes} boxes
                                      </span>
                                    </div>
                                  </div>
                                  <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                    med.recommendation.action === 'order' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'
                                  }`}>
                                    {med.recommendation.action === 'order' ? 'ORDER NOW' : 'INCREASE MIN LEVEL'}
                                  </span>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 mb-3">
                                  <div className="bg-blue-50 p-3 rounded">
                                    <div className="text-xs text-blue-600 font-semibold mb-1">WEEKLY USAGE</div>
                                    <div className="text-xl font-bold text-blue-900">{med.analytics.totalUsed} {med.unit}</div>
                                    {med.analytics.lowStockOccurrences > 0 && (
                                      <div className="text-xs text-red-600 mt-1">⚠ Went low {med.analytics.lowStockOccurrences}x this week</div>
                                    )}
                                  </div>
                                  <div className="bg-purple-50 p-3 rounded">
                                    <div className="text-xs text-purple-600 font-semibold mb-1">DEPARTMENT BREAKDOWN</div>
                                    {Object.entries(med.analytics.departmentUsage).length > 0 ? (
                                      <div className="space-y-1">
                                        {Object.entries(med.analytics.departmentUsage).slice(0, 2).map(([dept, data]) => (
                                          <div key={dept} className="text-xs text-purple-900">
                                            {dept}: {data.transferred} {med.unit}
                                          </div>
                                        ))}
                                      </div>
                                    ) : (
                                      <div className="text-xs text-gray-500">No transfers this week</div>
                                    )}
                                  </div>
                                </div>

                                <div className="bg-gradient-to-r from-cyan-50 to-blue-50 p-3 rounded border border-cyan-200">
                                  <div className="flex items-start">
                                    <TrendingUp className="w-5 h-5 text-cyan-600 mr-2 mt-0.5" />
                                    <div className="flex-1">
                                      <div className="font-semibold text-gray-900 mb-1">Smart Recommendation:</div>
                                      <div className="text-sm text-gray-700 mb-2">{med.recommendation.reason}</div>
                                      <div className="flex gap-3 text-sm">
                                        {med.recommendation.action === 'increase' && (
                                          <span className="font-semibold text-cyan-800">
                                            Suggest Min Level: {med.recommendation.suggestedMinLevel} {med.recommendation.suggestedMinLevel === 1 ? 'box' : 'boxes'} (+{med.recommendation.increasePercent}%)
                                          </span>
                                        )}
                                        <span className="font-semibold text-cyan-800">
                                          Order Quantity: {(() => {
                                            const boxes = med.recommendation.suggestedOrderQty;
                                            const itemsPerBox = med.standardItemsPerBox;
                                            if (itemsPerBox && boxes > 0) {
                                              return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${itemsPerBox} items per box`;
                                            }
                                            return `${boxes} ${boxes === 1 ? 'box' : 'boxes'}`;
                                          })()}
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Optimization Opportunities */}
                      {optimizeMeds.length > 0 && (
                        <div className="mb-6">
                          <div className="bg-amber-50 border-l-4 border-amber-500 p-4 mb-4">
                            <h3 className="text-lg font-bold text-amber-800 mb-2">
                              📊 Optimization: {optimizeMeds.length} Medication{optimizeMeds.length !== 1 ? 's' : ''} With Excess Stock
                            </h3>
                            <p className="text-sm text-amber-700">Consider reducing minimum levels to optimize inventory</p>
                          </div>
                          <div className="space-y-3">
                            {optimizeMeds.map(med => {
                              // Use composite key: medication_name|strength_raw|type|location for stable identity
                              const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                              return (
                                <div key={stableKey} className="bg-white rounded-lg border-2 border-amber-200 p-4 shadow-sm">
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <h4 className="font-bold text-gray-900">{med.name}</h4>
                                    <div className="flex gap-3 mt-1 text-sm">
                                      <span className="text-gray-600">Current: {getTotalBoxes(med)} boxes</span>
                                      <span className="text-gray-600">Min: {med.minLevelBoxes} boxes</span>
                                      <span className="text-blue-600 font-semibold">Weekly Usage: {med.analytics.totalUsed} {med.unit}</span>
                                    </div>
                                  </div>
                                  <span className="px-3 py-1 rounded-full text-sm font-semibold bg-amber-100 text-amber-800">
                                    REDUCE MIN LEVEL
                                  </span>
                                </div>
                                <div className="bg-amber-50 p-3 rounded mt-2">
                                  <div className="text-sm text-gray-700">{med.recommendation.reason}</div>
                                  <div className="text-sm font-semibold text-amber-800 mt-1">
                                    Suggested Min Level: {med.recommendation.suggestedMinLevel} {med.unit} (-{med.recommendation.decreasePercent}%)
                                  </div>
                                </div>
                              </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* All Active Medications This Week */}
                      {weeklyActiveMeds.length > 0 && (
                        <div className="mb-6">
                          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                            <h3 className="text-lg font-bold text-blue-800 mb-1">
                              📈 Weekly Activity Summary
                            </h3>
                            <p className="text-sm text-blue-700">Medications with usage this week</p>
                          </div>
                          <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <table className="w-full text-sm">
                              <thead className="bg-gray-50">
                                <tr>
                                  <th className="px-4 py-3 text-left font-semibold text-gray-700">Medication</th>
                                  <th className="px-4 py-3 text-center font-semibold text-gray-700">Used</th>
                                  <th className="px-4 py-3 text-center font-semibold text-gray-700">Current</th>
                                  <th className="px-4 py-3 text-center font-semibold text-gray-700">Low Events</th>
                                  <th className="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-200">
                                {weeklyActiveMeds.map(med => {
                                  // Use composite key: medication_name|strength_raw|type|location for stable identity
                                  const stableKey = `${med.medicationName || med.name}|${med.strengthRaw || ''}|${med.type || ''}|${med.location || ''}`;
                                  return (
                                  <tr key={stableKey} className="hover:bg-gray-50">
                                    <td className="px-4 py-3 font-medium text-gray-900">{med.name}</td>
                                    <td className="px-4 py-3 text-center text-blue-600 font-semibold">{med.analytics.totalUsed} {med.unit}</td>
                                    <td className="px-4 py-3 text-center">
                                      <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                        getTotalBoxes(med) < med.minLevelBoxes ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                                      }`}>
                                        {getTotalBoxes(med)} boxes
                                      </span>
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                      {med.analytics.lowStockOccurrences > 0 ? (
                                        <span className="text-red-600 font-semibold">{med.analytics.lowStockOccurrences}</span>
                                      ) : (
                                        <span className="text-gray-400">0</span>
                                      )}
                                    </td>
                                    <td className="px-4 py-3">
                                      <span className={`text-xs px-2 py-1 rounded ${
                                        med.recommendation.action === 'order' ? 'bg-red-100 text-red-700' :
                                        med.recommendation.action === 'increase' ? 'bg-orange-100 text-orange-700' :
                                        med.recommendation.action === 'decrease' ? 'bg-amber-100 text-amber-700' :
                                        'bg-gray-100 text-gray-700'
                                      }`}>
                                        {med.recommendation.action === 'order' ? 'Needs Order' :
                                         med.recommendation.action === 'increase' ? 'High Demand' :
                                         med.recommendation.action === 'decrease' ? 'Low Usage' :
                                         'Optimal'}
                                      </span>
                                    </td>
                                  </tr>
                                );
                                })}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      )}

                      {/* Report Footer */}
                      <div className="bg-white rounded-lg border border-gray-200 p-4 text-xs text-gray-600">
                        <div className="flex justify-between">
                          <div>
                            <strong>Report Generated:</strong> {new Date(reportData.generated).toLocaleString('en-GB')}
                          </div>
                          <div>
                            <strong>Generated by:</strong> {reportData.generatedBy}
                          </div>
                          <div>
                            <strong>Period:</strong> {new Date(reportData.weekStart).toLocaleDateString('en-GB')} - {new Date(reportData.weekEnd).toLocaleDateString('en-GB')}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                      <div className="flex gap-2">
                        <button onClick={() => {
                          // Generate and copy report
                          const reportText = `MEDICANA WINCHESTER - WEEKLY STOCK INTELLIGENCE REPORT\n\nGenerated: ${new Date().toLocaleString('en-GB')}\nBy: ${reportData.generatedBy}\n\n` +
                            `EXECUTIVE SUMMARY:\n` +
                            `- Active Medications: ${reportData.medications.length}\n` +
                            `- Requiring Attention: ${criticalMeds.length}\n` +
                            `- Used This Week: ${weeklyActiveMeds.length}\n` +
                            `- Can Be Optimized: ${optimizeMeds.length}\n\n` +
                            (criticalMeds.length > 0 ? `CRITICAL MEDICATIONS:\n${criticalMeds.map(m => 
                              `• ${m.name}: ${m.recommendation.reason} - Order ${m.recommendation.suggestedOrderQty} ${m.unit}`
                            ).join('\n')}\n\n` : '') +
                            (optimizeMeds.length > 0 ? `OPTIMIZATION OPPORTUNITIES:\n${optimizeMeds.map(m => 
                              `• ${m.name}: ${m.recommendation.reason}`
                            ).join('\n')}` : '');
                          
                          navigator.clipboard.writeText(reportText).then(() => {
                            alert('Intelligence report copied to clipboard!');
                          });
                        }} className="flex-1 bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-700 transition-colors font-medium">
                          Copy Summary
                        </button>
                        <button onClick={() => setModals(prev => ({ ...prev, showIntelligenceReport: false }))} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* New Medication Order Modal */}
            {modals.showNewMedicationOrder && (() => {
              const { subject, body } = generateNewMedicationEmailContent();
              const medicationName = `${newMedicationOrderForm.name} ${newMedicationOrderForm.strength}`;
              const unitName = getUnitName(newMedicationOrderForm.type);
              
              return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showNewMedicationOrder: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                  <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-2xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                    <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                      <h2 className="text-base sm:text-lg font-bold text-gray-800">New Medication Order Request</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto px-4 sm:px-6 py-3 sm:py-4">
                      <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 className="font-semibold text-blue-900 mb-2">Order Summary</h3>
                        <div className="space-y-1 text-sm">
                          <div><span className="font-medium text-blue-800">Medication:</span> <span className="text-gray-700">{medicationName}</span></div>
                          <div><span className="font-medium text-blue-800">Type:</span> <span className="text-gray-700">{newMedicationOrderForm.type}</span></div>
                          <div><span className="font-medium text-blue-800">Quantity:</span> <span className="text-gray-700">
                            {newMedicationOrderForm.type === 'IV Fluid Bag' && newMedicationOrderForm.bagSize ? (
                              <span>{newMedicationOrderForm.quantityNeeded} ({newMedicationOrderForm.bagSize} bags)</span>
                            ) : (
                              <span>{newMedicationOrderForm.quantityNeeded}</span>
                            )}
                          </span></div>
                          <div><span className="font-medium text-blue-800">Urgency:</span> <span className={`font-medium ${newMedicationOrderForm.urgency === 'emergency' ? 'text-red-600' : newMedicationOrderForm.urgency === 'urgent' ? 'text-orange-600' : 'text-green-600'} uppercase`}>{newMedicationOrderForm.urgency}</span></div>
                          {newMedicationOrderForm.notes && (
                            <div><span className="font-medium text-blue-800">Notes:</span> <span className="text-gray-700">{newMedicationOrderForm.notes}</span></div>
                          )}
                        </div>
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Email Preview:</label>
                        <div className="bg-gray-50 rounded border border-gray-300 p-4 font-mono text-xs whitespace-pre-wrap">
                          <div className="mb-2"><strong>To:</strong> {newMedicationOrderForm.pharmacistEmail}</div>
                          <div className="mb-2"><strong>Subject:</strong> {subject}</div>
                          <div className="border-t border-gray-300 pt-2 mt-2">{body}</div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0">
                      <div className="flex gap-2">
                        <button onClick={handleOpenOutlookNewMedication} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium">
                          Open in Outlook
                        </button>
                        <button onClick={handleCopyNewMedicationOrder} className="flex-1 bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-700 transition-colors font-medium">
                          Copy to Clipboard
                        </button>
                        <button onClick={() => setModals(prev => ({ ...prev, showNewMedicationOrder: false }))} className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* Fulfil Order Modal */}
            {modals.showFulfilOrder && fulfilOrderForm.med && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showFulfilOrder: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-2xl w-full flex flex-col m-2 sm:m-4" style={{maxHeight: '90vh'}}>
                  <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex-shrink-0">
                    <h2 className="text-base sm:text-lg font-bold text-gray-800">Fulfil Order</h2>
                    <p className="text-xs text-gray-600 mt-1">Add stock and mark order as fulfilled</p>
                  </div>

                  <div className="overflow-y-auto px-4 sm:px-6 py-3 sm:py-4 flex-1">
                    {fulfilOrderForm.error && (
                      <div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">
                        {fulfilOrderForm.error}
                      </div>
                    )}

                    {/* Order Details */}
                    <div className="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                      <h3 className="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                        <Download className="w-4 h-4" />
                        Pending Order Details
                      </h3>
                      <div className="space-y-1 text-sm">
                        <div><span className="font-medium text-purple-800">Medication:</span> <span className="text-gray-900">{fulfilOrderForm.med.name}</span></div>
                        <div><span className="font-medium text-purple-800">Quantity Ordered:</span> <span className="text-gray-900">{(() => {
                          const qty = fulfilOrderForm.order.quantity;
                          const itemsPerBox = fulfilOrderForm.med.standardItemsPerBox;
                          if (itemsPerBox && qty >= itemsPerBox) {
                            const boxes = Math.floor(qty / itemsPerBox);
                            const loose = qty % itemsPerBox;
                            if (loose > 0) {
                              return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${itemsPerBox} items per box + ${loose} ${pluralizeUnit(loose, fulfilOrderForm.med.unit)}`;
                            }
                            return `${boxes} ${boxes === 1 ? 'box' : 'boxes'} × ${itemsPerBox} items per box`;
                          }
                          return `${qty} ${pluralizeUnit(qty, fulfilOrderForm.med.unit)}`;
                        })()}</span></div>
                        <div><span className="font-medium text-purple-800">Urgency:</span> <span className={`font-medium ${fulfilOrderForm.order.urgency === 'urgent' ? 'text-red-600' : 'text-blue-600'} uppercase`}>{fulfilOrderForm.order.urgency}</span></div>
                        <div><span className="font-medium text-purple-800">Ordered:</span> <span className="text-gray-900">{new Date(fulfilOrderForm.order.orderedAt).toLocaleString('en-GB')}</span></div>
                        {fulfilOrderForm.order.notes && (
                          <div><span className="font-medium text-purple-800">Notes:</span> <span className="text-gray-900">{fulfilOrderForm.order.notes}</span></div>
                        )}
                      </div>
                    </div>

                    {/* Location Selector */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Delivery Location <span className="text-red-600">*</span>
                      </label>
                      <select
                        value={fulfilOrderForm.selectedLocationId}
                        onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, selectedLocationId: e.target.value, error: '' }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      >
                        <option value="">Select location...</option>
                        {(() => {
                          // Group locations by groupName
                          const grouped = {};
                          locations.forEach(loc => {
                            if (loc.groupName) {
                              if (!grouped[loc.groupName]) grouped[loc.groupName] = [];
                              grouped[loc.groupName].push(loc);
                            } else {
                              if (!grouped['_ungrouped']) grouped['_ungrouped'] = [];
                              grouped['_ungrouped'].push(loc);
                            }
                          });

                          const elements = [];
                          // Render grouped locations
                          Object.keys(grouped).forEach(groupName => {
                            if (groupName !== '_ungrouped') {
                              elements.push(
                                <optgroup key={groupName} label={groupName}>
                                  {grouped[groupName].map(location => {
                                    // Check if this medication exists at this location
                                    const medAtLocation = medications.find(m =>
                                      m.medicationName === fulfilOrderForm.med.medicationName &&
                                      m.strengthRaw === fulfilOrderForm.med.strengthRaw &&
                                      m.type === fulfilOrderForm.med.type &&
                                      m.location === location.displayName
                                    );
                                    return (
                                      <option key={location.id} value={location.id} style={medAtLocation ? { color: '#059669', fontWeight: '600' } : {}}>
                                        {location.displayName}{medAtLocation ? ' ✓' : ''}
                                      </option>
                                    );
                                  })}
                                </optgroup>
                              );
                            }
                          });
                          // Render ungrouped locations
                          if (grouped['_ungrouped']) {
                            grouped['_ungrouped'].forEach(location => {
                              const medAtLocation = medications.find(m =>
                                m.medicationName === fulfilOrderForm.med.medicationName &&
                                m.strengthRaw === fulfilOrderForm.med.strengthRaw &&
                                m.type === fulfilOrderForm.med.type &&
                                m.location === location.displayName
                              );
                              elements.push(
                                <option key={location.id} value={location.id} style={medAtLocation ? { color: '#059669', fontWeight: '600' } : {}}>
                                  {location.displayName}{medAtLocation ? ' ✓' : ''}
                                </option>
                              );
                            });
                          }
                          return elements;
                        })()}
                      </select>
                      <p className="text-xs text-gray-500 mt-1"><span className="text-green-600 font-semibold">Green locations ✓</span> already have this medication</p>
                    </div>

                    {/* Batch Selection Option */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Batch Option</label>
                      <div className="flex gap-4 mb-3">
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="fulfilBatchOption"
                            value="new"
                            checked={fulfilOrderForm.batchOption === 'new'}
                            onClick={(e) => {
                              setFulfilOrderForm(prev => ({ ...prev, batchOption: 'new', selectedBatchId: '', error: '' }));
                              handleFulfilOrderBatchSelect('');
                            }}
                            className="mr-2"
                          />
                          New Batch
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="fulfilBatchOption"
                            value="existing"
                            checked={fulfilOrderForm.batchOption === 'existing'}
                            onClick={(e) => {
                              setFulfilOrderForm(prev => ({ ...prev, batchOption: 'existing', selectedBatchId: '', error: '' }));
                            }}
                            className="mr-2"
                          />
                          Use Existing Batch Details
                        </label>
                      </div>
                    </div>

                    {/* Batch Dropdown for Existing Batches */}
                    {fulfilOrderForm.batchOption === 'existing' && (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Select Batch <span className="text-red-600">*</span></label>
                        <select
                          value={fulfilOrderForm.selectedBatchId}
                          onChange={(e) => handleFulfilOrderBatchSelect(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                          <option value="">Select batch...</option>
                          {(() => {
                            // Get all batches from all locations for this medication (including zero-stock batches)
                            const allBatches = [];
                            const seenBatchKeys = new Set();

                            medications.forEach(med => {
                              if (med.medicationName === fulfilOrderForm.med.medicationName &&
                                  med.strengthRaw === fulfilOrderForm.med.strengthRaw &&
                                  med.type === fulfilOrderForm.med.type) {
                                if (med.batches && Array.isArray(med.batches)) {
                                  med.batches.forEach(batch => {
                                    // Use a unique key to avoid duplicates
                                    const batchKey = `${batch.batchNumber || batch.batchCode}-${batch.brand}-${batch.expiryDate}`;
                                    if (!seenBatchKeys.has(batchKey)) {
                                      seenBatchKeys.add(batchKey);
                                      allBatches.push({ ...batch, location: med.location });
                                    }
                                  });
                                }
                              }
                            });

                            return allBatches
                              .sort((a, b) => new Date(a.expiryDate + '-01') - new Date(b.expiryDate + '-01'))
                              .map((batch, idx) => {
                                const formattedExpiry = formatExpiry(batch.expiryDate);
                                const batchLabel = batch.batchNumber || batch.batchCode || `Batch ${idx + 1}`;
                                const hasStock = batch.quantity > 0;
                                return (
                                  <option key={batch.id} value={batch.id}>
                                    {batchLabel} - {batch.brand} - Exp: {formattedExpiry} ({batch.location}){!hasStock ? ' [No Stock]' : ''}
                                  </option>
                                );
                              });
                          })()}
                        </select>
                        <p className="text-xs text-gray-500 mt-1">Select an existing batch to auto-fill brand, expiry date, and items per box</p>
                      </div>
                    )}

                    {/* Batch Details */}
                    {fulfilOrderForm.batchOption === 'new' && (
                      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                        <p className="text-sm font-medium text-blue-800 mb-2">Enter batch details for the delivery</p>
                      </div>
                    )}

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Brand <span className="text-red-600">*</span></label>
                      <input
                        type="text"
                        value={fulfilOrderForm.brand}
                        onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, brand: e.target.value, error: '' }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="e.g. Actavis, Accord, Teva"
                        readOnly={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Batch Number</label>
                      <input
                        type="text"
                        value={fulfilOrderForm.batchNumber}
                        onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, batchNumber: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="e.g. BN123456"
                        readOnly={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Expiry Date <span className="text-red-600">*</span></label>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Month</label>
                          <select
                            value={fulfilOrderForm.expiryMonth}
                            onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, expiryMonth: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            disabled={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                          >
                            <option value="">Select...</option>
                            {['January','February','March','April','May','June','July','August','September','October','November','December'].map((month, idx) => (
                              <option key={month} value={String(idx + 1).padStart(2, '0')}>{month}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">Year</label>
                          <div className="flex items-center gap-2">
                            <button
                              type="button"
                              onClick={() => {
                                if (fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId) return;
                                setFulfilOrderForm(prev => {
                                  const year = prev.expiryYear ? parseInt(prev.expiryYear) : new Date().getFullYear();
                                  return { ...prev, expiryYear: String(year - 1) };
                                });
                              }}
                              className="text-slate-700 hover:text-slate-900 text-2xl leading-none p-0 border-0 bg-transparent"
                              disabled={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                            >
                              ←
                            </button>
                            <input
                              type="number"
                              value={fulfilOrderForm.expiryYear}
                              onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, expiryYear: e.target.value, error: '' }))}
                              placeholder={String(new Date().getFullYear())}
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center"
                              min="2024"
                              max="2099"
                              readOnly={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                            />
                            <button
                              type="button"
                              onClick={() => {
                                if (fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId) return;
                                setFulfilOrderForm(prev => {
                                  const year = prev.expiryYear ? parseInt(prev.expiryYear) : new Date().getFullYear();
                                  return { ...prev, expiryYear: String(year + 1) };
                                });
                              }}
                              className="text-slate-700 hover:text-slate-900 text-2xl leading-none p-0 border-0 bg-transparent"
                              disabled={fulfilOrderForm.batchOption === 'existing' && fulfilOrderForm.selectedBatchId}
                            >
                              →
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Quantity Input */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Quantity Type</label>
                      <div className="flex gap-4 mb-3">
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="fulfilQuantityType"
                            value="boxes"
                            checked={fulfilOrderForm.quantityType === 'boxes'}
                            onClick={(e) => {
                              setFulfilOrderForm(prev => ({ ...prev, quantityType: 'boxes', boxQuantity: '', itemsPerBox: prev.itemsPerBox || (prev.med?.standardItemsPerBox || ''), error: '' }));
                            }}
                            className="mr-2"
                          />
                          Boxes
                        </label>
                        <label className="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="fulfilQuantityType"
                            value="individuals"
                            checked={fulfilOrderForm.quantityType === 'individuals'}
                            onClick={(e) => {
                              setFulfilOrderForm(prev => ({ ...prev, quantityType: 'individuals', individualQuantity: '', error: '' }));
                            }}
                            className="mr-2"
                          />
                          Individual {pluralizeUnit(1, fulfilOrderForm.med.unit)}
                        </label>
                      </div>
                    </div>

                    {fulfilOrderForm.quantityType === 'boxes' ? (
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Number of {fulfilOrderForm.boxQuantity && parseInt(fulfilOrderForm.boxQuantity) === 1 ? 'Box' : 'Boxes'} <span className="text-red-600">*</span>
                          </label>
                          <input
                            type="number"
                            value={fulfilOrderForm.boxQuantity}
                            onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, boxQuantity: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="e.g. 5"
                            min="1"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Items per Box <span className="text-red-600">*</span></label>
                          <input
                            type="number"
                            value={fulfilOrderForm.itemsPerBox}
                            onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, itemsPerBox: e.target.value, error: '' }))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="e.g. 100"
                            min="1"
                          />
                        </div>
                      </div>
                    ) : (
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Quantity ({fulfilOrderForm.med.unit}) <span className="text-red-600">*</span></label>
                        <input
                          type="number"
                          value={fulfilOrderForm.individualQuantity}
                          onChange={(e) => setFulfilOrderForm(prev => ({ ...prev, individualQuantity: e.target.value, error: '' }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="Enter quantity"
                          min="1"
                        />
                      </div>
                    )}
                  </div>

                  <div className="px-6 py-4 border-t border-gray-200 flex-shrink-0 bg-gray-50">
                    <div className="flex gap-2">
                      <button
                        onClick={handleFulfilOrder}
                        disabled={fulfilOrderForm.isSubmitting}
                        className={`flex-1 py-2 rounded-lg transition-colors font-medium ${
                          fulfilOrderForm.isSubmitting
                            ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                            : 'bg-purple-600 text-white hover:bg-purple-700'
                        }`}
                      >
                        {fulfilOrderForm.isSubmitting ? 'Fulfilling Order...' : 'Fulfil Order & Add Stock'}
                      </button>
                      <button
                        onClick={() => {
                          setFulfilOrderForm({
                            order: null,
                            med: null,
                            selectedLocationId: '',
                            batchOption: 'new',
                            selectedBatchId: '',
                            brand: '',
                            batchNumber: '',
                            expiryMonth: '',
                            expiryYear: '',
                            quantityType: 'boxes',
                            boxQuantity: '',
                            itemsPerBox: '',
                            individualQuantity: '',
                            error: '',
                            isSubmitting: false
                          });
                          setModals(prev => ({ ...prev, showFulfilOrder: false }));
                        }}
                        className="px-6 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Change Password Modal */}
            {modals.showChangePassword && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) e.currentTarget.dataset.mousedownOnOverlay = 'true'; }} onClick={(e) => { if (e.target === e.currentTarget && e.currentTarget.dataset.mousedownOnOverlay === 'true') { delete e.currentTarget.dataset.mousedownOnOverlay; setModals(prev => ({ ...prev, showChangePassword: false })); } else { delete e.currentTarget.dataset.mousedownOnOverlay; } }}>
                <div className="bg-white rounded-lg shadow-xl max-w-full sm:max-w-md w-full p-4 sm:p-6 m-2 sm:m-4">
                  <h2 className="text-lg sm:text-xl font-bold text-gray-800 mb-4">Change Password</h2>
                  {changePasswordForm.error && (<div className="mb-4 p-3 bg-red-50 border border-red-300 rounded text-sm text-red-700">{changePasswordForm.error}</div>)}
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Current Password <span className="text-red-600">*</span></label>
                    <input type="password" value={changePasswordForm.currentPassword} onChange={(e) => setChangePasswordForm(prev => ({ ...prev, currentPassword: e.target.value, error: '' }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter current password" />
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">New Password <span className="text-red-600">*</span></label>
                    <input type="password" value={changePasswordForm.newPassword} onChange={(e) => setChangePasswordForm(prev => ({ ...prev, newPassword: e.target.value, error: '' }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Enter new password" />
                    <p className="text-xs text-gray-500 mt-1">Password must be at least 8 characters long</p>
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Confirm New Password <span className="text-red-600">*</span></label>
                    <input type="password" value={changePasswordForm.confirmPassword} onChange={(e) => setChangePasswordForm(prev => ({ ...prev, confirmPassword: e.target.value, error: '' }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent" placeholder="Confirm new password" />
                  </div>
                  <div className="flex gap-2">
                    <button onClick={handleChangePassword} className="flex-1 bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition-colors font-medium">Change Password</button>
                    <button onClick={() => { setModals(prev => ({ ...prev, showChangePassword: false })); setChangePasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '', error: '' }); }} className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Session Timeout Warning Modal */}
            {sessionTimeout.showWarning && (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4" style={{zIndex: 10000}}>
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 border-2 border-amber-400">
                  <div className="text-center">
                    <div className="mb-4">
                      <AlertTriangle className="w-16 h-16 text-amber-500 mx-auto mb-3" />
                      <h2 className="text-xl font-bold text-gray-800 mb-2">Session Timeout Warning</h2>
                      <p className="text-gray-600 mb-4">
                        You have been inactive for a while. For security reasons, you will be automatically logged out in:
                      </p>
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-3 mb-4">
                        <div className="text-3xl font-bold text-red-600 mb-1">
                          {sessionTimeout.warningCountdown}
                        </div>
                        <div className="text-sm text-red-700">seconds remaining</div>
                      </div>
                      <p className="text-sm text-gray-500">
                        Click "Stay Logged In" to continue your session.
                      </p>
                    </div>
                    <div className="flex gap-3">
                      <button 
                        onClick={() => window.resetSessionActivity && window.resetSessionActivity()}
                        className="flex-1 bg-cyan-500 text-white py-3 px-4 rounded-lg hover:bg-cyan-600 transition-colors font-medium text-lg"
                      >
                        Stay Logged In
                      </button>
                      <button 
                        onClick={() => {
                          warningShownRef.current = false;
                          setAuth({ currentUser: '', password: '', isLoggedIn: false, error: '' });
                          setSessionTimeout({ showWarning: false, warningCountdown: 30, lastActivity: Date.now(), warningStartTime: null });
                        }}
                        className="flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors font-medium text-lg"
                      >
                        Log Out Now
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

        </div>
      );
    };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<MedicationStockApp />);
  </script>
  <script src="api.js"></script>
</body>
</html>